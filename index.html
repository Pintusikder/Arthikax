<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA Meta Tags for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ArthikaX - Digital Khata Book">
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://www.highperformanceformat.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https:; frame-src https://www.highperformanceformat.com https:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <title>ArthikaX - Best Free Khata Book App | Udhar Bahi Khata | Business Ledger 2025</title>
    <meta name="description"
        content="Best free offline Khata Book app for small business. Digital Udhar Bahi Khata, Credit Debit Ledger, Daily Cash Book, Money Manager without internet. Download Bahi Khata app now!">
    <meta name="keywords"
        content="khata book, udhar bahi khata, digital ledger app, credit debit book, cash book app, business khata, shop management app, money manager, daily expense tracker, bill book app, party ledger, hisab kitab app, business calculator, offline accounting, small business app, vyapar app, dukan ka hisab, len den hisab, rokad bahi, khata book online, best khata book app 2025">
    <meta name="theme-color" content="#F67B34">
    <meta name="robots" content="index, follow">
    <meta name="author" content="Arthixa">
    <meta name="language" content="English, Bengali, Hindi">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pintusikder.github.io/ArthikaX/">
    <meta property="og:title" content="ArthikaX - Free Digital Khata Book & Business Ledger App">
    <meta property="og:description"
        content="Manage your business udhar hisab easily. Best Khata Book app with credit debit tracking, bill book, and cash management. 100% offline.">
    <meta property="og:image" content="https://pintusikder.github.io/ArthikaX/logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://pintusikder.github.io/ArthikaX/">
    <meta property="twitter:title" content="ArthikaX - Free Khata Book & Udhar Bahi App">
    <meta property="twitter:description"
        content="Best digital bahi khata for small business. Track credit, debit, daily expenses without internet.">
    <meta property="twitter:image" content="https://pintusikder.github.io/ArthikaX/logo.png">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://pintusikder.github.io/ArthikaX/">

    <!-- Structured Data / Schema.org -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org  ",
        "@type": "SoftwareApplication",
        "name": "ArthikaX - Khata Book & Business Ledger",
        "description": "Best free offline Khata Book app for managing business udhar, credit debit, daily cash collection and party ledger without internet.",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Android, iOS, Windows, MacOS, Linux",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "15000"
        },
        "featureList": "Offline Khata Book, Udhar Bahi, Credit Debit Ledger, Daily Cash Book, Bill Management, PIN Lock, Data Encryption, Multi Profile, PDF Export, 50+ Currencies",
        "softwareVersion": "2.3.0",
        "fileSize": "150KB",
        "downloadUrl": "https://pintusikder.github.io/ArthikaX/",
        "screenshot": "https://pintusikder.github.io/ArthikaX/logo.png",
        "author": {
            "@type": "Organization",
            "name": "Arthixa",
            "url": "https://arthixa.com  "
        }
    }
    </script>

    <!-- FAQ Schema for Rich Snippets -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org  ",
        "@type": "FAQPage",
        "mainEntity": [{
            "@type": "Question",
            "name": "What is the best Khata Book app for small business?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "ArthikaX is the best free offline Khata Book app for small business. It works without internet, supports credit debit tracking, party ledger management, and generates PDF reports. It supports 50+ countries and currencies."
            }
        }, {
            "@type": "Question",
            "name": "How to maintain Udhar Bahi Khata digitally?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Use ArthikaX digital Khata Book app to maintain your Udhar Bahi electronically. Track customer credit (udhar), debit payments, daily cash collection, and generate instant reports. All data is encrypted and stored locally on your device."
            }
        }, {
            "@type": "Question",
            "name": "Is there any offline Khata Book app?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Yes, ArthikaX is a 100% offline Khata Book app that works without internet. Your business data remains secure on your device with PIN lock and AES-256 encryption. No data is sent to any server."
            }
        }]
    }
    </script>

    <!-- Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="./icon-512.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        /* Font Display Optimization */
        @font-face {
            font-family: 'Inter';
            font-display: swap;
        }

        @font-face {
            font-family: 'Roboto Mono';
            font-display: swap;
        }
    </style>

    <style>
        :root {
            /* Default Color - Will be overridden by JS */
            --primary: #F67B34;
            --primary-hover: #D65612;
            --accent: #FF8A3D;

            --secondary: #1C1C1C;
            --neutral: #6B6E63;
            --light-bg: #F5F5F5;
            --card-bg: #FFFFFF;
            --input-bg: #FFFFFF;
            --text-color: #1C1C1C;
            --border: #999999;

            --bg-income: #e8f5e9;
            --text-income: #2e7d32;
            --bg-expense: #ffebee;
            --text-expense: #c62828;
            --bg-balance: #e3f2fd;
            --text-balance: #1565c0;

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);

            --history-text: #444444;
            --transition: all 0.3s ease;
            color-scheme: light;
        }

        [data-theme="dark"] {
            --secondary: #F5F5F5;
            --light-bg: #121212;
            --card-bg: #1e1e1e;
            --input-bg: #2c2c2c;
            --text-color: #F5F5F5;
            --border: #444444;
            --history-text: #cccccc;
            --bg-income: #1b3320;
            --text-income: #66bb6a;
            --bg-expense: #331515;
            --text-expense: #ef5350;
            --bg-balance: #0f2847;
            --text-balance: #42a5f5;
            color-scheme: dark;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-bg);
            color: var(--secondary);
            font-size: 16px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--light-bg);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* HEADER */
        header {
            background-color: var(--primary);
            color: #fff;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-direction: column;
            align-items: flex-start;
        }

        .brand-top {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .brand h1 {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
            line-height: 1;
        }

        /* Active Profile Name in Header */
        .current-profile-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
            cursor: pointer;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            overflow: hidden;
            flex-shrink: 0;
        }

        .brand-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            padding: 2px;
        }

        .brand a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-size: 0.7rem;
            opacity: 0.9;
            cursor: pointer;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.5);
            white-space: nowrap;
        }

        .brand a:hover {
            opacity: 1;
            color: #fff;
        }

        .header-actions button {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.6rem;
            cursor: pointer;
            padding: 8px 12px;
            margin-left: 8px;
            transition: var(--transition);
            line-height: 1;
        }

        .header-actions button:hover {
            transform: scale(1.1);
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 1rem;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 0.8rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
            border: 1px solid var(--border);
        }

        .stat-card.income {
            background-color: var(--bg-income);
            border-color: var(--text-income);
        }

        .stat-card.expense {
            background-color: var(--bg-expense);
            border-color: var(--text-expense);
        }

        .stat-card.balance {
            background-color: var(--bg-balance);
            border-color: var(--text-balance);
        }

        .stat-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            opacity: 0.8;
            margin-bottom: 5px;
            color: var(--text-income);
        }

        .stat-val {
            font-size: 1rem;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
            color: var(--text-income);
            word-break: break-all;
            overflow-wrap: break-word;
            min-width: 0;
        }

        .stat-card.expense .stat-label,
        .stat-card.expense .stat-val {
            color: var(--text-expense);
        }

        .stat-card.balance .stat-label,
        .stat-card.balance .stat-val {
            color: var(--text-balance);
        }

        /* NAVIGATION */
        nav {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 0.5rem;
            display: flex;
            justify-content: center;
            gap: 5px;
            overflow-x: auto;
            flex-shrink: 0;
        }

        nav::-webkit-scrollbar {
            display: none;
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 0.5rem 0.8rem;
            font-weight: 600;
            color: var(--neutral);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            white-space: nowrap;
            font-size: 0.85rem;
        }

        .nav-btn.active {
            background-color: rgba(243, 108, 33, 0.2);
            color: var(--primary);
            font-weight: 700;
            border: 1px solid rgba(243, 108, 33, 0.3);
            box-shadow: 0 2px 4px rgba(243, 108, 33, 0.15);
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            position: relative;
            padding-bottom: 100px;
        }

        .view {
            display: none;
            animation: fadeIn 0.3s ease;
            padding-bottom: 20px;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --------------------------------------------------
           HOME PAGE
           -------------------------------------------------- */
        .home-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .home-hero {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff;
            padding: 2.5rem 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: 0 8px 20px rgba(243, 108, 33, 0.3);
            position: relative;
            overflow: hidden;
        }

        .home-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 60%);
            z-index: 0;
        }

        .home-logo-big {
            width: 80px;
            height: 80px;
            background: #fff;
            border-radius: 16px;
            padding: 10px;
            margin: 0 auto 1rem auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }

        .home-logo-big img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .home-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
            letter-spacing: -0.5px;
        }

        .home-subtitle {
            font-size: 1.1rem;
            font-weight: 500;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            margin-bottom: 1.5rem;
        }

        .home-desc {
            font-size: 0.95rem;
            line-height: 1.6;
            opacity: 0.9;
            position: relative;
            z-index: 1;
            max-width: 80%;
            margin: 0 auto;
        }

        .features-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .feature-poster {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 1.5rem 1rem;
            border-radius: var(--radius-md);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
        }

        .feature-poster:active {
            transform: scale(0.98);
        }

        .feature-icon-lg {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .feature-poster h4 {
            color: var(--text-color);
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .feature-poster p {
            color: var(--neutral);
            font-size: 0.75rem;
            line-height: 1.3;
            margin: 0;
        }

        .home-credits {
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .home-credits h3 {
            color: var(--primary);
            font-size: 1rem;
            margin-bottom: 0.2rem;
        }

        .home-credits p {
            color: var(--neutral);
            font-size: 0.75rem;
            margin: 0;
        }

        .home-credits a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        /* --------------------------------------------------
           OTHER STYLES
           -------------------------------------------------- */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--neutral);
            font-weight: 500;
            word-break: break-word;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-family: inherit;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(243, 108, 33, 0.2);
        }

        .form-control.error {
            border-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }

        .form-control:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--light-bg);
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            color: var(--primary);
            opacity: 1;
        }

        .radio-group,
        .checkbox-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 10px;
            background: var(--light-bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .radio-group label,
        .checkbox-wrapper label {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkbox-wrapper label {
            width: auto !important;
        }

        .checkbox-wrapper {
            cursor: pointer;
        }

        .denom-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .denom-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 0.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .denom-label {
            font-weight: 600;
            color: var(--neutral);
            font-size: 0.85rem;
        }

        .denom-input {
            width: 100%;
            padding: 4px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: 'Roboto Mono', monospace;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .denom-subtotal {
            font-size: 0.7rem;
            color: var(--primary);
            font-weight: 500;
        }

        .total-display {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .total-label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .total-amount {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0.5rem 0;
            font-family: 'Roboto Mono', monospace;
            word-break: break-all;
        }

        .total-words {
            font-style: italic;
            opacity: 0.9;
            font-size: 0.9rem;
            word-break: break-word;
        }

        .btn {
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            transition: var(--transition);
            width: 100%;
            white-space: nowrap;
        }

        .btn-primary {
            background-color: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--neutral);
            color: #fff;
        }

        .btn-success {
            background-color: #2e7d32;
            color: #fff;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--neutral);
            color: var(--neutral);
        }

        .btn-danger {
            background-color: #dc3545;
            color: #fff;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            width: auto;
        }

        /* TAGS STYLES */
        .tags-input-group {
            display: flex;
            gap: 8px;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .tag-chip {
            background-color: var(--bg-balance);
            color: var(--text-balance);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--text-balance);
        }

        .tag-close {
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            color: var(--text-color);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--neutral);
        }

        .history-list {
            list-style: none;
        }

        .history-item {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
        }

        .h-left {
            flex: 1;
            padding-right: 15px;
            min-width: 0;
        }

        .h-name {
            font-weight: 700;
            font-size: 1.05rem;
            color: var(--secondary);
            margin-bottom: 4px;
            display: block;
            word-break: break-word;
            line-height: 1.3;
        }

        .h-tags {
            margin-bottom: 4px;
            font-size: 0.75rem;
            color: var(--primary);
        }

        .h-details {
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-size: 0.8rem;
            color: var(--history-text);
            font-weight: 500;
        }

        .h-detail-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .h-detail-row span {
            line-height: 1.2;
            word-break: break-word;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-right: 5px;
            white-space: nowrap;
        }

        .badge.due {
            background-color: #ffebee;
            color: #c62828;
            /* Red for Due */
        }

        .badge.expense {
            background-color: #fff3e0;
            color: #ef6c00;
            /* Orange for Payable */
        }

        .badge.receivable {
            background-color: #e8f5e9;
            color: #2e7d32;
            /* Green for Receivable */
        }

        [data-theme="dark"] .badge.due {
            background-color: #5c2b2b;
            color: #ef9a9a;
            /* Red Light */
        }

        [data-theme="dark"] .badge.expense {
            background-color: #5d4037;
            color: #ffcc80;
            /* Orange Light */
        }

        .h-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: flex-start;
            min-width: 80px;
            margin-left: 10px;
        }

        .h-amount {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 2px;
            white-space: nowrap;
        }

        .amount-income {
            color: #2e7d32;
            /* Green */
        }

        .amount-expense {
            color: #ef6c00;
            /* Orange */
        }

        .h-words {
            font-size: 0.7rem;
            font-style: italic;
            color: var(--history-text);
            text-align: right;
            margin-bottom: 4px;
            line-height: 1.1;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .menu-container {
            position: relative;
            display: inline-block;
            margin-top: auto;
            flex-shrink: 0;
        }

        .btn-menu {
            background: none;
            border: none;
            color: var(--history-text);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .btn-menu:hover {
            color: var(--primary);
        }

        .item-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--card-bg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-sm);
            z-index: 200;
            min-width: 140px;
            overflow: hidden;
            pointer-events: none;
        }

        .item-menu.show {
            display: block;
            pointer-events: auto;
        }

        .menu-opt {
            display: block;
            width: 100%;
            padding: 10px 15px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-color);
            transition: background 0.2s;
            white-space: nowrap;
        }

        .menu-opt:hover {
            background-color: var(--light-bg);
        }

        .menu-opt.delete {
            color: #dc3545;
            border-top: 1px solid var(--border);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 4px;
            font-size: 0.9rem;
        }

        .detail-row span:last-child {
            font-weight: 600;
            font-family: 'Roboto Mono', monospace;
            word-break: break-word;
            text-align: right;
        }

        .denom-breakdown {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 10px;
            background: var(--light-bg);
        }

        .denom-br-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.85rem;
        }

        [data-theme="dark"] .denom-br-row {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--secondary);
            color: var(--card-bg);
            text-align: center;
            border-radius: var(--radius-md);
            padding: 16px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: var(--shadow-md);
            width: max-content;
            max-width: 90%;
        }

        [data-theme="dark"] #toast {
            background-color: #F5F5F5;
            color: #121212;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        /* PWA INSTALL BANNER */
        #pwa-install-banner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--primary);
            color: #fff;
            padding: 1rem;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .pwa-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .pwa-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .pwa-desc {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .btn-install {
            background-color: #fff;
            color: var(--primary);
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-close-pwa {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .filter-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-tabs {
            display: flex;
            background: var(--light-bg);
            padding: 4px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .filter-tabs input[type="radio"] {
            display: none;
        }

        .filter-tabs label {
            flex: 1;
            text-align: center;
            padding: 8px 5px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--neutral);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .filter-tabs input[type="radio"]:checked+label {
            background-color: var(--card-bg);
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .filter-input-wrapper {
            width: 100%;
        }

        .filter-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--input-bg);
            color: var(--text-color);
            font-family: inherit;
        }

        .custom-select-wrapper {
            position: relative;
            user-select: none;
            width: 100%;
        }

        .custom-select {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .custom-select__trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 400;
            color: var(--text-color);
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .custom-select__trigger:hover {
            border-color: var(--primary);
        }

        .custom-select.open .custom-select__trigger {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(243, 108, 33, 0.2);
        }

        .custom-select__options {
            position: absolute;
            display: block;
            top: 100%;
            left: 0;
            right: 0;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            box-shadow: var(--shadow-md);
            transition: all 0.3s;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            z-index: 50;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 5px;
        }

        .custom-select.open .custom-select__options {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
        }

        .custom-select__search {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            background: var(--card-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .custom-select__search input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .custom-option {
            position: relative;
            display: block;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            word-break: break-word;
        }

        [data-theme="dark"] .custom-option {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .custom-option:hover {
            background-color: rgba(243, 108, 33, 0.1);
            color: var(--primary);
        }

        .custom-option.selected {
            background-color: var(--primary);
            color: #fff;
        }

        .arrow {
            position: relative;
            height: 10px;
            width: 10px;
        }

        .arrow::before,
        .arrow::after {
            content: "";
            position: absolute;
            bottom: 0px;
            width: 0.15rem;
            height: 100%;
            transition: all 0.3s;
        }

        .arrow::before {
            left: -3px;
            transform: rotate(-45deg);
            background-color: var(--neutral);
        }

        .arrow::after {
            left: 3px;
            transform: rotate(45deg);
            background-color: var(--neutral);
        }

        .open .arrow::before {
            left: -3px;
            transform: rotate(45deg);
        }

        .open .arrow::after {
            left: 3px;
            transform: rotate(-45deg);
        }

        .search-hint {
            font-size: 0.75rem;
            color: var(--neutral);
            margin-top: 5px;
            font-style: italic;
        }

        /* Profile List Styles */
        .profile-list {
            list-style: none;
            margin-top: 10px;
        }

        .profile-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            background: var(--card-bg);
        }

        .profile-item.active {
            border-color: var(--primary);
            background-color: rgba(243, 108, 33, 0.05);
        }

        .profile-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .profile-actions {
            display: flex;
            gap: 5px;
        }

        .profile-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: 600;
        }

        .btn-switch {
            background-color: var(--primary);
            color: #fff;
        }

        .btn-delete {
            background-color: #dc3545;
            color: #fff;
        }

        .credits-container {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 0.5rem;
        }

        .credits-container h3 {
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }

        .credits-container p {
            font-size: 0.9rem;
            color: var(--neutral);
            margin: 0.2rem 0;
        }

        .credits-container a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        /* =========================================
           PROFESSIONAL PDF & INVOICE STYLES
           ========================================= */
        #print-area {
            display: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #print-area,
            #print-area * {
                visibility: visible;
            }

            /* Enable Page Counter */
            body {
                counter-increment: page;
            }

            #print-area {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                color: #000;
                font-size: 12px;
                font-family: 'Helvetica', sans-serif;
                /* Reducing padding to maximize content space */
                padding-bottom: 30px;
            }

            /* PAGE SETTINGS */
            @page {
                size: A4;
                margin: 10mm 5mm 10mm 5mm;
                /* Top/Bottom 10mm, Left/Right 5mm to fit more data */
            }

            /* --- REPORT STYLES --- */
            .pdf-header {
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                margin-bottom: 20px;
                border-bottom: 2px solid #F36C21;
                padding-bottom: 15px;
            }

            .pdf-logo-area {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .pdf-logo {
                width: 50px;
                height: 50px;
                object-fit: contain;
            }

            .pdf-title-block h1 {
                font-size: 24px;
                margin: 0;
                color: #F36C21;
                font-weight: 800;
            }

            .pdf-title-block h2 {
                font-size: 18px;
                margin: 5px 0 0 0;
                font-weight: 600;
                color: #333;
            }

            .pdf-meta {
                text-align: right;
                font-size: 11px;
                line-height: 1.5;
                color: #555;
            }

            .pdf-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
                font-size: 11px;
            }

            .pdf-table th {
                background-color: #f4f4f4;
                color: #333;
                font-weight: 700;
                padding: 8px 5px;
                text-align: left;
                border-bottom: 2px solid #333;
                font-size: 10px;
            }

            .pdf-table td {
                padding: 6px 5px;
                border-bottom: 1px solid #ddd;
                vertical-align: top;
            }

            .pdf-table tr:nth-child(even) {
                background-color: #f9f9f9;
            }

            .row-green {
                background-color: #e8f5e9 !important;
                color: #1b5e20;
            }

            .row-orange {
                background-color: #fff3e0 !important;
                color: #e65100;
            }

            .row-red {
                background-color: #ffebee !important;
                color: #b71c1c;
            }

            .pdf-summary-box {
                margin-top: 20px;
                padding: 15px;
                border: 2px solid #333;
                background-color: #fafafa;
                margin-bottom: 35px;
                /* Reduced margin to fit new footer */
            }

            .pdf-summary-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
                padding-bottom: 5px;
                border-bottom: 1px dashed #ccc;
            }

            .pdf-summary-row:last-child {
                border-bottom: none;
                font-weight: bold;
                font-size: 13px;
                margin-top: 10px;
                padding-top: 10px;
                border-top: 2px solid #333;
            }

            .pdf-summary-label {
                font-weight: 600;
            }

            .pdf-summary-val {
                font-family: 'Courier New', monospace;
                font-weight: 600;
            }

            /* UPDATED FOOTER: Left-Center-Right */
            .pdf-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 30px;
                /* Ensure height for absolute positioning children */
                display: flex;
                justify-content: center;
                /* Center URL text */
                align-items: center;
                font-size: 9px;
                color: #777;
                border-top: 1px solid #ddd;
                background: #fff;
                z-index: 9999;
                line-height: 1.2;
            }

            /* Left Element */
            .pdf-footer::before {
                content: "Generated by ArthikaX";
                position: absolute;
                left: 10px;
            }

            /* Right Element */
            .pdf-footer::after {
                content: "Page No" counter(page);
                position: absolute;
                right: 10px;
            }

            /* --- PROFESSIONAL INVOICE STYLES --- */
            .invoice-layout {
                max-width: 800px;
                margin: 0 auto;
                padding: 40px;
                font-family: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
                color: #333;
                border: none;
                /* Clean print look */
            }

            /* Professional Header */
            .inv-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                border-bottom: 3px solid #F36C21;
                /* Brand Accent Line */
                padding-bottom: 20px;
                margin-bottom: 30px;
            }

            .inv-brand-info h1 {
                font-size: 28px;
                margin: 0 0 5px 0;
                color: #F36C21;
                font-weight: 800;
                letter-spacing: -0.5px;
            }

            .inv-brand-info p {
                margin: 0;
                font-size: 12px;
                color: #666;
            }

            .inv-title-section {
                text-align: right;
            }

            .inv-title {
                font-size: 42px;
                font-weight: 800;
                color: #333;
                text-transform: uppercase;
                line-height: 1;
                margin: 0 0 5px 0;
            }

            .inv-meta-grid {
                margin-top: 15px;
                display: grid;
                grid-template-columns: auto 1fr;
                gap: 5px 15px;
                font-size: 13px;
                align-items: center;
            }

            .inv-meta-label {
                font-weight: 600;
                color: #666;
                text-align: right;
            }

            .inv-meta-value {
                font-weight: 600;
                color: #333;
            }

            /* Bill To Box */
            .inv-bill-to {
                margin-bottom: 30px;
                background-color: #f9f9f9;
                padding: 20px;
                border-radius: 4px;
                border-left: 4px solid #F36C21;
            }

            .inv-bill-label {
                font-size: 11px;
                color: #888;
                text-transform: uppercase;
                font-weight: 700;
                margin-bottom: 8px;
                letter-spacing: 1px;
            }

            .inv-cust-name {
                font-size: 20px;
                font-weight: 700;
                color: #333;
                margin-bottom: 5px;
            }

            .inv-cust-details {
                font-size: 14px;
                color: #555;
                line-height: 1.4;
            }

            /* Professional Table */
            .inv-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }

            .inv-table th {
                background-color: #333;
                /* Dark Header */
                color: #fff;
                padding: 12px 15px;
                text-align: left;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .inv-table td {
                padding: 12px 15px;
                border-bottom: 1px solid #eee;
                font-size: 14px;
                color: #444;
                vertical-align: middle;
            }

            /* Zebra Striping */
            .inv-table tr:nth-child(even) {
                background-color: #fcfcfc;
            }

            .inv-table tr:hover {
                background-color: #f1f1f1;
            }

            /* Interactive feel if viewed on screen */

            .inv-table .text-right {
                text-align: right;
                font-weight: 600;
                font-size: 15px;
            }

            .inv-total-row td {
                background-color: #f4f4f4 !important;
                font-weight: 700;
                font-size: 16px;
                color: #000;
                border-top: 2px solid #ddd;
            }

            .inv-total-row .text-right {
                color: #F36C21;
                font-size: 20px;
            }

            /* Words Section */
            .inv-words {
                margin: 30px 0;
                padding: 20px;
                background: #fff;
                border: 1px dashed #ccc;
                font-style: italic;
                color: #666;
                font-size: 14px;
                border-radius: 4px;
            }

            /* Signature Area */
            .inv-sign {
                margin-top: 60px;
                display: flex;
                justify-content: flex-end;
            }

            .inv-sign-line {
                border-top: 2px solid #333;
                width: 220px;
                text-align: center;
                font-size: 13px;
                padding-top: 10px;
                color: #666;
                text-transform: uppercase;
                font-weight: 600;
            }

            /* Invoice Footer (Fixed) */
            .inv-footer-note {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                margin-top: 0;
                text-align: center;
                font-size: 10px;
                color: #999;
                border-top: 1px solid #eee;
                padding: 10px 0;
                background: #fff;
                z-index: 9999;
            }

            /* Add page number using CSS counter */
            .inv-footer-note::after {
                content: " - Page No " counter(page);
            }

            /* Print Helper Classes */
            .text-right {
                text-align: right;
            }

            .text-center {
                text-align: center;
            }

            .font-bold {
                font-weight: 700;
            }

            .no-data {
                text-align: center;
                padding: 40px;
                font-size: 14px;
                font-style: italic;
                color: #777;
            }
        }

        /* User Guide Mobile Responsive */
        @media (max-width: 480px) {
            #userGuideModal .modal-content {
                max-width: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
                max-height: 100vh !important;
            }

            #userGuideModal .modal-content>div {
                max-height: 100vh !important;
            }

            #userGuideModal .modal-content>div:nth-child(2) {
                padding: 1rem !important;
            }
        }

        @media (max-width: 768px) {
            #userGuideModal .modal-content {
                max-width: 95% !important;
            }
        }

        /* Safe area for notched phones */
        @supports (padding-top: env(safe-area-inset-top)) {
            #userGuideModal .modal-content {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* =========================================
           RESPONSIVE DESIGN - TABLET
           ========================================= */
        @media (max-width: 768px) {

            /* Header adjustments */
            header {
                padding: 0.7rem 0.9rem;
            }

            .brand h1 {
                font-size: 1.15rem;
            }

            .current-profile-badge {
                font-size: 0.7rem;
                padding: 2px 6px;
            }

            .brand-icon {
                width: 36px;
                height: 36px;
            }

            .header-actions button {
                font-size: 1.4rem;
                padding: 6px 10px;
            }

            /* Dashboard - 3 columns on tablet */
            .dashboard-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                padding: 0.8rem;
            }

            .stat-card {
                padding: 0.7rem;
                min-height: 75px;
            }

            .stat-label {
                font-size: 0.65rem;
            }

            .stat-val {
                font-size: 0.95rem;
            }

            /* Navigation */
            nav {
                padding: 0.4rem;
                gap: 4px;
            }

            .nav-btn {
                font-size: 0.8rem;
                padding: 0.45rem 0.7rem;
            }

            /* Main content */
            main {
                padding: 0.9rem;
                padding-bottom: 90px;
            }

            /* Home page */
            .home-hero {
                padding: 2rem 1.2rem;
            }

            .home-title {
                font-size: 1.8rem;
            }

            .home-subtitle {
                font-size: 1rem;
            }

            .home-desc {
                font-size: 0.9rem;
                max-width: 85%;
            }

            .home-logo-big {
                width: 70px;
                height: 70px;
            }

            /* Features grid - 2 columns on tablet */
            .features-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.9rem;
            }

            .feature-poster {
                padding: 1.2rem 0.8rem;
            }

            .feature-icon-lg {
                font-size: 2.2rem;
            }

            .feature-poster h4 {
                font-size: 0.85rem;
            }

            .feature-poster p {
                font-size: 0.72rem;
            }

            /* Cards and forms */
            .card {
                padding: 1rem;
                margin-bottom: 0.9rem;
            }

            .form-control {
                padding: 0.7rem;
                font-size: 0.95rem;
            }

            /* Modal */
            .modal-content {
                padding: 1.5rem;
                max-width: 95%;
            }

            /* Total display */
            .total-display {
                padding: 1.2rem;
            }

            .total-amount {
                font-size: 2rem;
            }

            .total-words {
                font-size: 0.85rem;
            }

            /* Denomination grid */
            .denom-grid {
                grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
                gap: 0.7rem;
            }

            /* History items */
            .h-name {
                font-size: 1rem;
            }

            .h-amount {
                font-size: 1.05rem;
            }

            .h-details {
                font-size: 0.78rem;
            }

            /* Buttons */
            .btn {
                padding: 0.75rem 1.3rem;
                font-size: 0.95rem;
            }

            .btn-sm {
                padding: 0.38rem 0.75rem;
                font-size: 0.78rem;
            }
        }

        /* =========================================
           RESPONSIVE DESIGN - MOBILE
           ========================================= */
        @media (max-width: 480px) {

            /* Header - More compact */
            header {
                padding: 0.6rem 0.8rem;
            }

            .brand h1 {
                font-size: 1rem;
            }

            .current-profile-badge {
                font-size: 0.65rem;
                padding: 1px 5px;
            }

            .brand a {
                font-size: 0.65rem;
            }

            .brand-icon {
                width: 32px;
                height: 32px;
            }

            .header-actions button {
                font-size: 1.3rem;
                padding: 5px 8px;
                margin-left: 5px;
            }

            /* Dashboard - Stack vertically on very small screens */
            .dashboard-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
                padding: 0.7rem;
            }

            .stat-card {
                padding: 0.6rem 0.4rem;
                min-height: 70px;
            }

            .stat-label {
                font-size: 0.6rem;
                margin-bottom: 3px;
            }

            .stat-val {
                font-size: 0.85rem;
                line-height: 1.2;
            }

            /* Navigation - Smaller text */
            nav {
                padding: 0.35rem;
                gap: 3px;
            }

            .nav-btn {
                font-size: 0.75rem;
                padding: 0.4rem 0.6rem;
            }

            /* Main content */
            main {
                padding: 0.8rem;
                padding-bottom: 85px;
            }

            /* Home page */
            .home-hero {
                padding: 1.8rem 1rem;
            }

            .home-title {
                font-size: 1.5rem;
            }

            .home-subtitle {
                font-size: 0.95rem;
            }

            .home-desc {
                font-size: 0.85rem;
                max-width: 95%;
                line-height: 1.5;
            }

            .home-logo-big {
                width: 60px;
                height: 60px;
                margin-bottom: 0.8rem;
            }

            /* Features grid - Stack to single column on mobile */
            .features-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }

            .feature-poster {
                padding: 1rem 0.8rem;
            }

            .feature-icon-lg {
                font-size: 2rem;
            }

            .feature-poster h4 {
                font-size: 0.82rem;
            }

            .feature-poster p {
                font-size: 0.7rem;
            }

            /* Cards and forms */
            .card {
                padding: 0.9rem;
                margin-bottom: 0.8rem;
            }

            .form-group {
                margin-bottom: 0.9rem;
            }

            .form-group label {
                font-size: 0.82rem;
                margin-bottom: 0.4rem;
            }

            .form-control {
                padding: 0.65rem;
                font-size: 0.9rem;
            }

            /* Radio and checkbox groups */
            .radio-group,
            .checkbox-wrapper {
                padding: 8px;
                gap: 10px;
            }

            .radio-group label,
            .checkbox-wrapper label {
                font-size: 0.85rem;
            }

            /* Modal - Full screen on mobile */
            .modal {
                padding: 0.5rem;
            }

            .modal-content {
                padding: 1.2rem;
                max-width: 100%;
                max-height: 95vh;
            }

            .modal-close {
                font-size: 1.3rem;
                top: 0.8rem;
                right: 0.8rem;
            }

            /* Total display */
            .total-display {
                padding: 1rem;
                margin-bottom: 1.2rem;
            }

            .total-label {
                font-size: 0.85rem;
            }

            .total-amount {
                font-size: 1.8rem;
                margin: 0.4rem 0;
            }

            .total-words {
                font-size: 0.8rem;
            }

            /* Denomination grid - Smaller on mobile */
            .denom-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 0.6rem;
                margin-top: 0.8rem;
            }

            .denom-item {
                padding: 0.4rem;
            }

            .denom-label {
                font-size: 0.8rem;
            }

            .denom-input {
                padding: 3px;
                font-size: 0.9rem;
            }

            .denom-subtotal {
                font-size: 0.65rem;
            }

            /* History items */
            .history-item {
                padding: 0.8rem;
                flex-direction: column;
                align-items: flex-start;
            }

            .h-left {
                width: 100%;
                padding-right: 0;
                margin-bottom: 0.5rem;
            }

            .h-name {
                font-size: 0.95rem;
            }

            .h-tags {
                font-size: 0.7rem;
            }

            .h-details {
                font-size: 0.75rem;
            }

            .h-right {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                margin-left: 0;
                min-width: unset;
            }

            .h-amount {
                font-size: 1rem;
            }

            .h-words {
                font-size: 0.68rem;
                text-align: left;
                max-width: 60%;
            }

            .menu-container {
                margin-top: 0;
            }

            /* Buttons */
            .btn {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
                gap: 6px;
            }

            .btn-sm {
                padding: 0.35rem 0.7rem;
                font-size: 0.75rem;
            }

            /* Filter tabs */
            .filter-tabs label {
                font-size: 0.75rem;
                padding: 7px 4px;
            }

            .filter-input {
                padding: 0.65rem;
                font-size: 0.9rem;
            }

            /* Custom select */
            .custom-select__trigger {
                padding: 0.65rem;
                font-size: 0.9rem;
            }

            .custom-option {
                padding: 0.65rem 0.9rem;
                font-size: 0.85rem;
            }

            /* PWA Install Banner */
            #pwa-install-banner {
                padding: 0.8rem;
                gap: 0.8rem;
                flex-wrap: wrap;
            }

            .pwa-title {
                font-size: 0.95rem;
            }

            .pwa-desc {
                font-size: 0.75rem;
            }

            .btn-install {
                padding: 7px 14px;
                font-size: 0.85rem;
            }

            /* Toast */
            #toast {
                min-width: 200px;
                padding: 14px;
                font-size: 0.9rem;
                bottom: 25px;
            }

            /* Credits */
            .home-credits,
            .credits-container {
                padding: 0.8rem;
                margin-top: 1.2rem;
            }

            .home-credits h3,
            .credits-container h3 {
                font-size: 0.95rem;
            }

            .home-credits p,
            .credits-container p {
                font-size: 0.7rem;
            }

            /* Profile management */
            .profile-item {
                padding: 8px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .profile-name {
                font-size: 0.85rem;
            }

            .profile-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .profile-btn {
                padding: 5px 10px;
                font-size: 0.7rem;
            }

            /* Detail rows */
            .detail-row {
                font-size: 0.85rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 3px;
            }

            .detail-row span:last-child {
                text-align: left;
            }
        }

        /* Extra small devices (< 360px) */
        @media (max-width: 360px) {
            .brand h1 {
                font-size: 0.9rem;
            }

            .nav-btn {
                font-size: 0.7rem;
                padding: 0.35rem 0.5rem;
            }

            .stat-card {
                padding: 0.5rem 0.3rem;
                min-height: 65px;
            }

            .stat-label {
                font-size: 0.55rem;
            }

            .stat-val {
                font-size: 0.8rem;
            }

            .home-title {
                font-size: 1.3rem;
            }

            .home-subtitle {
                font-size: 0.85rem;
            }

            .denom-grid {
                grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
            }
        }
    </style>
    <base target="_blank">
</head>

<body data-theme="light">

    <div id="app-container">
        <header role="banner" itemscope itemtype="https://schema.org/WPHeader  ">
            <div class="brand">
                <div class="brand-top">
                    <div class="brand-icon">
                        <img src="./logo.png" alt="ArthikaX Logo">
                    </div>
                    <div>
                        <h1>ArthikaX</h1>
                        <!-- Active Profile Display -->
                        <div class="current-profile-badge" id="headerProfileName"
                            onclick="app.toggleModal('settingsModal')">My Business</div>
                    </div>
                </div>
                <a href="https://arthixa.com   " target="_blank">by Arthixa</a>
            </div>
            <div class="header-actions">
                <button id="settingsBtn" aria-label="Settings"></button>
            </div>
        </header>
        <div style="width: 100%; text-align: center; margin: 10px 0; background-color: #fff; padding: 5px 0;">

            <script>
                atOptions = {
                    'key': '37aea13fbdf3f7cf958070dd70143f8d',
                    'format': 'iframe',
                    'height': 50,
                    'width': 320,
                    'params': {}
                };
            </script>
            <script src="https://www.highperformanceformat.com/37aea13fbdf3f7cf958070dd70143f8d/invoke.js   "></script>

        </div>

        <div class="dashboard-container">
            <div class="stat-card income">
                <div class="stat-label">Income</div>
                <div class="stat-val" id="dashIncome">0</div>
            </div>
            <div class="stat-card expense">
                <div class="stat-label">Expenses</div>
                <div class="stat-val" id="dashExpense">0</div>
            </div>
            <div class="stat-card balance">
                <div class="stat-label">Balance</div>
                <div class="stat-val" id="dashBalance">0</div>
            </div>
        </div>

        <!-- Daily Cash Button -->
        <div style="padding: 0 10px 15px 10px; text-align: center;">
            <button class="btn btn-outline"
                style="width: 100%; border: 2px solid var(--primary); color: var(--primary); font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px;"
                onclick="app.showDailyCollection()">
                 View Daily Collection
            </button>
        </div>

        <nav role="navigation" aria-label="Main Navigation">
            <button class="nav-btn" onclick="app.switchTab('home')">Home</button>
            <button class="nav-btn" onclick="app.switchTab('entry')">Entry</button>
            <button class="nav-btn" onclick="app.switchTab('history')">History</button>
            <button class="nav-btn" onclick="app.switchTab('outstanding')">Dues</button>
            <button class="nav-btn" onclick="app.switchTab('ledger')">Ledger</button>
        </nav>

        <main role="main" itemscope itemtype="https://schema.org/WebPageElement  ">
            <!-- HOME SECTION -->
            <section id="home" class="view active">
                <div class="home-container">
                    <div class="home-hero">
                        <div class="home-logo-big">
                            <img src="./logo.png" alt="ArthikaX - Digital Khata Book App">
                        </div>
                        <h1 class="home-title">ArthikaX</h1>
                        <h2 class="home-subtitle">Best Free Khata Book & Udhar Bahi App</h2>
                        <p class="home-desc">The #1 <strong>Offline Khata Book App</strong> for small business. Manage
                            <strong>Udhar Bahi Khata</strong>, Credit Debit Ledger, Daily Cash Collection & Party Dues
                            without internet. Best <strong>Digital Bahi Khata</strong>, Money Manager & Bill Book for
                            shopkeepers. <strong>100% Free, Secure & Private.</strong>
                        </p>
                        <meta itemprop="description"
                            content="Best Khata Book app for business accounting, udhar tracking, and credit debit management. Free offline ledger app.">

                        <p
                            style="font-size: 0.85rem; font-weight: 600; background: rgba(255,255,255,0.2); display: inline-block; padding: 4px 12px; border-radius: 20px; margin-top: 15px; position: relative; z-index: 1;">
                             Supports 50+ Countries & Currencies
                        </p>
                    </div>

                    <div class="features-grid">
                        <div class="feature-poster" itemscope itemtype="https://schema.org/ListItem  ">
                            <span class="feature-icon-lg"></span>
                            <h4 itemprop="name">Offline Khata Book</h4>
                            <p itemprop="description">Digital Udhar Bahi Khata. Track Cash, Credit & Debit 100% Offline
                                without internet.</p>
                            <meta itemprop="position" content="1">
                        </div>
                        <div class="feature-poster" itemscope itemtype="https://schema.org/ListItem  ">
                            <span class="feature-icon-lg"></span>
                            <h4 itemprop="name">Cash Book & Calculator</h4>
                            <p itemprop="description">Daily Cash Book with Denomination Counter. Fast Money Calculation
                                & Tally.</p>
                            <meta itemprop="position" content="2">
                        </div>
                        <div class="feature-poster" itemscope itemtype="https://schema.org/ListItem  ">
                            <span class="feature-icon-lg"></span>
                            <h4 itemprop="name">Party Ledger & Bill Book</h4>
                            <p itemprop="description">Manage Customer Udhar Hisab, Credit/Debit Accounts & Business
                                Bills.</p>
                            <meta itemprop="position" content="3">
                        </div>
                        <div class="feature-poster" itemscope itemtype="https://schema.org/ListItem  ">
                            <span class="feature-icon-lg"></span>
                            <h4 itemprop="name">Secure PIN & Encryption</h4>
                            <p itemprop="description">AES-256 Encrypted Business Data. PIN Lock Protection. 100%
                                Private.</p>
                            <meta itemprop="position" content="4">
                        </div>
                    </div>

                    <div style="width: 100%; display: flex; justify-content: center; margin: 20px 0;">
                        <script>
                            atOptions = {
                                'key': '37aea13fbdf3f7cf958070dd70143f8d',
                                'format': 'iframe',
                                'height': 50,
                                'width': 320,
                                'params': {}
                            };
                        </script>
                        <script
                            src="https://www.highperformanceformat.com/37aea13fbdf3f7cf958070dd70143f8d/invoke.js   "></script>
                    </div>
                    <button class="btn btn-primary" onclick="app.switchTab('entry')"
                        style="margin-top: 1rem; font-size: 1.1rem; padding: 1rem;">
                         Start New Entry
                    </button>

                    <div class="home-credits">
                        <h3>ArthikaX v2.4.0</h3>
                        <p>Author: Pintu Sikder</p>
                        <p>By: <a href="https://arthixa.com   " target="_blank">Arthixa</a></p>
                    </div>
                </div>
            </section>

            <!-- SECTION1: CASH ENTRY -->
            <section id="entry" class="view">
                <div class="card">
                    <div class="form-group">
                        <label>Country & Currency</label>
                        <div class="custom-select-wrapper">
                            <div class="custom-select" id="countryDropdown">
                                <div class="custom-select__trigger"><span>Select Country</span>
                                    <div class="arrow"></div>
                                </div>
                                <div class="custom-select__options">
                                    <div class="custom-select__search">
                                        <input type="text" placeholder="Ex: India, USD, Euro..."
                                            id="countrySearchInput">
                                    </div>
                                    <div
                                        style="padding: 0 10px 10px 10px; font-size: 0.75rem; color: var(--neutral); font-style: italic;">
                                        Try typing country name (e.g., "India") or Currency Code (e.g., "USD").
                                    </div>
                                    <div class="options-container" id="countryOptionsList"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="display: flex; gap: 10px;">
                        <div style="flex:1">
                            <label>Date</label>
                            <input type="date" id="entryDate" class="form-control">
                        </div>
                        <div style="flex:1">
                            <label>Time</label>
                            <input type="time" id="entryTime" class="form-control">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Collected By (Name) *</label>
                        <input type="text" id="entryName" class="form-control" placeholder="Enter Name (Required)">
                    </div>

                    <div class="form-group">
                        <label>Mobile Number</label>
                        <input type="tel" id="entryMobile" class="form-control" placeholder="Optional">
                    </div>

                    <!-- OPTIONAL ITEMS SECTION -->
                    <div class="form-group">
                        <label>Optional Items (Tags)</label>
                        <div class="tags-input-group">
                            <input type="text" id="tagInput" class="form-control" placeholder="Add item (e.g. Rent)">
                            <button class="btn btn-primary" style="width: auto;" onclick="app.addTag()">Add</button>
                        </div>
                        <div id="tagsContainer" class="tags-container"></div>
                    </div>

                    <div class="form-group">
                        <label>Remarks / Notes</label>
                        <input type="text" id="entryRemarks" class="form-control" placeholder="Optional notes...">
                    </div>

                    <div class="form-group">
                        <label>Payment Status</label>
                        <select id="entryStatus" class="form-control" onchange="app.handleStatusChange()">
                            <option value="Paid">Paid (Cleared)</option>
                            <option value="Due">Due (Outstanding)</option>
                            <option value="Partial">Partial Payment</option>
                        </select>
                    </div>



                    <!-- DUE OPTIONS -->
                    <div class="form-group" id="dueOptions" style="display: none;">
                        <label>Due Amount</label>
                        <input type="number" id="dueTotalAmount" class="form-control" placeholder="Enter Due Amount"
                            style="margin-bottom:10px;">

                        <label>Due Type (Who owes whom?)</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="dueType" value="receivable" checked>
                                Receivable (Customer will pay)
                            </label>
                            <label>
                                <input type="radio" name="dueType" value="payable">
                                Payable (I have to pay)
                            </label>
                        </div>
                    </div>

                    <!-- PARTIAL PAYMENT OPTIONS -->
                    <div class="form-group" id="partialOptions" style="display:none; margin-top:12px;">
                        <label style="margin-bottom:8px; display:block;">Amount Summary</label>

                        <input type="number" id="partialTotalAmount" class="form-control" style="margin-bottom:10px;"
                            placeholder="Total Bill Amount" oninput="app.calculatePartial()">

                        <input type="number" id="partialCollectedAmount" class="form-control"
                            style="margin-bottom:10px;" placeholder="Amount Received" oninput="app.calculatePartial()">

                        <input type="number" id="partialBalanceAmount" class="form-control" style="margin-bottom:12px;"
                            placeholder="Balance Due" readonly>

                        <label style="margin-bottom:6px; display:block;">Outstanding Type (Who owes whom?)</label>
                        <div class="radio-group" style="margin-top:6px;">
                            <label style="display:block; margin-bottom:6px;">
                                <input type="radio" name="partialDueType" value="receivable" checked>
                                Receivable (Customer will pay)
                            </label>
                            <label style="display:block;">
                                <input type="radio" name="partialDueType" value="payable">
                                Payable (I have to pay)
                            </label>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <label style="font-weight: 600; color: var(--neutral);">Denomination Counter</label>
                    <div id="denominationContainer" class="denom-grid"></div>
                </div>

                <div class="total-display">
                    <div class="total-label">Total Amount</div>
                    <div class="total-amount" id="displayTotal">0.00</div>
                    <div class="total-words" id="displayWords">Select a country to begin</div>
                </div>

                <div style="margin-bottom: 80px;">
                    <button class="btn btn-primary" onclick="app.saveRecord()">
                        <span> Save Record</span>
                    </button>
                </div>
            </section>

            <!-- SECTION 2: HISTORY -->
            <section id="history" class="view">
                <div class="card">
                    <div class="filter-container">
                        <!-- NEW RESPONSIVE FILTER SECTION -->
                        <div
                            style="display: flex; flex-direction: column; gap: 12px; background: var(--light-bg); padding: 12px; border-radius: var(--radius-md); border: 1px solid var(--border);">

                            <!-- Row 1: Sort Dropdown -->
                            <div style="width: 100%;">
                                <label
                                    style="font-size: 0.8rem; color: var(--neutral); margin-bottom: 4px; display: block;">Sort
                                    By</label>
                                <select id="sortMode" class="form-control" onchange="app.handleSort(this.value)"
                                    style="padding: 8px; font-size: 0.9rem;">
                                    <option value="date-desc"> Date: Newest First</option>
                                    <option value="date-asc"> Date: Oldest First</option>
                                    <option value="amount-desc"> Amount: High to Low</option>
                                    <option value="amount-asc"> Amount: Low to High</option>
                                    <option value="name-asc"> Name: A to Z</option>
                                    <option value="name-desc"> Name: Z to A</option>
                                </select>
                            </div>

                            <!-- Row 1.5: Source Dropdown (NEW) -->
                            <div style="width: 100%;">
                                <label
                                    style="font-size: 0.8rem; color: var(--neutral); margin-bottom: 4px; display: block;">Source</label>
                                <select id="filterSource" class="form-control"
                                    onchange="app.handleSourceFilter(this.value)"
                                    style="padding: 8px; font-size: 0.9rem;">
                                    <option value="all"> All Records</option>
                                    <option value="entry"> Regular Entries Only</option>
                                    <option value="collection"> Daily Collections Only</option>
                                </select>
                            </div>

                            <!-- Row 2: Filter Tabs (Radio Buttons) -->
                            <div class="radio-group"
                                style="padding: 0; background: transparent; border: none; gap: 15px;">
                                <label
                                    style="font-size: 0.8rem; color: var(--neutral); width: 100%; margin-bottom: 4px; display: block;">Filter
                                    By</label>

                                <div
                                    style="display: flex; background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-sm); overflow: hidden; width: 100%;">
                                    <label
                                        style="flex: 1; padding: 8px; justify-content: center; border-right: 1px solid var(--border); margin: 0; font-size: 0.85rem;"
                                        for="filter-name">
                                        <input type="radio" id="filter-name" name="filterType" value="name"
                                            onchange="app.setFilterMode('name')" checked style="margin-right: 4px;">
                                        Name
                                    </label>
                                    <label
                                        style="flex: 1; padding: 8px; justify-content: center; border-right: 1px solid var(--border); margin: 0; font-size: 0.85rem;"
                                        for="filter-date">
                                        <input type="radio" id="filter-date" name="filterType" value="date"
                                            onchange="app.setFilterMode('date')" style="margin-right: 4px;"> Date
                                    </label>
                                    <label
                                        style="flex: 1; padding: 8px; justify-content: center; margin: 0; font-size: 0.85rem;"
                                        for="filter-amount">
                                        <input type="radio" id="filter-amount" name="filterType" value="amount"
                                            onchange="app.setFilterMode('amount')" style="margin-right: 4px;"> Amount
                                    </label>
                                </div>
                            </div>

                            <!-- Row 3: Filter Input -->
                            <div class="filter-input-wrapper" style="width: 100%;">
                                <input type="text" id="filterName" class="form-control filter-input"
                                    placeholder=" Search Name (e.g. Rahul)..."
                                    onkeyup="app.handleFilter('name', this.value)">
                                <input type="date" id="filterDate" class="form-control filter-input"
                                    style="display:none;" onchange="app.handleFilter('date', this.value)">
                                <input type="number" id="filterAmount" class="form-control filter-input"
                                    placeholder=" Enter Amount..." style="display:none;"
                                    onkeyup="app.handleFilter('amount', this.value)">
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-secondary" style="flex:1" onclick="app.exportLast30Days()">Export (30
                                Days)</button>
                            <button class="btn btn-outline" style="flex:1" onclick="app.openRangeModal()">Date
                                Range</button>
                        </div>
                    </div>

                    <ul id="historyList" class="history-list"></ul>
                    <div id="emptyState" class="text-center" style="padding: 2rem; display: none;">
                        <p style="color: var(--neutral);">No records found.</p>
                    </div>
            </section>

            <!-- SECTION 3: OUTSTANDING / DUES -->
            <section id="outstanding" class="view">
                <div class="card">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">Outstanding Summary</h3>
                    <div class="dashboard-container"
                        style="margin-bottom: 10px; padding:0; border:none; background:transparent; grid-template-columns: 1fr 1fr;">
                        <div class="stat-card">
                            <div class="stat-label">To Receive</div>
                            <div class="stat-val" style="color:var(--text-income)" id="dueReceivable">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">To Pay</div>
                            <div class="stat-val" style="color:var(--text-expense)" id="duePayable">0</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 10px; display:flex; flex-wrap: wrap; gap:10px; align-items: center;"
                    id="outstandingFilters">
                    <!-- SORT DROPDOWN for Outstanding -->
                    <select id="outstandingSort" class="form-control"
                        style="width: auto; padding: 6px; font-size: 0.9rem;" onchange="app.renderOutstanding()">
                        <option value="amount-desc"> Amount: High to Low</option>
                        <option value="amount-asc"> Amount: Low to High</option>
                        <option value="date-desc"> Date: Newest First</option>
                        <option value="date-asc"> Date: Oldest First</option>
                    </select>

                    <div style="display:flex; gap:5px;">
                        <button id="btn-out-all" class="btn btn-outline active"
                            onclick="app.renderOutstanding('all')">All</button>
                        <button id="btn-out-rec" class="btn btn-outline"
                            style="border-color:var(--text-income); color:var(--text-income)"
                            onclick="app.renderOutstanding('receivable')">Receivable</button>
                        <button id="btn-out-pay" class="btn btn-outline"
                            style="border-color:var(--text-expense); color:var(--text-expense)"
                            onclick="app.renderOutstanding('payable')">Payable</button>
                    </div>
                </div>

                <ul id="outstandingList" class="history-list"></ul>
                <div id="outstandingEmpty" class="text-center" style="padding: 2rem; display: none;">
                    <p style="color: var(--neutral);">No outstanding dues.</p>
                </div>
            </section>

            <!-- SECTION 4: PARTY LEDGER -->
            <section id="ledger" class="view">
                <div class="card">
                    <label>Search Customer / Party</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="ledgerSearch" class="form-control" placeholder="Ex: Rahul, Priya..."
                            oninput="app.suggestLedgerName(this.value)">
                    </div>
                    <div id="ledgerSuggestions" style="margin-top:5px; display:flex; flex-wrap:wrap; gap:5px;"></div>
                    <div class="search-hint">Type customer name to see their ledger.</div>
                </div>

                <div id="ledgerDetails" style="display:none;">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 id="ledgerCustomerName" style="color:var(--primary); margin:0; word-break: break-word;">
                                Customer Name</h3>
                            <button class="btn btn-outline" style="width:auto; padding:5px 10px; font-size:0.8rem;"
                                onclick="app.clearLedger()">Clear</button>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                            <div
                                style="background:var(--bg-income); padding:10px; border-radius:var(--radius-sm); text-align:center;">
                                <div style="font-size:0.7rem; text-transform:uppercase;">Total Received</div>
                                <div style="font-size:1.1rem; font-weight:bold; color:var(--text-income);"
                                    id="ledgerTotalReceived">0</div>
                            </div>
                            <div
                                style="background:var(--bg-expense); padding:10px; border-radius:var(--radius-sm); text-align:center;">
                                <div style="font-size:0.7rem; text-transform:uppercase;">Total Paid/Given</div>
                                <div style="font-size:1.1rem; font-weight:bold; color:var(--text-expense);"
                                    id="ledgerTotalPaid">0</div>
                            </div>
                        </div>

                        <div
                            style="margin-top:10px; padding:10px; background:var(--bg-balance); border-radius:var(--radius-sm); text-align:center;">
                            <div style="font-size:0.7rem; text-transform:uppercase;">Net Balance</div>
                            <div style="font-size:1.2rem; font-weight:bold; color:var(--text-balance);"
                                id="ledgerNetBalance">0</div>
                        </div>
                    </div>

                    <h4 style="margin: 20px 0 10px 5px; font-size:1rem; color:var(--neutral);">Transactions</h4>
                    <ul id="ledgerList" class="history-list"></ul>
                </div>
                <div id="ledgerEmpty" class="text-center" style="padding: 2rem; margin-top:20px; display: block;">
                    <p style="color: var(--neutral);">Select a customer to view ledger.</p>
                </div>
            </section>
        </main>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="app.toggleModal('settingsModal')">&times;</button>
                <h2 style="margin-bottom: 1.5rem; color: var(--primary);">Settings</h2>
                <div class="form-group">
                    <label>Theme</label>
                    <select id="themeSelect" class="form-control" onchange="app.setTheme(this.value)">
                        <option value="light">Light Mode</option>
                        <option value="dark">Dark Mode</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>App Theme Color</label>
                    <input type="color" id="primaryColorInput" class="form-control" style="height: 50px; padding:5px;"
                        onchange="app.setPrimaryColor(this.value)">
                    <!-- Quick Select Preset Colors -->
                    <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: flex-start;">
                        <div onclick="app.setPrimaryColor('#F67B34')"
                            style="width: 35px; height: 35px; border-radius: 50%; background-color: #F67B34; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);"
                            title="Default Orange"></div>
                        <div onclick="app.setPrimaryColor('#FF0000')"
                            style="width: 35px; height: 35px; border-radius: 50%; background-color: #FF0000; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);"
                            title="Deep Orange"></div>
                        <div onclick="app.setPrimaryColor('#007bff')"
                            style="width: 35px; height: 35px; border-radius: 50%; background-color: #007bff; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);"
                            title="Blue"></div>
                        <div onclick="app.setPrimaryColor('#28a745')"
                            style="width: 35px; height: 35px; border-radius: 50%; background-color: #28a745; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);"
                            title="Green"></div>
                        <div onclick="app.setPrimaryColor('#e83e8c')"
                            style="width: 35px; height: 35px; border-radius: 50%; background-color: #e83e8c; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);"
                            title="Pink"></div>
                        <div onclick="app.setPrimaryColor('#5E2B9D')"
                            style="width: 35px; height: 35px; border-radius: 50%; background-color: #5E2B9D; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);"
                            title="Purple"></div>
                    </div>
                </div>

                <!-- PROFILE MANAGEMENT SECTION -->
                <div class="card"
                    style="margin-bottom: 1rem; border: 1px dashed var(--primary); background: rgba(243, 108, 33, 0.05);">
                    <label style="font-weight: 700; color: var(--primary); margin-bottom: 10px;">Manage Business
                        Profiles</label>
                    <div class="form-group" style="margin-bottom: 5px;">
                        <input type="text" id="newProfileName" class="form-control"
                            placeholder="New Shop/Business Name">
                        <button class="btn btn-primary btn-sm" style="margin-top:5px;"
                            onclick="app.createProfile()">Create New Profile</button>
                    </div>
                    <ul id="profileListContainer" class="profile-list"></ul>
                </div>
                <!-- END PROFILE SECTION -->

                <div class="form-group">
                    <label>Country & Currency</label>
                    <div class="custom-select-wrapper">
                        <div class="custom-select" id="settingsCountryDropdown">
                            <div class="custom-select__trigger"><span>Select Country</span>
                                <div class="arrow"></div>
                            </div>
                            <div class="custom-select__options">
                                <div class="custom-select__search">
                                    <input type="text" placeholder="Ex: India, USD, Euro..." id="settingsSearchInput">
                                </div>
                                <div
                                    style="padding: 0 10px 10px 10px; font-size: 0.75rem; color: var(--neutral); font-style: italic;">
                                    Try typing country name or Currency Code.
                                </div>
                                <div class="options-container" id="settingsOptionsList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-wrapper"
                        style="display: flex; align-items: center; gap: 10px; padding: 5px 0; border: none; background: transparent;"
                        onclick="app.toggleAutoDelete()">
                        <input type="checkbox" id="autoDeleteToggle" style="cursor: pointer;">
                        <label for="autoDeleteToggle" style="cursor: pointer; width: auto;">Auto-delete records older
                            than 90 days</label>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--neutral); margin-top: 5px; margin-left: 24px;">When
                        enabled, records older than 90 days are automatically deleted on app reload.</div>
                </div>

                <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid var(--border);">
                <!-- User Guide Button in Settings -->
                <button class="btn btn-outline" onclick="showUserGuide()"
                    style="margin-top: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem;">
                    <span></span>
                    <span>User Guide</span>
                </button>

                <div class="credits-container"
                    style="text-align: center; margin-top: 20px; opacity: 0.7; font-size: 0.85rem;">
                    <h3 style="margin-bottom: 5px; color: var(--primary);">ArthikaX</h3>
                    <p style="margin-bottom: 2px;">Version 2.4.0</p>
                    <p style="margin-bottom: 2px;">Author: Pintu Sikder</p>
                    <p>By: <a href="https://arthixa.com" target="_blank" class="By-link"
                            style="color: var(--primary); text-decoration: none; font-weight: 600;">Arthixa</a></p>
                </div>

            </div>
        </div>

        <!-- Date Range Modal -->
        <div id="dateRangeModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="app.toggleModal('dateRangeModal')">&times;</button>
                <h2 style="margin-bottom: 1.5rem; color: var(--primary);">Select Date Range</h2>
                <div class="form-group"><label>From Date</label><input type="date" id="rangeStart" class="form-control">
                </div>
                <div class="form-group"><label>To Date</label><input type="date" id="rangeEnd" class="form-control">
                </div>
                <button class="btn btn-primary" onclick="app.generateRangeReport()">Export Range</button>
            </div>
        </div>

        <!-- View Details Modal -->
        <div id="viewDetailModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="app.toggleModal('viewDetailModal')">&times;</button>
                <h2 style="margin-bottom: 1rem; color: var(--primary);">Record Details</h2>
                <div id="detailContent"></div>
            </div>
        </div>

        <!-- Daily Cash Collection Modal -->
        <div id="dailyCollectionModal" class="modal">
            <div class="modal-content" style="max-width: 500px; padding: 0;">
                <div
                    style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); position: sticky; top: 0; z-index: 10;">
                    <h2 style="margin: 0; color: var(--primary); font-size: 1.2rem;">Today's Hub</h2>
                    <button style="background:none; border:none; font-size:1.5rem; cursor:pointer;"
                        onclick="app.toggleModal('dailyCollectionModal')">&times;</button>
                </div>

                <div style="padding: 15px; max-height: 75vh; overflow-y: auto;">

                    <!-- 1. TODAY'S STATS SUMMARY -->
                    <div id="dailyStatsContainer"
                        style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px;">
                        <!-- Injected via JS -->
                    </div>

                    <!-- 2. QUICK ADD CASH SECTION -->
                    <div class="card"
                        style="margin-bottom: 20px; border: 1px dashed var(--primary); background: rgba(243, 108, 33, 0.05);">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary); font-size: 1rem;"> Quick Cash Entry</h4>
                        <div id="quickCashGrid"
                            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;">
                            <!-- Grid Injected via JS -->
                        </div>
                        <div
                            style="background: var(--card-bg); padding: 10px; border-radius: 4px; border: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">Total:</span>
                                <span id="quickCashTotal"
                                    style="font-weight: 700; color: var(--text-income); font-size: 1.1rem;">0</span>
                            </div>
                            <div id="quickCashWords"
                                style="font-size: 0.8rem; color: var(--neutral); text-align: right; margin-top: 2px; font-style: italic;">
                                Zero Only</div>
                        </div>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 10px;"
                            onclick="app.saveQuickCollection()">Save Cash Entry</button>
                    </div>

                    <!-- 3. DETAILED COLLECTION LIST -->
                    <h4
                        style="margin: 0 0 10px 0; color: var(--neutral); font-size: 0.9rem; text-transform: uppercase;">
                        Collections by Currency</h4>
                    <div id="dailyCollectionList">
                        <!-- Dynamic Content Here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Legal Pages Modal with Iframe -->
        <div id="legalModal" class="modal" style="z-index: 3000;">
            <div class="modal-content"
                style="width:100%; height:100%; max-width:100%; border-radius:0; padding:0; display:flex; flex-direction:column; background: var(--card-bg);">
                <div
                    style="padding:10px 15px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap: 10px; background:var(--card-bg);">
                    <button onclick="history.back()"
                        style="border:none; background:none; padding: 5px; color:var(--primary); cursor:pointer; display:flex; align-items:center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                    </button>
                    <h3 id="legalTitle" style="margin:0; font-size:1rem; color:var(--primary); flex:1;">Legal</h3>
                    <button onclick="history.back()"
                        style="border:none; background:none; font-size:1.5rem; color:var(--secondary); cursor:pointer;">&times;</button>
                </div>
                <iframe id="legalFrame" style="flex:1; border:none; width:100%; background:#fff;"></iframe>
            </div>
        </div>

        <!-- PRINTABLE AREA (Hidden from screen, visible on Print) -->
        <div id="print-area">
            <!-- Content injected via JS -->
        </div>

        <div id="toast">Message here</div>

        <!-- PWA INSTALL BANNER UI -->
        <div id="pwa-install-banner">
            <div class="pwa-content">
                <div class="pwa-title">Install as App</div>
                <div class="pwa-desc">Add to Home Screen for quick access</div>
            </div>
            <button id="installBtn" class="btn-install">Install</button>
            <button id="closePrompt" class="btn-close-pwa">&times;</button>
        </div>

        <footer class="app-footer"
            style="text-align: center; padding: 1rem 0 1.5rem 0; opacity: 0.8; font-size: 0.75rem; color: var(--neutral); margin-top: auto;">
            <h3 style="color: var(--primary); margin-bottom: 5px; font-size: 0.9rem;">ArthikaX - Free Offline Digital
                Khata Book</h3>
            <p style="margin-bottom: 8px;">&copy; 2026 Arthixa. All rights reserved. | Version 2.4.0</p>
            <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
                <a href="privacy-policy.html" target="_blank"
                    style="color: var(--text-color); text-decoration: none;">Privacy Policy</a> &bull;
                <a href="terms-of-service.html" target="_blank"
                    style="color: var(--text-color); text-decoration: none;">Terms of Service</a> &bull;
                <a href="about.html" target="_blank" style="color: var(--text-color); text-decoration: none;">About
                    Us</a> &bull;
                <a href="contact.html" target="_blank"
                    style="color: var(--text-color); text-decoration: none;">Contact</a>
            </div>
        </footer>

    </div>

    <script>
        // App Logic
        const app = {
        state: {
        currentTheme: 'light',
        primaryColor: '#F67B34', // Updated Default Color
        autoDeleteEnabled: false,
        currentTags: [],
        profiles: [{ id: 1, name: "My Business" }], // Default Profile
        currentProfileId: 1, // Default ID
        config: [
        { name: "United States", currency: "USD", symbol: "$", flag: "", denominations: [1, 2, 5, 10, 20, 50, 100]
        },
        { name: "India", currency: "INR", symbol: "", flag: "", denominations: [1, 2, 5, 10, 20, 50, 100, 200, 500]
        },
        { name: "Euro Zone", currency: "EUR", symbol: "", flag: "", denominations: [5, 10, 20, 50, 100, 200, 500]
        },
        { name: "United Kingdom", currency: "GBP", symbol: "", flag: "", denominations: [5, 10, 20, 50] },
        { name: "Japan", currency: "JPY", symbol: "", flag: "", denominations: [1, 5, 10, 50, 100, 500, 1000, 5000,
        10000] },
        { name: "Australia", currency: "AUD", symbol: "A$", flag: "", denominations: [5, 10, 20, 50, 100] },
        { name: "Canada", currency: "CAD", symbol: "C$", flag: "", denominations: [5, 10, 20, 50, 100] },
        { name: "China", currency: "CNY", symbol: "", flag: "", denominations: [1, 5, 10, 20, 50, 100] },
        { name: "Switzerland", currency: "CHF", symbol: "Fr", flag: "", denominations: [10, 20, 50, 100, 200, 1000]
        },
        { name: "Russia", currency: "RUB", symbol: "", flag: "", denominations: [50, 100, 200, 500, 1000, 2000,
        5000] },
        { name: "South Korea", currency: "KRW", symbol: "", flag: "", denominations: [1000, 5000, 10000, 50000] },
        { name: "Brazil", currency: "BRL", symbol: "R$", flag: "", denominations: [10, 20, 50, 100, 200] },
        { name: "Mexico", currency: "MXN", symbol: "$", flag: "", denominations: [20, 50, 100, 200, 500] },
        { name: "South Africa", currency: "ZAR", symbol: "R", flag: "", denominations: [10, 20, 50, 100, 200] },
        { name: "Singapore", currency: "SGD", symbol: "S$", flag: "", denominations: [2, 5, 10, 50, 100, 1000] },
        { name: "Hong Kong", currency: "HKD", symbol: "HK$", flag: "", denominations: [10, 20, 50, 100, 500, 1000]
        },
        { name: "New Zealand", currency: "NZD", symbol: "NZ$", flag: "", denominations: [5, 10, 20, 50, 100] },
        { name: "Sweden", currency: "SEK", symbol: "kr", flag: "", denominations: [20, 50, 100, 200, 500] },
        { name: "Norway", currency: "NOK", symbol: "kr", flag: "", denominations: [50, 100, 200, 500, 1000] },
        { name: "Denmark", currency: "DKK", symbol: "kr", flag: "", denominations: [50, 100, 200, 500, 1000] },
        { name: "Poland", currency: "PLN", symbol: "z", flag: "", denominations: [10, 20, 50, 100, 200, 500] },
        { name: "Turkey", currency: "TRY", symbol: "", flag: "", denominations: [20, 50, 100, 200, 500] },
        { name: "Thailand", currency: "THB", symbol: "", flag: "", denominations: [20, 50, 100, 500, 1000] },
        { name: "Malaysia", currency: "MYR", symbol: "RM", flag: "", denominations: [1, 5, 10, 20, 50, 100] },
        { name: "Indonesia", currency: "IDR", symbol: "Rp", flag: "", denominations: [1000, 2000, 5000, 10000,
        20000, 50000, 100000] },
        { name: "Philippines", currency: "PHP", symbol: "", flag: "", denominations: [20, 50, 100, 200, 500, 1000]
        },
        { name: "Vietnam", currency: "VND", symbol: "", flag: "", denominations: [1000, 2000, 5000, 10000, 20000,
        50000, 100000, 200000, 500000] },
        { name: "UAE", currency: "AED", symbol: "dh", flag: "", denominations: [5, 10, 20, 50, 100, 200, 500, 1000]
        },
        { name: "Saudi Arabia", currency: "SAR", symbol: "", flag: "", denominations: [1, 5, 10, 50, 100, 200, 500]
        },
        { name: "Israel", currency: "ILS", symbol: "", flag: "", denominations: [20, 50, 100, 200] },
        { name: "Czech Republic", currency: "CZK", symbol: "K", flag: "", denominations: [100, 200, 500, 1000,
        2000, 5000] },
        { name: "Hungary", currency: "HUF", symbol: "Ft", flag: "", denominations: [500, 1000, 2000, 5000, 10000,
        20000] },
        { name: "Romania", currency: "RON", symbol: "lei", flag: "", denominations: [1, 5, 10, 20, 50, 100, 200,
        500] },
        { name: "Bulgaria", currency: "BGN", symbol: "", flag: "", denominations: [10, 20, 50, 100] },
        { name: "Croatia", currency: "EUR", symbol: "", flag: "", denominations: [5, 10, 20, 50, 100, 200, 500] },
        { name: "Nigeria", currency: "NGN", symbol: "", flag: "", denominations: [5, 10, 20, 50, 100, 200, 500,
        1000] },
        { name: "Egypt", currency: "EGP", symbol: "E", flag: "", denominations: [10, 20, 50, 100, 200, 500] },
        { name: "Pakistan", currency: "PKR", symbol: "", flag: "", denominations: [10, 20, 50, 100, 500, 1000,
        5000] },
        { name: "Bangladesh", currency: "BDT", symbol: "", flag: "", denominations: [10, 20, 50, 100, 200, 500,
        1000] },
        { name: "Sri Lanka", currency: "LKR", symbol: "Rs", flag: "", denominations: [20, 50, 100, 200, 500, 1000,
        2000, 5000] },
        { name: "Nepal", currency: "NPR", symbol: "", flag: "", denominations: [5, 10, 20, 50, 100, 500, 1000] },
        { name: "Myanmar", currency: "MMK", symbol: "K", flag: "", denominations: [50, 100, 200, 500, 1000, 5000,
        10000] },
        { name: "Argentina", currency: "ARS", symbol: "$", flag: "", denominations: [100, 200, 500, 1000, 2000,
        5000, 10000] },
        { name: "Chile", currency: "CLP", symbol: "$", flag: "", denominations: [1000, 2000, 5000, 10000, 20000] },
        { name: "Colombia", currency: "COP", symbol: "$", flag: "", denominations: [2000, 5000, 10000, 20000, 50000,
        100000] },
        { name: "Peru", currency: "PEN", symbol: "S/", flag: "", denominations: [10, 20, 50, 100, 200] },
        { name: "Venezuela", currency: "VES", symbol: "Bs.", flag: "", denominations: [5, 10, 20, 50, 100] },
        { name: "Iraq", currency: "IQD", symbol: ".", flag: "", denominations: [250, 500, 1000, 5000, 10000,
        25000] },
        { name: "Kuwait", currency: "KWD", symbol: ".", flag: "", denominations: [0.25, 0.5, 1, 5, 10, 20] }
        ],
        selectedCountry: null,
        records: [],
        denominations: {},
        filters: {
        mode: 'name',
        name: "",
        date: "",
        amount: "",
        sort: "date-desc",
        source: "all" // New Source Filter
        }
        },

        init: function () {
        this.loadSettings();
        this.loadProfiles();
        this.setupDropdown();
        this.setupSettingsDropdown();
        this.loadRecords();
        this.cleanupOldRecords();
        this.migrateRecordsToProfile(); // Migrate old data

        // RESTORE LAST SELECTED COUNTRY
        const savedCountryName = localStorage.getItem('ArthikaX_lastCountry');
        if (savedCountryName) {
        const savedCountry = this.state.config.find(c => c.name === savedCountryName);
        if (savedCountry) {
        this.selectCountry(savedCountry);
        }
        }

        this.updateDashboard();
        this.updateHeaderProfileDisplay();
        this.renderProfileList();

        const now = new Date();
        document.getElementById('entryDate').valueAsDate = now;
        document.getElementById('entryTime').value = now.toTimeString().substring(0, 5);

        const todayStr = now.toISOString().split('T')[0];
        document.getElementById('entryDate').max = todayStr;
        document.getElementById('filterDate').max = todayStr;
        document.getElementById('rangeStart').max = todayStr;
        document.getElementById('rangeEnd').max = todayStr;

        document.getElementById('settingsBtn').addEventListener('click', () => this.toggleModal('settingsModal'));

        window.addEventListener('click', (e) => {
        if (!e.target.closest('.menu-container')) this.closeAllMenus();
        if (e.target.classList.contains('modal')) e.target.classList.remove('open');
        });

        this.switchTab('home');
        },

        // PROFILE FUNCTIONS
        loadProfiles: function () {
        const savedProfiles = localStorage.getItem('ArthikaX_profiles');
        if (savedProfiles) {
        this.state.profiles = JSON.parse(savedProfiles);
        }
        const savedProfileId = localStorage.getItem('ArthikaX_currentProfileId');
        if (savedProfileId) {
        this.state.currentProfileId = parseInt(savedProfileId);
        }
        },
        saveProfiles: function () {
        localStorage.setItem('ArthikaX_profiles', JSON.stringify(this.state.profiles));
        localStorage.setItem('ArthikaX_currentProfileId', this.state.currentProfileId);
        this.renderProfileList();
        this.updateHeaderProfileDisplay();
        },
        createProfile: function () {
        const input = document.getElementById('newProfileName');
        const name = input.value.trim();
        if (!name) {
        this.showToast("Please enter a profile name.");
        return;
        }
        const newId = Date.now();
        this.state.profiles.push({ id: newId, name: name });
        this.state.currentProfileId = newId; // Switch to new profile immediately
        this.saveProfiles();
        input.value = "";
        this.showToast("New Profile Created!");
        this.updateDashboard(); // Update dashboard to show empty state
        this.renderHistory();
        this.renderOutstanding('all');
        },
        switchProfile: function (id) {
        this.state.currentProfileId = id;
        this.saveProfiles();
        this.updateDashboard();
        this.renderHistory();
        this.renderOutstanding('all');
        // Clear ledger view if open to avoid confusion
        this.clearLedger();
        this.showToast("Switched to " + this.state.profiles.find(p => p.id === id).name);
        },
        deleteProfile: function (id, event) {
        event.stopPropagation();
        if (this.state.profiles.length <= 1) { this.showToast("You must have at least one profile."); return; } if
            (confirm("Are you sure? All records in this profile will be deleted.")) { // Delete records
            this.state.records=this.state.records.filter(r=> r.profileId !== id);
            localStorage.setItem('ArthikaX_records', JSON.stringify(this.state.records));

            // Delete profile
            this.state.profiles = this.state.profiles.filter(p => p.id !== id);

            // If deleted profile was active, switch to first available
            if (this.state.currentProfileId === id) {
            this.state.currentProfileId = this.state.profiles[0].id;
            }

            this.saveProfiles();
            this.updateDashboard();
            this.renderHistory();
            this.renderOutstanding('all');
            this.showToast("Profile deleted.");
            }
            },
            renderProfileList: function () {
            const container = document.getElementById('profileListContainer');
            container.innerHTML = '';
            this.state.profiles.forEach(p => {
            const li = document.createElement('li');
            li.className = `profile-item ${p.id === this.state.currentProfileId ? 'active' : ''}`;

            let deleteBtn = '';
            if (this.state.profiles.length > 1) {
            deleteBtn = `<button class="profile-btn btn-delete"
                onclick="app.deleteProfile(${p.id}, event)">Delete</button>`;
            }

            li.innerHTML = `
            <span class="profile-name">${p.name}</span>
            <div class="profile-actions">
                ${p.id !== this.state.currentProfileId ? `<button class="profile-btn btn-switch"
                    onclick="app.switchProfile(${p.id})">Switch</button>` : '<span class="profile-btn"
                    style="background:#ccc; color:#555; cursor:default;">Active</span>'}
                ${deleteBtn}
            </div>
            `;
            container.appendChild(li);
            });
            },
            updateHeaderProfileDisplay: function () {
            const profile = this.state.profiles.find(p => p.id === this.state.currentProfileId);
            if (profile) {
            document.getElementById('headerProfileName').textContent = profile.name;
            }
            },
            // Helper to get records for current profile
            getProfileRecords: function () {
            return this.state.records.filter(r => r.profileId === this.state.currentProfileId);
            },
            migrateRecordsToProfile: function () {
            // Check if any record lacks profileId (old data)
            const needsMigration = this.state.records.some(r => !r.profileId);
            if (needsMigration) {
            this.state.records.forEach(r => {
            if (!r.profileId) {
            r.profileId = this.state.currentProfileId; // Assign to current active profile
            }
            });
            localStorage.setItem('ArthikaX_records', JSON.stringify(this.state.records));
            }
            },
            // END PROFILE FUNCTIONS

            // NEW FUNCTION: SET PRIMARY COLOR
            setPrimaryColor: function (color) {
            this.state.primaryColor = color;
            document.documentElement.style.setProperty('--primary', color);
            document.documentElement.style.setProperty('--accent', color);
            document.documentElement.style.setProperty('--primary-hover', color);
            document.querySelector('meta[name="theme-color"]').setAttribute("content", color);
            localStorage.setItem('ArthikaX_primaryColor', color);

            // Update UI elements that might use hardcoded colors
            document.getElementById('primaryColorInput').value = color;
            },

            // TAG FUNCTIONS
            addTag: function () {
            const input = document.getElementById('tagInput');
            const val = input.value.trim();
            if (val && !this.state.currentTags.includes(val)) {
            this.state.currentTags.push(val);
            input.value = '';
            this.renderTags();
            }
            },

            handleSort: function (mode) {
            this.state.filters.sort = mode;
            this.renderHistory();
            },

            handleSourceFilter: function (source) {
            this.state.filters.source = source;
            this.renderHistory();
            },

            removeTag: function (tag) {
            this.state.currentTags = this.state.currentTags.filter(t => t !== tag);
            this.renderTags();
            },
            renderTags: function () {
            const container = document.getElementById('tagsContainer');
            container.innerHTML = '';
            this.state.currentTags.forEach(tag => {
            const chip = document.createElement('div');
            chip.className = 'tag-chip';
            chip.innerHTML = `
            <span>${tag}</span>
            <span class="tag-close" onclick="app.removeTag('${tag}')">&times;</span>
            `;
            container.appendChild(chip);
            });
            },



            toggleAutoDelete: function () {
            const cb = document.getElementById('autoDeleteToggle');
            if (cb) {
            cb.checked = !cb.checked;
            this.state.autoDeleteEnabled = cb.checked;
            localStorage.setItem('ArthikaX_autoDelete', cb.checked);
            }
            },

            handleStatusChange: function () {
            const status = document.getElementById('entryStatus').value;

            // const paidOpts = document.getElementById('paidOptions'); // REMOVED
            const dueOpts = document.getElementById('dueOptions');
            const partialOpts = document.getElementById('partialOptions');

            const dueAmt = document.getElementById('dueTotalAmount');

            // Hide all first (safe reset)
            // paidOpts.style.display = 'none'; // REMOVED
            dueOpts.style.display = 'none';
            partialOpts.style.display = 'none';

            if (status === 'Paid') {
            // paidOpts.style.display = 'block'; // REMOVED - No options for Paid anymore
            }
            else if (status === 'Due') {
            dueOpts.style.display = 'block';
            if (dueAmt) dueAmt.focus();
            }
            else if (status === 'Partial') {
            partialOpts.style.display = 'block';
            }
            },
            calculatePartial: function () {
            const totalAmount = parseFloat(document.getElementById('partialTotalAmount').value) || 0;
            const collectedAmount = parseFloat(document.getElementById('partialCollectedAmount').value) || 0;
            const balanceAmount = totalAmount - collectedAmount;

            const balanceInput = document.getElementById('partialBalanceAmount');
            const label = balanceInput.previousElementSibling || balanceInput.parentElement.querySelector('label'); //
            Fallback
            // Helper function to update label if exists (we might need to add a dedicated label ID or traverse DOM)
            // Since partialBalanceAmount is an input, the "Balance Due" text is placeholder.
            // We should change placeholder to indicate return.

            if (balanceAmount < 0) { balanceInput.value=Math.abs(balanceAmount).toFixed(2);
                balanceInput.placeholder="Change to Return" ; balanceInput.style.color="green" ; // Ideally change label
                text if possible, but placeholder and value is key here. // The user
                asked "100 taka pabe setar hisab dekhachhe na" - seeing "100" in this box answers that. // Overpayment:
                I have to pay back the change -> Payable
                const payRadio = document.querySelector('input[name="partialDueType"][value="payable"]');
                if (payRadio) payRadio.checked = true;

                } else {
                balanceInput.value = balanceAmount.toFixed(2);
                balanceInput.placeholder = "Balance Due";
                balanceInput.style.color = "";

                // REMOVED Auto-Receivable:
                // To support "Partial Payable" (I owe money), we must allow manual selection for positive balances.
                // If we force Receivable here, user cannot select Payable for debts.
                }
                },
                updateDashboard: function () {
                const profileRecords = this.getProfileRecords();
                const totalIncome = profileRecords.filter(r => r.type === 'income').reduce((sum, r) => sum + r.total,
                0);
                const totalExpense = profileRecords.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.total,
                0);
                const netBalance = totalIncome - totalExpense;

                document.getElementById('dashIncome').textContent = totalIncome.toLocaleString();
                document.getElementById('dashExpense').textContent = totalExpense.toLocaleString();
                document.getElementById('dashBalance').textContent = netBalance.toLocaleString();

                // Calculate outstanding dues (including Partial Payment balances)
                let dueRec = 0;
                let duePay = 0;

                profileRecords.forEach(r => {
                if (r.status === 'Due') {
                if (r.type === 'income') dueRec += r.total;
                else if (r.type === 'expense') duePay += r.total;
                } else if (r.status === 'Partial' && r.partialPayment) {
                // FIX: Ensure Partial Payment balances are added correctly
                let balance = parseFloat(r.partialPayment.balanceAmount);
                if (isNaN(balance)) balance = 0;

                // Only add positive balances to Outstanding (Negative = Change Returned)
                // UPDATE: User wants Return Amount to be tracked as Outstanding Payable (Debt)
                if (balance > 0) {
                if (r.partialPayment.dueType === 'receivable') {
                dueRec += balance;
                } else {
                duePay += balance;
                }
                } else if (balance < 0) { // Negative balance=I owe extra money back=Payable duePay +=Math.abs(balance);
                    } } }); document.getElementById('dueReceivable').textContent=dueRec.toLocaleString();
                    document.getElementById('duePayable').textContent=duePay.toLocaleString(); }, setupDropdown:
                    function () { const wrapper=document.querySelector('#countryDropdown'); const
                    trigger=wrapper.querySelector('.custom-select__trigger'); const
                    searchInput=document.getElementById('countrySearchInput');
                    this.populateOptions(this.state.config, 'countryOptionsList' ); trigger.addEventListener('click',
                    (e)=> {
                    wrapper.classList.toggle('open');
                    if (wrapper.classList.contains('open')) {
                    searchInput.value = '';
                    searchInput.focus();
                    this.populateOptions(this.state.config, 'countryOptionsList');
                    }
                    });

                    searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = this.state.config.filter(c => {
                    const countryMatch = c.name.toLowerCase().includes(term);
                    const currencyMatch = c.currency.toLowerCase().includes(term);
                    return countryMatch || currencyMatch;
                    });
                    this.populateOptions(filtered, 'countryOptionsList');
                    });

                    window.addEventListener('click', (e) => {
                    if (!wrapper.contains(e.target)) wrapper.classList.remove('open');
                    });
                    },

                    setupSettingsDropdown: function () {
                    const wrapper = document.querySelector('#settingsCountryDropdown');
                    const trigger = wrapper.querySelector('.custom-select__trigger');
                    const searchInput = document.getElementById('settingsSearchInput');
                    this.populateOptions(this.state.config, 'settingsOptionsList');

                    trigger.addEventListener('click', (e) => {
                    wrapper.classList.toggle('open');
                    if (wrapper.classList.contains('open')) {
                    searchInput.value = '';
                    searchInput.focus();
                    this.populateOptions(this.state.config, 'settingsOptionsList');
                    }
                    });

                    searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = this.state.config.filter(c => {
                    const countryMatch = c.name.toLowerCase().includes(term);
                    const currencyMatch = c.currency.toLowerCase().includes(term);
                    return countryMatch || currencyMatch;
                    });
                    this.populateOptions(filtered, 'settingsOptionsList');
                    });

                    window.addEventListener('click', (e) => {
                    if (!wrapper.contains(e.target)) wrapper.classList.remove('open');
                    });
                    },

                    populateOptions: function (list, targetId) {
                    const container = document.getElementById(targetId);
                    container.innerHTML = '';
                    if (list.length === 0) {
                    container.innerHTML = '<div class="custom-option" style="cursor:default; color:var(--neutral)">No
                        match found</div>';
                    return;
                    }
                    list.forEach(c => {
                    const el = document.createElement('span');
                    el.className = 'custom-option';
                    if (this.state.selectedCountry && this.state.selectedCountry.name === c.name)
                    el.classList.add('selected');
                    el.innerHTML = `${c.flag} ${c.name} (${c.currency})`;
                    el.addEventListener('click', () => {
                    this.selectCountry(c);
                    if (document.getElementById('settingsModal').classList.contains('open'))
                    this.toggleModal('settingsModal');
                    document.querySelector('#settingsCountryDropdown').classList.remove('open');
                    document.querySelector('#countryDropdown').classList.remove('open');
                    });
                    container.appendChild(el);
                    });
                    },

                    selectCountry: function (country) {
                    this.state.selectedCountry = country;
                    const entryTrigger = document.querySelector('#countryDropdown .custom-select__trigger span');
                    if (entryTrigger) entryTrigger.innerHTML = `${country.flag} ${country.name} (${country.currency})`;
                    const settingsTrigger = document.querySelector('#settingsCountryDropdown .custom-select__trigger
                    span');
                    if (settingsTrigger) settingsTrigger.innerHTML = `${country.flag} ${country.name}
                    (${country.currency})`;
                    localStorage.setItem('ArthikaX_lastCountry', country.name); // Save Country Name to remember
                    document.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                    this.loadDenominations();
                    },

                    setTheme: function (theme) {
                    this.state.currentTheme = theme;
                    document.body.setAttribute('data-theme', theme);
                    document.documentElement.setAttribute('color-scheme', theme);
                    document.getElementById('themeSelect').value = theme;
                    localStorage.setItem('ArthikaX_theme', theme);
                    },
                    loadSettings: function () {
                    // Load Theme
                    const savedTheme = localStorage.getItem('ArthikaX_theme');
                    if (savedTheme) this.setTheme(savedTheme);

                    // Load Primary Color
                    const savedColor = localStorage.getItem('ArthikaX_primaryColor');
                    if (savedColor) this.setPrimaryColor(savedColor);

                    // Load Auto Delete
                    const autoDelete = localStorage.getItem('ArthikaX_autoDelete');
                    if (autoDelete !== null) {
                    this.state.autoDeleteEnabled = (autoDelete === 'true');
                    document.getElementById('autoDeleteToggle').checked = this.state.autoDeleteEnabled;
                    }
                    },
                    toggleModal: function (id) {
                    const modal = document.getElementById(id);
                    modal.classList.toggle('open');
                    },
                    switchTab: function (id) {
                    document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
                    document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
                    document.getElementById(id).classList.add('active');

                    const btnIndex = ['home', 'entry', 'history', 'outstanding', 'ledger'].indexOf(id);
                    if (btnIndex >= 0) document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');

                    if (id === 'history') this.renderHistory();
                    if (id === 'outstanding') {
                    this.updateDashboard();
                    this.renderOutstanding('all');
                    }
                    },

                    loadDenominations: function () {
                    const container = document.getElementById('denominationContainer');
                    container.innerHTML = '';
                    this.state.denominations = {};
                    this.state.selectedCountry.denominations.forEach(denom => {
                    this.state.denominations[denom] = 0;
                    const item = document.createElement('div');
                    item.className = 'denom-item';
                    item.innerHTML = `
                    <label class="denom-label">${denom}</label>
                    <input type="number" class="denom-input" min="0"
                        oninput="app.calculateTotal('${denom}', this.value)">
                    <span class="denom-subtotal" id="sub_${denom}">0</span>
                    `;
                    container.appendChild(item);
                    });
                    this.calculateTotal();
                    },
                    calculateTotal: function (denomChanged, val) {
                    if (denomChanged) this.state.denominations[denomChanged] = parseFloat(val) || 0;
                    let total = 0;
                    this.state.selectedCountry.denominations.forEach(d => {
                    const count = this.state.denominations[d];
                    total += (count * d);
                    const subEl = document.getElementById(`sub_${d}`);
                    if (subEl) subEl.textContent = (count * d).toLocaleString();
                    });
                    const symbol = this.state.selectedCountry.symbol;
                    document.getElementById('displayTotal').textContent = `${symbol} ${total.toLocaleString(undefined, {
                    minimumFractionDigits: 2 })}`;
                    document.getElementById('displayWords').textContent = this.numberToWords(total) + " " +
                    this.state.selectedCountry.currency;
                    },

                    saveRecord: function () {
                    if (!this.state.selectedCountry) {
                    this.showToast("Please select a country first in Settings.");
                    this.toggleModal('settingsModal');
                    return;
                    }

                    const nameInput = document.getElementById('entryName');
                    const nameValue = nameInput.value.trim();
                    if (nameValue === "") {
                    this.showToast("Please enter a Name (Mandatory Field).");
                    nameInput.classList.add('error');
                    nameInput.focus();
                    return;
                    } else {
                    nameInput.classList.remove('error');
                    }

                    let hasEntries = false;
                    let total = 0;

                    // Check Status first to determine validation logic
                    const status = document.getElementById('entryStatus').value;

                    // PARTIAL Logic
                    if (status === 'Partial') {
                    // Denomination IS MANDATORY for Partial (because cash is handled)
                    Object.keys(this.state.denominations).forEach(k => {
                    const count = this.state.denominations[k];
                    total += (k * count);
                    if (count > 0) hasEntries = true;
                    });
                    if (!hasEntries) {
                    this.showToast("Please enter Denominations for the received amount.");
                    return;
                    }
                    }
                    // DUE Logic
                    else if (status === 'Due') {
                    // Denomination NOT mandatory for Due
                    }
                    // PAID Logic
                    else {
                    // Paid: Denomination IS mandatory
                    Object.keys(this.state.denominations).forEach(k => {
                    const count = this.state.denominations[k];
                    total += (k * count);
                    if (count > 0) hasEntries = true;
                    });
                    if (!hasEntries) {
                    this.showToast("Denomination is Mandatory for Paid entries.");
                    return;
                    }
                    }

                    let type = 'income';

                    // Partial Payment data (will be null if not Partial)
                    let partialData = null;

                    if (status === 'Paid') {
                    // "Paid" is now ALWAYS Income (Money In)
                    type = 'income';
                    } else if (status === 'Partial') {
                    // Partial Payment Logic
                    const partialTotal = parseFloat(document.getElementById('partialTotalAmount').value) || 0;
                    const partialCollected = parseFloat(document.getElementById('partialCollectedAmount').value) || 0;
                    const partialBalance = partialTotal - partialCollected;
                    const partialDueType = document.querySelector('input[name="partialDueType"]:checked').value;

                    // Validation
                    if (partialTotal <= 0) { this.showToast("Please enter Total Bill Amount for Partial Payment.");
                        return; } if (partialCollected < 0) { this.showToast("Collected amount cannot be negative.");
                        return; } // VALIDATION: Denomination Total MUST match Collected Amount // 'total' currently
                        holds the sum of denominations calculated at the start if (Math.abs(total - partialCollected)>
                        1.0) {
                        this.showToast(`Denomination mismatch! Count: ${total}, Collected: ${partialCollected}`);
                        return;
                        }

                        type = (partialDueType === 'payable') ? 'expense' : 'income';

                        partialData = {
                        totalAmount: partialTotal,
                        collectedAmount: partialCollected,
                        balanceAmount: partialBalance,
                        dueType: partialDueType
                        };

                        // If balance < 0, it means overpayment (change return). // We still save as "Partial" type in
                            backend to preserve the specific calc details, // but functionally it is fully paid. // For
                            Partial, Record Total=Collected Amount (Cash Flow) total=partialCollected; } else { // Due
                            Logic const dueAmtInput=parseFloat(document.getElementById('dueTotalAmount').value) || 0; if
                            (dueAmtInput <=0) { this.showToast("Please enter a valid Due Amount.");
                            document.getElementById('dueTotalAmount').focus(); return; } total=dueAmtInput; // For Due,
                            Record Total=Due Amount const dueType=document.querySelector('input[name="dueType"
                            ]:checked').value; type=(dueType==='payable' ) ? 'expense' : 'income' ; } const record={ id:
                            Date.now(), type: type, status: status, country: this.state.selectedCountry.name, currency:
                            this.state.selectedCountry.currency, symbol: this.state.selectedCountry.symbol, date:
                            document.getElementById('entryDate').value, time:
                            document.getElementById('entryTime').value, name: nameValue, mobile:
                            document.getElementById('entryMobile').value || "" , tags: [...this.state.currentTags],
                            remarks: document.getElementById('entryRemarks').value || "" , denominations: {
                            ...this.state.denominations }, total: total, timestamp: Date.now() }; // Add partial payment
                            data if exists if (partialData) { record.partialPayment=partialData; }
                            this.state.records.push(record); this.state.records[this.state.records.length -
                            1].profileId=this.state.currentProfileId; // Encrypt if PIN is set, otherwise plain if
                            (window.currentPin && typeof CryptoUtil !=='undefined' ) { try { const
                            encrypted=CryptoUtil.encrypt(this.state.records, window.currentPin);
                            localStorage.setItem('ArthikaX_records', 'ENC:' + encrypted); } catch (e) {
                            localStorage.setItem('ArthikaX_records', JSON.stringify(this.state.records)); } } else {
                            localStorage.setItem('ArthikaX_records', JSON.stringify(this.state.records)); } // Immediate
                            refresh of all displays this.updateDashboard(); // Refresh Outstanding if active const
                            outTab=document.getElementById('outstanding'); if (outTab &&
                            outTab.classList.contains('active')) { this.renderOutstanding('all'); } // Refresh History
                            if active const histTab=document.getElementById('history'); if (histTab &&
                            histTab.classList.contains('active')) { this.renderHistory(); } // Auto-refresh Outstanding
                            if currently visible const outstandingSection=document.getElementById('outstanding'); if
                            (outstandingSection && outstandingSection.classList.contains('active')) {
                            this.renderOutstanding('all'); } this.showToast("Record Saved Successfully!");
                            this.resetForm(); }, loadRecords: function () { const
                            stored=localStorage.getItem('ArthikaX_records'); if (stored)
                            this.state.records=JSON.parse(stored); }, cleanupOldRecords: function () { if
                            (!this.state.autoDeleteEnabled) return; const now=Date.now(); const threeMonths=90 * 24 * 60
                            * 60 * 1000; const filtered=this.state.records.filter(r=> (now - r.timestamp) <
                                threeMonths); if (filtered.length < this.state.records.length) {
                                this.state.records=filtered; localStorage.setItem('ArthikaX_records',
                                JSON.stringify(this.state.records)); } }, resetForm: function () { if
                                (this.state.selectedCountry) this.loadDenominations();
                                document.getElementById('entryName').value="" ;
                                document.getElementById('entryName').classList.remove('error');
                                document.getElementById('entryMobile').value="" ;
                                document.getElementById('entryRemarks').value="" ; this.state.currentTags=[];
                                this.renderTags(); document.getElementById('entryStatus').value='Paid' ; //
                                document.getElementById('entryPayable').checked=false; // REMOVED
                                document.querySelector('input[name="dueType" ][value="receivable" ]').checked=true; //
                                Reset Partial Payment fields document.getElementById('partialTotalAmount').value="" ;
                                document.getElementById('partialCollectedAmount').value="" ;
                                document.getElementById('partialBalanceAmount').value="" ;
                                document.querySelector('input[name="partialDueType" ][value="receivable"
                                ]').checked=true; // Reset Due Amount const
                                dueAmtEntry=document.getElementById('dueTotalAmount'); if (dueAmtEntry)
                                dueAmtEntry.value="" ; this.handleStatusChange(); const now=new Date();
                                document.getElementById('entryDate').valueAsDate=now;
                                document.getElementById('entryTime').value=now.toTimeString().substring(0, 5); },
                                /*=========================================PROFESSIONAL INVOICE DOWNLOAD
                                LOGIC=========================================*/ downloadInvoice: function (id) { const
                                r=this.state.records.find(rec=> rec.id === id);
                                if (!r) return;

                                const symbol = r.symbol;
                                const currency = r.currency;
                                const totalInWords = this.numberToWords(r.total) + " " + r.currency;
                                const itemsDesc = (r.tags && r.tags.length > 0) ? 'Items: ' + r.tags.join(', ') :
                                (r.remarks || "Payment Received");

                                // Status handling for Partial Payment
                                let statusText = r.status === 'Paid' ? "PAID" : (r.status === 'Partial' ? "PARTIAL
                                PAYMENT" : "DUE");
                                let statusColor = r.status === 'Paid' ? "#2e7d32" : (r.status === 'Partial' ? "#ff9800"
                                : "#c62828");
                                const invoiceNo = "#INV-" + r.id.toString().slice(-6);

                                // Partial Payment Section (only show if status is Partial)
                                let partialSection = '';
                                if (r.status === 'Partial' && r.partialPayment) {
                                const pp = r.partialPayment;
                                partialSection = `
                                <div
                                    style="background:#fff3e0; padding:15px; border-radius:8px; margin-top:20px; border-left:4px solid #ff9800;">
                                    <div style="font-weight:700; color:#e65100; margin-bottom:10px; font-size:14px;">
                                        Payment Summary</div>
                                    <table style="width:100%; font-size:13px;">
                                        <tr>
                                            <td style="padding:5px 0; color:#555;">Total Bill Amount:</td>
                                            <td style="padding:5px 0; text-align:right; font-weight:600;">${symbol}
                                                ${pp.totalAmount.toLocaleString()}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding:5px 0; color:#555;">Amount Received:</td>
                                            <td
                                                style="padding:5px 0; text-align:right; font-weight:600; color:#2e7d32;">
                                                ${symbol} ${pp.collectedAmount.toLocaleString()}</td>
                                        </tr>
                                        <tr style="border-top:1px solid #ddd;">
                                            <td style="padding:8px 0 5px 0; color:#c62828; font-weight:700;">Outstanding
                                                Balance:</td>
                                            <td
                                                style="padding:8px 0 5px 0; text-align:right; font-weight:700; color:#c62828; font-size:15px;">
                                                ${symbol} ${pp.balanceAmount.toLocaleString()}</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"
                                                style="padding-top:8px; font-size:11px; color:#666; font-style:italic;">
                                                ${pp.dueType === 'receivable' ? ' Customer will pay the balance' : '
                                                I have to pay the balance'}
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                `;
                                }

                                const isDaily = r.name === 'Daily Cash Collection';
                                const docTitle = isDaily ? "Cash Collection Slip" : "Invoice";

                                // --- 1. BILL TO SECTION (Hide for Daily Collection) ---
                                let billToSection = '';
                                if (!isDaily) {
                                billToSection = `
                                <div class="inv-bill-to">
                                    <div class="inv-bill-label">Bill To</div>
                                    <div class="inv-cust-name">${r.name}</div>
                                    <div class="inv-cust-details">
                                        ${r.mobile ? 'Mobile: ' + r.mobile + '<br>' : ''}
                                        ${r.remarks ? 'Note: ' + r.remarks : ''}
                                    </div>
                                </div>`;
                                } else {
                                // Show Date/Time for Daily Collection
                                billToSection = `
                                <div class="inv-bill-to">
                                    <div class="inv-bill-label">Summary Details</div>
                                    <div class="inv-cust-details">
                                        Generated on: ${this.formatDisplayDateTime()}<br>
                                        Type: ${isDaily ? 'Internal Cash Closing' : 'Transaction'}
                                    </div>
                                </div>`;
                                }

                                // --- 2. TABLE CONTENT ---
                                let tableHeader = '';
                                let tableBody = '';

                                if (r.denominations && Object.keys(r.denominations).length > 0) {
                                // DENOMINATION TABLE
                                tableHeader = `
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Denomination Breakdown</th>
                                    <th style="width: 120px; text-align: right;">Amount</th>
                                </tr>`;

                                // Sort denominations high to low
                                const denoms = Object.entries(r.denominations)
                                .filter(([val, count]) => count > 0)
                                .sort((a, b) => Number(b[0]) - Number(a[0]));

                                denoms.forEach(([val, count], index) => {
                                const subTotal = val * count;
                                tableBody += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td><strong>${symbol} ${Number(val).toLocaleString()} x ${count}</strong></td>
                                    <td class="text-right">${symbol} ${subTotal.toLocaleString()}</td>
                                </tr>`;
                                });

                                } else {
                                // STANDARD ITEM TABLE
                                tableHeader = `
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Description</th>
                                    <th style="width: 120px; text-align: right;">Amount</th>
                                </tr>`;

                                tableBody = `
                                <tr>
                                    <td>1</td>
                                    <td><strong>${itemsDesc}</strong><br><span
                                            style="font-size:11px; color:#888;">Transaction ID: ${r.id}</span></td>
                                    <td class="text-right">${symbol} ${r.total.toLocaleString()}</td>
                                </tr>`;
                                }

                                const invoiceHTML = `
                                <div class="invoice-layout">
                                    <!-- Professional Header -->
                                    <div class="inv-header">
                                        <div class="inv-brand-info">
                                            <div
                                                style="display:flex; align-items:center; gap:15px; margin-bottom:10px;">
                                                <img src="logo.png" style="width:50px; height:50px;" alt="Logo"
                                                    onerror="this.style.display='none'">
                                                <h1>ArthikaX</h1>
                                            </div>
                                            <p>Professional Khata Book & Ledger</p>
                                        </div>

                                        <div class="inv-title-section">
                                            <div class="inv-title" style="${isDaily ? 'font-size: 24px;' : ''}">
                                                ${docTitle}</div>
                                            <div class="inv-meta-grid">
                                                <div class="inv-meta-label">Ref No:</div>
                                                <div class="inv-meta-value">${invoiceNo}</div>

                                                <div class="inv-meta-label">Date:</div>
                                                <div class="inv-meta-value">${this.formatDisplayDate(r.date)}</div>

                                                <div class="inv-meta-label">Status:</div>
                                                <div class="inv-meta-value" style="color:${statusColor}">${statusText}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Dynamic Section (Bill To or Details) -->
                                    ${billToSection}

                                    <!-- Items / Denom Table -->
                                    <table class="inv-table">
                                        <thead>${tableHeader}</thead>
                                        <tbody>
                                            ${tableBody}
                                            <tr class="inv-total-row">
                                                <td colspan="${isDaily ? 2 : 2}" class="text-right">Total Collection
                                                </td>
                                                <td class="text-right">${symbol} ${r.total.toLocaleString()}</td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <!-- Amount in Words -->
                                    <div class="inv-words">
                                        <strong>Amount in Words:</strong> ${totalInWords}
                                    </div>

                                    <!-- Partial Payment Section (if applicable) -->
                                    ${partialSection}

                                    <!-- Signature -->
                                    <div class="inv-sign">
                                        <div class="inv-sign-line">Authorized Signature</div>
                                    </div>

                                    <!-- Footer -->
                                    <div class="inv-footer-note">
                                        Thank you for your business.<br>
                                        Generated by ArthikaX | https://pintusikder.github.io/ArthikaX/
                                    </div>
                                </div>
                                `;

                                document.getElementById('print-area').innerHTML = invoiceHTML;
                                window.print();
                                },

                                /* =========================================
                                PROFESSIONAL PDF REPORT LOGIC
                                ========================================= */
                                formatDisplayDate: function (dateStr) {
                                const d = new Date(dateStr);
                                return d.toLocaleDateString('en-GB'); // DD/MM/YYYY format
                                },
                                formatDisplayDateTime: function () {
                                const now = new Date();
                                return now.toLocaleString('en-GB'); // DD/MM/YYYY, HH:mm
                                },

                                generatePDFReport: function (records, title, dateRangeStr) {
                                if (records.length === 0) {
                                this.showToast("No transactions available for selected period");
                                return;
                                }

                                const symbol = this.state.selectedCountry ? this.state.selectedCountry.symbol : '';
                                const currency = this.state.selectedCountry ? this.state.selectedCountry.currency : '';

                                // CALCULATIONS
                                let totalIncome = 0;
                                let totalExpense = 0;
                                let totalReceivable = 0;
                                let totalPayable = 0;
                                let netBalance = 0;

                                const tableRows = records.map((r, index) => {
                                let incomeVal = r.type === 'income' ? r.total : 0;
                                let expenseVal = r.type === 'expense' ? r.total : 0;

                                totalIncome += incomeVal;
                                totalExpense += expenseVal;

                                // Determine Color Class
                                let rowClass = '';
                                let statusDisplay = '';

                                if (r.status === 'Paid') {
                                rowClass = 'row-green';
                                statusDisplay = 'Paid';
                                } else {
                                if (r.type === 'expense') {
                                rowClass = 'row-orange'; // Payable
                                statusDisplay = 'Due (Payable)';
                                totalPayable += r.total;
                                } else {
                                rowClass = 'row-red'; // Receivable
                                statusDisplay = 'Due (Receivable)';
                                totalReceivable += r.total;
                                }
                                }

                                const amountInWords = this.numberToWords(r.total);
                                const typeDisplay = r.type === 'income' ? 'Income' : 'Expense';

                                // Item Tags
                                const tagDisplay = r.tags && r.tags.length > 0 ? `<br><small style="color:#666">Items:
                                    ${r.tags.join(', ')}</small>` : '';

                                return `
                                <tr class="${rowClass}">
                                    <td>${index + 1}</td>
                                    <td>${this.formatDisplayDate(r.date)}</td>
                                    <td>${r.time}</td>
                                    <td>
                                        <strong>${r.name}</strong>
                                        ${tagDisplay}
                                        ${r.mobile ? `<br><small>${r.mobile}</small>` : ''}
                                    </td>
                                    <td>${r.remarks || '-'}</td>
                                    <td>${typeDisplay}</td>
                                    <td>${incomeVal > 0 ? symbol + ' ' + incomeVal.toLocaleString() : '-'}</td>
                                    <td>${expenseVal > 0 ? symbol + ' ' + expenseVal.toLocaleString() : '-'}</td>
                                    <td class="font-bold">${symbol} ${r.total.toLocaleString()}</td>
                                    <td><small>${amountInWords} ${currency}</small></td>
                                    <td><strong>${statusDisplay}</strong></td>
                                </tr>
                                `;
                                }).join('');

                                netBalance = totalIncome - totalExpense;

                                const generatedOn = this.formatDisplayDateTime();

                                const htmlContent = `
                                <div class="pdf-header">
                                    <div class="pdf-logo-area">
                                        <img src="logo.png" class="pdf-logo" alt="Logo"
                                            onerror="this.style.display='none'">
                                        <div class="pdf-title-block">
                                            <h1>ArthikaX</h1>
                                            <h2>${title}</h2>
                                        </div>
                                    </div>
                                    <div class="pdf-meta">
                                        <strong>Date Range:</strong><br>
                                        ${dateRangeStr}<br><br>
                                        <strong>Generated On:</strong><br>
                                        ${generatedOn}
                                    </div>
                                </div>

                                <table class="pdf-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 30px;">Sl No</th>
                                            <th style="width: 70px;">Date</th>
                                            <th style="width: 60px;">Time</th>
                                            <th style="width: 150px;">Name / Party</th>
                                            <th style="width: 120px;">Remarks / Notes</th>
                                            <th style="width: 60px;">Type</th>
                                            <th>Income</th>
                                            <th>Expense</th>
                                            <th>Amount</th>
                                            <th>Words</th>
                                            <th style="width: 100px;">Payment Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>

                                <div class="pdf-summary-box">
                                    <div class="pdf-summary-row">
                                        <span class="pdf-summary-label">Total Income:</span>
                                        <span class="pdf-summary-val" style="color:green">${symbol}
                                            ${totalIncome.toLocaleString()}</span>
                                    </div>
                                    <div class="pdf-summary-row">
                                        <span class="pdf-summary-label">Total Expense:</span>
                                        <span class="pdf-summary-val" style="color:red">${symbol}
                                            ${totalExpense.toLocaleString()}</span>
                                    </div>
                                    <div class="pdf-summary-row">
                                        <span class="pdf-summary-label">Total Receivable (Due - Income):</span>
                                        <span class="pdf-summary-val" style="color:#b71c1c">${symbol}
                                            ${totalReceivable.toLocaleString()}</span>
                                    </div>
                                    <div class="pdf-summary-row">
                                        <span class="pdf-summary-label">Total Payable (Due - Expense):</span>
                                        <span class="pdf-summary-val" style="color:#e65100">${symbol}
                                            ${totalPayable.toLocaleString()}</span>
                                    </div>
                                    <div class="pdf-summary-row">
                                        <span class="pdf-summary-label">Net Balance (Income - Expense):</span>
                                        <span class="pdf-summary-val">${symbol} ${netBalance.toLocaleString()}</span>
                                    </div>
                                </div>

                                <div class="pdf-footer">
                                    https://pintusikder.github.io/ArthikaX/
                                </div>
                                `;

                                document.getElementById('print-area').innerHTML = htmlContent;
                                window.print();
                                },

                                exportLast30Days: function () {
                                const today = new Date();
                                const thirtyDaysAgo = new Date();
                                thirtyDaysAgo.setDate(today.getDate() - 30);

                                // Get date strings (YYYY-MM-DD) to avoid timezone issues
                                const todayStr = today.toISOString().split('T')[0];
                                const startStr = thirtyDaysAgo.toISOString().split('T')[0];

                                // Filter records by comparing strings directly
                                const filtered = this.state.records.filter(r => {
                                return r.date >= startStr && r.date <= todayStr; }); if (filtered.length===0) {
                                    this.showToast("No transactions in last 30 days."); return; } const rangeStr=`From:
                                    ${this.formatDisplayDate(startStr)} To: ${this.formatDisplayDate(todayStr)}`;
                                    this.generatePDFReport(filtered, "30 Days Transaction Report" , rangeStr); },
                                    openRangeModal: function () { this.toggleModal('dateRangeModal'); },
                                    generateRangeReport: function () { const
                                    startStr=document.getElementById('rangeStart').value; const
                                    endStr=document.getElementById('rangeEnd').value; if (!startStr || !endStr) {
                                    this.showToast("Please select both dates."); return; } if (startStr> endStr) {
                                    this.showToast("Invalid date range.");
                                    return;
                                    }

                                    // FIX: Compare strings directly (YYYY-MM-DD) to avoid timezone conversion bugs
                                    // No need to create Date objects which are susceptible to local vs UTC offsets.
                                    const source = this.state.filters.source; // GET CURRENT FILTER SOURCE

                                    const filtered = this.state.records.filter(r => {
                                    // 1. Check Date Range
                                    if (!(r.date >= startStr && r.date <= endStr)) return false; // 2. Check Source
                                        Filter if (source==='entry' && r.name==='Daily Cash Collection' ) return false;
                                        if (source==='collection' && r.name !=='Daily Cash Collection' ) return false;
                                        return true; }); if (filtered.length===0) { this.showToast("No records found for
                                        this range."); this.toggleModal('dateRangeModal'); return; } const
                                        startDisplay=this.formatDisplayDate(startStr); const
                                        endDisplay=this.formatDisplayDate(endStr); const rangeDisplay=`From:
                                        ${startDisplay} To: ${endDisplay}`;
                                        this.generatePDFReport(filtered, "Transaction Report (Date Range)" ,
                                        rangeDisplay); this.toggleModal('dateRangeModal'); }, renderOutstanding:
                                        function (filterType) { // If filterType is strictly 'all' , 'receivable'
                                        or 'payable' , store it or use existing logic. // But since we use
                                        onchange="app.renderOutstanding()" , filterType might be undefined. // We need
                                        to preserve the active filter tab state. let activeFilter='all' ; const
                                        btnAll=document.getElementById('btn-out-all'); const
                                        btnRec=document.getElementById('btn-out-rec'); const
                                        btnPay=document.getElementById('btn-out-pay'); // Determine current active
                                        filter if not passed explicitly if (!filterType) { if (btnRec &&
                                        btnRec.classList.contains('active')) activeFilter='receivable' ; else if (btnPay
                                        && btnPay.classList.contains('active')) activeFilter='payable' ; } else {
                                        activeFilter=filterType; } // Update Active Button State if (btnAll)
                                        btnAll.classList.remove('active'); if (btnRec)
                                        btnRec.classList.remove('active'); if (btnPay)
                                        btnPay.classList.remove('active'); if (activeFilter==='receivable' && btnRec)
                                        btnRec.classList.add('active'); else if (activeFilter==='payable' && btnPay)
                                        btnPay.classList.add('active'); else if (btnAll) btnAll.classList.add('active');
                                        const list=document.getElementById('outstandingList'); const
                                        empty=document.getElementById('outstandingEmpty'); list.innerHTML='' ; // FIX:
                                        Include both Due and valid Partial records (Positive=Debt, Negative=Return to
                                        Pay) let dues=this.getProfileRecords().filter(r=> {
                                        if (r.status === 'Due') return true;
                                        if (r.status === 'Partial' && r.partialPayment && r.partialPayment.balanceAmount
                                        != 0) return true;
                                        return false;
                                        });

                                        // Filter by Type (Receivable/Payable)
                                        if (activeFilter === 'receivable') {
                                        dues = dues.filter(r => {
                                        if (r.status === 'Due') return r.type === 'income';
                                        if (r.status === 'Partial') return r.partialPayment.dueType === 'receivable';
                                        return false;
                                        });
                                        } else if (activeFilter === 'payable') {
                                        dues = dues.filter(r => {
                                        if (r.status === 'Due') return r.type === 'expense';
                                        if (r.status === 'Partial') return r.partialPayment.dueType === 'payable';
                                        return false;
                                        });
                                        }

                                        if (dues.length === 0) {
                                        empty.style.display = 'block';
                                        } else {
                                        empty.style.display = 'none';

                                        // SORTING LOGIC FOR OUTSTANDING
                                        const sortSelect = document.getElementById('outstandingSort');
                                        const sortMode = sortSelect ? sortSelect.value : 'amount-desc'; // Default High
                                        to Low

                                        dues.sort((a, b) => {
                                        // Helper to get effective balance for sorting
                                        const getBalance = (r) => {
                                        if (r.status === 'Due') return r.total;
                                        if (r.status === 'Partial' && r.partialPayment) return
                                        Math.abs(r.partialPayment.balanceAmount); // Use Abs for Returns
                                        return 0;
                                        };

                                        if (sortMode === 'amount-desc') return getBalance(b) - getBalance(a);
                                        if (sortMode === 'amount-asc') return getBalance(a) - getBalance(b);
                                        if (sortMode === 'date-desc') return b.timestamp - a.timestamp;
                                        if (sortMode === 'date-asc') return a.timestamp - b.timestamp;
                                        return getBalance(b) - getBalance(a);
                                        });

                                        dues.forEach(r => {
                                        const li = document.createElement('li');
                                        li.className = 'history-item';

                                        // Determine Display Data based on Status
                                        let typeBadge = '';
                                        let amountClass = '';
                                        let displayAmount = 0;
                                        let isReceivable = false;

                                        if (r.status === 'Due') {
                                        isReceivable = (r.type === 'income');
                                        // Use standard classes: receivable(green), expense(orange)
                                        typeBadge = isReceivable
                                        ? '<span class="badge receivable">Receivable</span>'
                                        : '<span class="badge expense">Payable</span>';
                                        amountClass = isReceivable ? 'amount-income' : 'amount-expense'; // Green for
                                        Rec, Orange for Pay
                                        displayAmount = r.total;
                                        } else {
                                        // Partial
                                        isReceivable = (r.partialPayment.dueType === 'receivable');

                                        // Explicit Type Badge Logic
                                        if (r.partialPayment.dueType === 'receivable') {
                                        typeBadge = '<span class="badge receivable">Partial (Rec)</span>';
                                        amountClass = 'amount-income';
                                        displayAmount = r.partialPayment.balanceAmount;
                                        } else {
                                        typeBadge = '<span class="badge expense">Partial (Pay)</span>';
                                        amountClass = 'amount-expense';

                                        // If negative, show positive value
                                        if (r.partialPayment.balanceAmount < 0) {
                                            displayAmount=Math.abs(r.partialPayment.balanceAmount); typeBadge=`<span
                                            class="badge expense">Return: ${displayAmount}</span>`;
                                            } else {
                                            displayAmount = r.partialPayment.balanceAmount;
                                            }
                                            }
                                            }

                                            li.innerHTML = `
                                            <div class="h-left">
                                                <span class="h-name">${typeBadge} ${r.name}</span>
                                                <div class="h-details">
                                                    <div class="h-detail-row"><span></span> <span>${r.date}</span>
                                                    </div>
                                                    <div class="h-detail-row"><span></span> <span>${r.remarks || 'No
                                                            remarks'}</span></div>
                                                </div>
                                            </div>
                                            <div class="h-right">
                                                <span class="h-amount ${amountClass}">${r.symbol}
                                                    ${displayAmount.toLocaleString()}</span>
                                                <div style="font-size:0.75rem; opacity:0.7; text-align:right;">(Bal)
                                                </div>
                                                <button class="btn btn-success"
                                                    style="margin-top:5px; padding:4px 8px; font-size:0.8rem;"
                                                    onclick="app.settleDue(${r.id})">Mark Paid</button>
                                            </div>
                                            `;
                                            list.appendChild(li);
                                            });
                                            }
                                            },

                                            numberToWords: function (n) {
                                            if (n < 0) return "Negative " + this.numberToWords(Math.abs(n)); if (n===0)
                                                return "Zero" ; const belowTwenty=["", "One" , "Two" , "Three" , "Four"
                                                , "Five" , "Six" , "Seven" , "Eight" , "Nine" , "Ten" , "Eleven"
                                                , "Twelve" , "Thirteen" , "Fourteen" , "Fifteen" , "Sixteen"
                                                , "Seventeen" , "Eighteen" , "Nineteen" ]; const tens=["", "" , "Twenty"
                                                , "Thirty" , "Forty" , "Fifty" , "Sixty" , "Seventy" , "Eighty"
                                                , "Ninety" ]; const translate=(n)=> {
                                                if (n < 20) return belowTwenty[n]; if (n < 100) return tens[Math.floor(n
                                                    / 10)] + (n % 10 ? " " + belowTwenty[n % 10] : "" ); if (n < 1000)
                                                    return belowTwenty[Math.floor(n / 100)] + " Hundred" + (n % 100
                                                    ? " " + translate(n % 100) : "" ); return "" ; }; let word="" ; if
                                                    (n>= 10000000) { word += translate(Math.floor(n / 10000000)) + "
                                                    Crore "; n %= 10000000; }
                                                    if (n >= 100000) { word += translate(Math.floor(n / 100000)) + "
                                                    Lakh "; n %= 100000; }
                                                    if (n >= 1000) { word += translate(Math.floor(n / 1000)) + "
                                                    Thousand "; n %= 1000; }
                                                    word += translate(n);
                                                    return word.trim();
                                                    },

                                                    showDailyCollection: function () {
                                                    const today = new Date().toISOString().split('T')[0];
                                                    const list = document.getElementById('dailyCollectionList');
                                                    const statsContainer =
                                                    document.getElementById('dailyStatsContainer');
                                                    const quickGrid = document.getElementById('quickCashGrid');
                                                    const quickTotal = document.getElementById('quickCashTotal');
                                                    const quickWords = document.getElementById('quickCashWords');

                                                    list.innerHTML = '';
                                                    statsContainer.innerHTML = '';
                                                    quickGrid.innerHTML = '';
                                                    if (quickTotal) quickTotal.textContent = '0';
                                                    if (quickWords) quickWords.textContent = 'Zero Only';
                                                    window.currentQuickDenominations = {};

                                                    // --- 1. GENERATE STATS ---
                                                    let totalIncome = 0;
                                                    let totalReceivable = 0;
                                                    let totalPayable = 0;

                                                    this.state.records.forEach(r => {
                                                    if (r.date === today) {
                                                    if (r.type === 'income') {
                                                    if (r.status === 'Paid') totalIncome += r.total;
                                                    else if (r.status === 'Due') totalReceivable += r.total;
                                                    else if (r.status === 'Partial') {
                                                    totalIncome += (r.collectedAmount || 0);
                                                    if (r.partialPayment.dueType === 'receivable') totalReceivable +=
                                                    r.partialPayment.balanceAmount;
                                                    }
                                                    } else {
                                                    // Expense
                                                    if (r.status === 'Due') totalPayable += r.total;
                                                    else if (r.status === 'Partial') {
                                                    if (r.partialPayment.dueType === 'payable') totalPayable +=
                                                    r.partialPayment.balanceAmount;
                                                    }
                                                    }
                                                    }
                                                    });

                                                    // Render Stats
                                                    statsContainer.innerHTML = `
                                                    <div
                                                        style="background:var(--bg-income); padding:5px; border-radius:6px; text-align:center;">
                                                        <div
                                                            style="font-size:0.65rem; color:var(--text-income); font-weight:600; text-transform:uppercase;">
                                                            Income</div>
                                                        <div
                                                            style="font-weight:700; font-size:0.9rem; color:var(--text-income);">
                                                            ${totalIncome.toLocaleString()}</div>
                                                    </div>
                                                    <div
                                                        style="background:var(--bg-income); padding:5px; border-radius:6px; text-align:center;">
                                                        <div
                                                            style="font-size:0.65rem; color:var(--text-income); font-weight:600; text-transform:uppercase;">
                                                            To Receive</div>
                                                        <div
                                                            style="font-weight:700; font-size:0.9rem; color:var(--text-income);">
                                                            ${totalReceivable.toLocaleString()}</div>
                                                    </div>
                                                    <div
                                                        style="background:var(--bg-expense); padding:5px; border-radius:6px; text-align:center;">
                                                        <div
                                                            style="font-size:0.65rem; color:var(--text-expense); font-weight:600; text-transform:uppercase;">
                                                            To Pay</div>
                                                        <div
                                                            style="font-weight:700; font-size:0.9rem; color:var(--text-expense);">
                                                            ${totalPayable.toLocaleString()}</div>
                                                    </div>
                                                    `;

                                                    // --- 2. GENERATE QUICK CASH GRID ---
                                                    const profileId = this.state.currentProfileId;
                                                    const profile = this.state.profiles.find(p => p.id === profileId);
                                                    const countryName = profile && profile.country ? profile.country :
                                                    localStorage.getItem('ArthikaX_lastCountry');
                                                    let country = this.state.config.find(c => c.name === countryName) ||
                                                    this.state.config[0];

                                                    country.denominations.slice().reverse().forEach(denom => {
                                                    const div = document.createElement('div');
                                                    // Use Theme Vars for background
                                                    div.style.cssText = "display:flex; align-items:center; gap:5px;
                                                    background:var(--card-bg); padding:4px; border:1px solid
                                                    var(--border); border-radius:4px;";
                                                    div.innerHTML = `
                                                    <span
                                                        style="font-weight:600; min-width:35px; font-size:0.8rem; text-align:right;">${denom}</span>
                                                    <input type="number" class="form-control"
                                                        style="height:28px; padding:2px 5px; font-size:0.9rem; background:var(--input-bg); color:var(--text-main);"
                                                        placeholder="0" min="0"
                                                        oninput="app.updateQuickTotal(this, ${denom})">
                                                    `;
                                                    quickGrid.appendChild(div);
                                                    });


                                                    // --- 3. RENDER COLLECTIONS LIST (Existing Logic) ---
                                                    const todayRecords = this.state.records.filter(r => {
                                                    if (r.date !== today) return false;
                                                    if (r.type === 'expense') return false;
                                                    if (r.status === 'Paid') return true;
                                                    if (r.status === 'Partial' && (r.collectedAmount || 0) > 0) return
                                                    true;
                                                    return false;
                                                    });

                                                    if (todayRecords.length === 0) {
                                                    list.innerHTML = '<p class="text-center"
                                                        style="color:var(--neutral); padding:10px; font-size:0.9rem;">No
                                                        cash collected today.</p>';
                                                    } else {
                                                    const collections = {};
                                                    todayRecords.forEach(r => {
                                                    const currency = r.symbol;
                                                    if (!collections[currency]) collections[currency] = { total: 0,
                                                    notes: {} };
                                                    let amount = 0;
                                                    if (r.status === 'Paid') amount = r.total;
                                                    else if (r.status === 'Partial') amount = r.collectedAmount || 0;

                                                    collections[currency].total += amount;
                                                    if (r.denominations) {
                                                    for (const [denom, count] of Object.entries(r.denominations)) {
                                                    if (!collections[currency].notes[denom])
                                                    collections[currency].notes[denom] = 0;
                                                    collections[currency].notes[denom] += count; // Simple addition
                                                    }
                                                    }
                                                    });

                                                    let html = '';
                                                    // SORTING: Display highest collection first
                                                    const sortedCollections = Object.entries(collections).sort((a, b) =>
                                                    b[1].total - a[1].total);

                                                    for (const [symbol, data] of sortedCollections) {
                                                    // Use vars for bg - Force card-bg for proper Dark Mode
                                                    html += `<div class="card"
                                                        style="margin-bottom:10px; background: var(--card-bg); border: 1px solid var(--border); padding:10px;">
                                                        `;
                                                        html += `<h3
                                                            style="color:var(--primary); border-bottom:1px solid var(--border); padding-bottom:5px; margin:0 0 10px 0; font-size:1rem;">
                                                            ${symbol} Collection</h3>`;
                                                        html += `<table style="width:100%; font-size:0.85rem;">`;
                                                            html += `<tr style="color:var(--neutral); text-align:left;">
                                                                <th>Note</th>
                                                                <th>Count</th>
                                                                <th style="text-align:right;">Total</th>
                                                            </tr>`;
                                                            const notes = Object.entries(data.notes).sort((a, b) =>
                                                            Number(b[0]) - Number(a[0]));
                                                            let calcTotal = 0;
                                                            notes.forEach(([val, count]) => {
                                                            const sub = val * count;
                                                            calcTotal += sub;
                                                            html += `<tr>
                                                                <td>${val}</td>
                                                                <td>${count}</td>
                                                                <td style="text-align:right;">${sub.toLocaleString()}
                                                                </td>
                                                            </tr>`;
                                                            });
                                                            html += `</table>`;
                                                        if (calcTotal !== data.total) { // Approx check
                                                        html += `<div
                                                            style="text-align:right; margin-top:5px; font-size:0.75rem; color:#d32f2f;">
                                                            Manual mismatch: ${(data.total -
                                                            calcTotal).toLocaleString()}</div>`;
                                                        }
                                                        html += `<div
                                                            style="text-align:right; margin-top:5px; font-size:1rem; font-weight:bold; color:var(--text-income);">
                                                            Total: ${symbol} ${data.total.toLocaleString()}</div>`;
                                                        html += `</div>`;
                                                    }
                                                    list.innerHTML = html;
                                                    }

                                                    document.getElementById('dailyCollectionModal').classList.add('open');
                                                    },

                                                    updateQuickTotal: function (input, denom) {
                                                    const count = parseInt(input.value) || 0;
                                                    window.currentQuickDenominations[denom] = count;

                                                    let total = 0;
                                                    for (const [d, c] of
                                                    Object.entries(window.currentQuickDenominations)) {
                                                    total += (Number(d) * c);
                                                    }
                                                    const el = document.getElementById('quickCashTotal');
                                                    const wordsEl = document.getElementById('quickCashWords');

                                                    // Get Current Currency Info
                                                    const profileId = this.state.currentProfileId;
                                                    const profile = this.state.profiles.find(p => p.id === profileId);
                                                    const countryName = profile && profile.country ? profile.country :
                                                    localStorage.getItem('ArthikaX_lastCountry');
                                                    let country = this.state.config.find(c => c.name === countryName) ||
                                                    this.state.config[0];
                                                    const symbol = country.symbol;
                                                    const currencyName = country.name === 'India' ? 'Rupees' :
                                                    country.currency; // Simple logic, or extend config

                                                    if (el) el.textContent = symbol + " " + total.toLocaleString();
                                                    if (wordsEl) wordsEl.textContent = total > 0 ?
                                                    (this.numberToWords(total) + " " + currencyName + " Only") : 'Zero
                                                    Only';
                                                    },

                                                    saveQuickCollection: function () {
                                                    console.log(' saveQuickCollection function called!');
                                                    // Validate Country/Currency Selection First
                                                    const profileId = this.state.currentProfileId;
                                                    const profile = this.state.profiles.find(p => p.id === profileId);
                                                    const countryName = profile && profile.country ? profile.country :
                                                    localStorage.getItem('ArthikaX_lastCountry');

                                                    if (!countryName) {
                                                    console.log(' ERROR: No country selected');
                                                    alert(' Please select Country & Currency first from Settings!');
                                                    this.showToast(' Please select Country & Currency first from
                                                    Settings');
                                                    setTimeout(() => {
                                                    this.toggleModal('settingsModal');
                                                    }, 1500);
                                                    return;
                                                    }

                                                    // Initialize if undefined (safety check)
                                                    if (!window.currentQuickDenominations) {
                                                    window.currentQuickDenominations = {};
                                                    }

                                                    let total = 0;
                                                    for (const [d, c] of
                                                    Object.entries(window.currentQuickDenominations)) {
                                                    total += (Number(d) * c);
                                                    }

                                                    console.log(' Total calculated:', total);

                                                    if (total <= 0) { console.log(' ERROR: Total is zero or negative');
                                                        alert(' Please enter some amount in the denomination
                                                        fields!'); this.showToast(' Please enter amount'); return; }
                                                        const now=new Date(); let country=this.state.config.find(c=>
                                                        c.name === countryName) || this.state.config[0];

                                                        const record = {
                                                        id: Date.now(),
                                                        date: now.toISOString().split('T')[0],
                                                        time: now.toTimeString().substring(0, 5),
                                                        name: "Daily Cash Collection",
                                                        mobile: "",
                                                        type: "income",
                                                        total: total,
                                                        remarks: "Quick Entry",
                                                        status: "Paid",
                                                        country: country.name,
                                                        currency: country.currency,
                                                        denominations: { ...window.currentQuickDenominations },
                                                        timestamp: now.getTime(),
                                                        symbol: country.symbol,
                                                        profileId: this.state.currentProfileId
                                                        };

                                                        this.state.records.push(record);
                                                        localStorage.setItem('ArthikaX_records',
                                                        JSON.stringify(this.state.records));
                                                        this.updateDashboard();
                                                        this.renderHistory();

                                                        console.log(' Record saved successfully! Showing alert...');

                                                        // Show success message with amount - MORE PROMINENT
                                                        alert(' Success!\n\nCash Entry Saved!\nAmount: ' +
                                                        country.symbol + ' ' + total.toLocaleString() + '\n\nYour entry
                                                        has been saved successfully.');

                                                        console.log('Showing toast notification...');
                                                        // Also show toast for subtle notification
                                                        this.showToast(' Saved: ' + country.symbol + ' ' +
                                                        total.toLocaleString());

                                                        console.log('Refreshing modal to reset form...');
                                                        // Refresh Modal to show new entry immediately
                                                        this.showDailyCollection();

                                                        console.log(' saveQuickCollection completed successfully!');
                                                        },


                                                        settleDue: function (id) {
                                                        if (confirm('Mark this record as Paid/Cleared today?')) {
                                                        const rIndex = this.state.records.findIndex(r => r.id === id);
                                                        if (rIndex > -1) {
                                                        this.state.records[rIndex].status = 'Paid';
                                                        localStorage.setItem('ArthikaX_records',
                                                        JSON.stringify(this.state.records));
                                                        this.updateDashboard();
                                                        this.renderOutstanding('all');
                                                        this.showToast('Record marked as Paid!');
                                                        }
                                                        }
                                                        },

                                                        suggestLedgerName: function (val) {
                                                        const container = document.getElementById('ledgerSuggestions');
                                                        container.innerHTML = '';
                                                        if (val.length < 1) return; const names=[...new
                                                            Set(this.state.records.map(r=> r.name))].filter(n =>
                                                            n.toLowerCase().includes(val.toLowerCase()));
                                                            names.forEach(name => {
                                                            const tag = document.createElement('span');
                                                            tag.textContent = name;
                                                            tag.style.cssText = "background:var(--light-bg); padding:4px
                                                            8px; border-radius:4px; font-size:0.8rem; border:1px solid
                                                            var(--border); cursor:pointer; word-break: break-word;";
                                                            tag.onclick = () => {
                                                            document.getElementById('ledgerSearch').value = name;
                                                            this.loadLedger(name);
                                                            container.innerHTML = '';
                                                            };
                                                            container.appendChild(tag);
                                                            });
                                                            },

                                                            loadLedger: function (name) {
                                                            const custRecords = this.state.records.filter(r => r.name
                                                            === name);
                                                            if (custRecords.length === 0) return;

                                                            document.getElementById('ledgerDetails').style.display =
                                                            'block';
                                                            document.getElementById('ledgerEmpty').style.display =
                                                            'none';
                                                            document.getElementById('ledgerCustomerName').textContent =
                                                            name;

                                                            const totalRec = custRecords.filter(r => r.type ===
                                                            'income').reduce((sum, r) => sum + r.total, 0);
                                                            const totalPaid = custRecords.filter(r => r.type ===
                                                            'expense').reduce((sum, r) => sum + r.total, 0);

                                                            document.getElementById('ledgerTotalReceived').textContent =
                                                            totalRec.toLocaleString();
                                                            document.getElementById('ledgerTotalPaid').textContent =
                                                            totalPaid.toLocaleString();

                                                            const net = totalRec - totalPaid;
                                                            const netEl = document.getElementById('ledgerNetBalance');
                                                            netEl.textContent = net.toLocaleString();
                                                            netEl.style.color = net >= 0 ? 'var(--text-balance)' :
                                                            'var(--text-expense)';

                                                            const list = document.getElementById('ledgerList');
                                                            list.innerHTML = '';
                                                            custRecords.sort((a, b) => b.timestamp -
                                                            a.timestamp).forEach(r => {
                                                            const li = document.createElement('li');
                                                            li.className = 'history-item';
                                                            const amountClass = r.type === 'income' ? 'amount-income' :
                                                            'amount-expense';
                                                            li.innerHTML = `
                                                            <div class="h-left">
                                                                <span class="h-name">${r.date}</span>
                                                                <div class="h-details">
                                                                    <div class="h-detail-row"><span>${r.remarks || 'No
                                                                            remarks'}</span></div>
                                                                    <div class="h-detail-row"><span>Status:</span>
                                                                        <span>${r.status}</span></div>
                                                                </div>
                                                            </div>
                                                            <div class="h-right">
                                                                <span class="h-amount ${amountClass}">${r.symbol}
                                                                    ${r.total.toLocaleString()}</span>
                                                            </div>
                                                            `;
                                                            list.appendChild(li);
                                                            });
                                                            },

                                                            clearLedger: function () {
                                                            document.getElementById('ledgerSearch').value = '';
                                                            document.getElementById('ledgerDetails').style.display =
                                                            'none';
                                                            document.getElementById('ledgerEmpty').style.display =
                                                            'block';
                                                            document.getElementById('ledgerSuggestions').innerHTML = '';
                                                            },

                                                            setFilterMode: function (mode) {
                                                            this.state.filters.mode = mode;
                                                            const inputs = document.querySelectorAll('.filter-input');
                                                            inputs.forEach(input => input.style.display = 'none');

                                                            if (mode === 'name')
                                                            document.getElementById('filterName').style.display =
                                                            'block';
                                                            else if (mode === 'date')
                                                            document.getElementById('filterDate').style.display =
                                                            'block';
                                                            else if (mode === 'amount')
                                                            document.getElementById('filterAmount').style.display =
                                                            'block';

                                                            this.renderHistory();
                                                            },
                                                            handleFilter: function (type, value) {
                                                            if (this.state.filters.mode !== type) return;
                                                            this.state.filters[type] = value;
                                                            this.renderHistory();
                                                            },
                                                            closeAllMenus: function () {
                                                            document.querySelectorAll('.item-menu').forEach(el =>
                                                            el.classList.remove('show')); },
                                                            toggleMenu: function (id, event) {
                                                            if (event) event.stopPropagation();
                                                            this.closeAllMenus();
                                                            const menu = document.getElementById(`menu-${id}`);
                                                            if (menu) menu.classList.add('show');
                                                            },
                                                            renderHistory: function () {
                                                            const list = document.getElementById('historyList');
                                                            const emptyState = document.getElementById('emptyState');
                                                            const { name, date, amount, mode, source } =
                                                            this.state.filters;
                                                            list.innerHTML = '';
                                                            let data = [...this.state.records];

                                                            // 1. First Apply Source Filter
                                                            if (source === 'entry') {
                                                            // Show ONLY Regular Entries (Hide 'Daily Cash Collection')
                                                            data = data.filter(r => r.name !== 'Daily Cash Collection');
                                                            } else if (source === 'collection') {
                                                            // Show ONLY Daily Collections
                                                            data = data.filter(r => r.name === 'Daily Cash Collection');
                                                            }
                                                            // If 'all', do nothing

                                                            // 2. Then Apply Existing Filters
                                                            const filtered = data.filter(r => {
                                                            if (mode === 'name') return name ?
                                                            r.name.toLowerCase().includes(name.toLowerCase()) : true;
                                                            else if (mode === 'date') return date ? r.date === date :
                                                            true;
                                                            else if (mode === 'amount') return amount ?
                                                            r.total.toString().startsWith(amount.toString()) : true;
                                                            return true;
                                                            });

                                                            // SORTING LOGIC
                                                            const sortMode = this.state.filters.sort || 'date-desc';

                                                            filtered.sort((a, b) => {
                                                            if (sortMode === 'date-desc') return b.timestamp -
                                                            a.timestamp;
                                                            if (sortMode === 'date-asc') return a.timestamp -
                                                            b.timestamp;

                                                            if (sortMode === 'amount-desc') return b.total - a.total;
                                                            if (sortMode === 'amount-asc') return a.total - b.total;

                                                            if (sortMode === 'name-asc') return
                                                            a.name.localeCompare(b.name);
                                                            if (sortMode === 'name-desc') return
                                                            b.name.localeCompare(a.name);

                                                            return b.timestamp - a.timestamp; // Default
                                                            });

                                                            if (filtered.length === 0) emptyState.style.display =
                                                            'block';
                                                            else {
                                                            emptyState.style.display = 'none';
                                                            filtered.forEach(r => {
                                                            const li = document.createElement('li');
                                                            li.className = 'history-item';
                                                            let statusBadge = '';
                                                            if (r.status === 'Due') {
                                                            statusBadge = '<span class="badge due">Due</span>';
                                                            if (r.type === 'expense') statusBadge += ' <span
                                                                class="badge expense">Payable</span>';
                                                            else statusBadge += ' <span
                                                                class="badge receivable">Receivable</span>';

                                                            } else if (r.status === 'Partial') {
                                                            if (r.partialPayment && r.partialPayment.balanceAmount < 0)
                                                                { const
                                                                returnAmt=Math.abs(r.partialPayment.balanceAmount).toFixed(0);
                                                                statusBadge=`<span class="badge"
                                                                style="background:#4caf50; color:#fff;">Return:
                                                                ${returnAmt}</span>`;
                                                                // Do NOT add 'Payable' badge here to avoid
                                                                duplicate/confusion
                                                                } else {
                                                                statusBadge = '<span class="badge"
                                                                    style="background:#ffc107; color:#000;">Partial</span>';
                                                                if (r.type === 'expense') statusBadge += ' <span
                                                                    class="badge expense">Payable</span>';
                                                                else if (r.partialPayment && r.partialPayment.dueType
                                                                === 'receivable') statusBadge += ' <span
                                                                    class="badge receivable">Receivable</span>';
                                                                else statusBadge += ' <span
                                                                    class="badge expense">Payable</span>';
                                                                }
                                                                }

                                                                const amountClass = r.type === 'expense' ?
                                                                'amount-expense' : 'amount-income';
                                                                const amountWords = this.numberToWords(r.total) + " " +
                                                                r.currency;

                                                                const tagsHtml = r.tags && r.tags.length > 0
                                                                ? `<div class="h-tags"> ${r.tags.join(', ')}</div>`
                                                                : '';

                                                                li.innerHTML = `
                                                                <div class="h-left">
                                                                    <span class="h-name">${statusBadge} ${r.name}</span>
                                                                    ${tagsHtml}
                                                                    <div class="h-details">
                                                                        ${r.mobile ? `<div class="h-detail-row">
                                                                            <span></span> <span>${r.mobile}</span>
                                                                        </div>` : ''}
                                                                        ${r.remarks ? `<div class="h-detail-row">
                                                                            <span></span> <span>${r.remarks}</span>
                                                                        </div>` : ''}
                                                                        <div class="h-detail-row"
                                                                            style="font-size:0.75rem; opacity:0.8;">
                                                                            ${r.date} &bull; ${r.country}</div>
                                                                    </div>
                                                                </div>
                                                                <div class="h-right">
                                                                    <span class="h-amount ${amountClass}">${r.symbol}
                                                                        ${r.total.toLocaleString()}</span>
                                                                    <span class="h-words"
                                                                        title="${amountWords}">${amountWords}</span>
                                                                    <div class="menu-container">
                                                                        <button class="btn-menu"
                                                                            onclick="app.toggleMenu(${r.id}, event)"></button>
                                                                        <div class="item-menu" id="menu-${r.id}">
                                                                            <button class="menu-opt"
                                                                                onclick="event.stopPropagation(); event.preventDefault(); app.downloadInvoice(${r.id})">
                                                                                 ${r.name === 'Daily Cash Collection'
                                                                                ? 'Download Cash Slip' : 'Download
                                                                                Invoice'}
                                                                            </button>
                                                                            <button class="menu-opt"
                                                                                onclick="event.stopPropagation(); event.preventDefault(); app.viewRecord(${r.id})">
                                                                                View Details</button>
                                                                            <button class="menu-opt"
                                                                                onclick="event.stopPropagation(); event.preventDefault(); app.copyRecord(${r.id})">
                                                                                Copy</button>
                                                                            <button class="menu-opt"
                                                                                onclick="event.stopPropagation(); event.preventDefault(); app.shareRecord(${r.id})">
                                                                                Share</button>
                                                                            <button class="menu-opt delete"
                                                                                onclick="event.stopPropagation(); event.preventDefault(); app.deleteRecord(${r.id})">
                                                                                Delete</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                `;
                                                                list.appendChild(li);
                                                                });
                                                                }
                                                                },
                                                                // --- LEGAL MODAL LOGIC WITH HISTORY SUPPORT ---
                                                                openLegal: function (url, title) {
                                                                document.getElementById('legalTitle').textContent =
                                                                title;
                                                                document.getElementById('legalFrame').src = url;

                                                                // Push history state so "Back" button closes modal
                                                                instead of app
                                                                history.pushState({ modal: 'legal' }, title, '#legal');

                                                                const modal = document.getElementById('legalModal');
                                                                modal.classList.add('open');
                                                                modal.style.display = 'block';
                                                                },

                                                                closeLegal: function () {
                                                                const modal = document.getElementById('legalModal');
                                                                modal.classList.remove('open');
                                                                modal.style.display = 'none';
                                                                document.getElementById('legalFrame').src = '';
                                                                },
                                                                // ---------------------------------------------

                                                                viewRecord: function (id) {
                                                                const r = this.state.records.find(rec => rec.id === id);
                                                                if (!r) return;
                                                                let breakdownHTML = '';
                                                                Object.keys(r.denominations).forEach(denom => {
                                                                const count = r.denominations[denom];
                                                                if (count > 0) breakdownHTML += `<div
                                                                    class="denom-br-row"><span>${r.symbol} ${denom} x
                                                                        ${count}</span><span>${r.symbol} ${(count *
                                                                        denom).toLocaleString()}</span></div>`;
                                                                });
                                                                if (breakdownHTML === '') breakdownHTML = '<div
                                                                    style="text-align:center; padding:10px; opacity:0.7;">
                                                                    No denomination breakdown found.</div>';
                                                                const inWords = this.numberToWords(r.total) + " " +
                                                                r.currency;
                                                                const typeBadge = r.type === 'expense' ? '<span
                                                                    class="badge expense">Payable</span>' : '<span
                                                                    class="badge receivable">Income</span>';
                                                                const statusBadge = r.status === 'Due' ? '<span
                                                                    class="badge due">Due</span>' : '';

                                                                // Ensuring items are shown explicitly in View Details
                                                                Modal
                                                                const tagsHtml = r.tags && r.tags.length > 0 ? `<div
                                                                    class="detail-row"><span>Items:</span>
                                                                    <span>${r.tags.join(', ')}</span></div>` : '';

                                                                let transactionText = "";
                                                                if (r.type === 'income') { transactionText = (r.status
                                                                === 'Paid') ? "Received From" : "Receivable From"; }
                                                                else { transactionText = (r.status === 'Paid') ? "Paid
                                                                To" : "Payable To"; }

                                                                document.getElementById('detailContent').innerHTML = `
                                                                <div class="detail-row"
                                                                    style="font-size:1rem; border-bottom: 2px solid var(--border); margin-bottom:12px;">
                                                                    <span>Transaction:</span> <span
                                                                        style="color:var(--primary); font-weight:700;">${transactionText}
                                                                        <span
                                                                            style="text-decoration:underline;">${r.name}</span></span>
                                                                </div>
                                                                <div class="detail-row"><span>Status:</span>
                                                                    <span>${typeBadge} ${statusBadge}</span></div>
                                                                <div class="detail-row"><span>Date:</span>
                                                                    <span>${r.date} ${r.time}</span></div>
                                                                ${tagsHtml}
                                                                <div class="detail-row"><span>Total:</span> <span
                                                                        style="color:var(--primary)">${r.symbol}
                                                                        ${r.total.toLocaleString()}</span></div>
                                                                <div class="detail-row"><span>In Words:</span> <span
                                                                        style="font-style:italic; font-size: 0.8rem;">${inWords}</span>
                                                                </div>
                                                                <div class="detail-row"><span>Remarks:</span>
                                                                    <span>${r.remarks || '-'}</span></div>
                                                                <h4
                                                                    style="margin: 15px 0 10px 0; font-size: 0.9rem; color: var(--neutral);">
                                                                    Denomination Breakdown</h4>
                                                                <div class="denom-breakdown">${breakdownHTML}</div>
                                                                `;
                                                                this.toggleModal('viewDetailModal');
                                                                },
                                                                copyRecord: function (id) {
                                                                const r = this.state.records.find(rec => rec.id === id);
                                                                if (!r) return;

                                                                let transactionText = "";
                                                                if (r.type === 'income') { transactionText = (r.status
                                                                === 'Paid') ? "Received From" : "Receivable From"; }
                                                                else { transactionText = (r.status === 'Paid') ? "Paid
                                                                To" : "Payable To"; }

                                                                const text = `Transaction: ${transactionText} ${r.name}
                                                                Amount: ${r.symbol}${r.total}
                                                                Status: ${r.status}
                                                                Date: ${r.date}
                                                                Remarks: ${r.remarks}`;
                                                                if (navigator.clipboard)
                                                                navigator.clipboard.writeText(text).then(() =>
                                                                this.showToast("Copied!")).catch(() =>
                                                                this.showToast("Failed"));
                                                                else this.showToast("Clipboard not supported");
                                                                },
                                                                shareRecord: function (id) {
                                                                const r = this.state.records.find(rec => rec.id === id);
                                                                if (!r) return;

                                                                let transactionText = "";
                                                                if (r.type === 'income') { transactionText = (r.status
                                                                === 'Paid') ? "Received From" : "Receivable From"; }
                                                                else { transactionText = (r.status === 'Paid') ? "Paid
                                                                To" : "Payable To"; }

                                                                const msg = `ArthikaX:
                                                                Transaction: ${transactionText} ${r.name}
                                                                Amount: ${r.symbol}${r.total}
                                                                Date: ${r.date}

                                                                Download App: https://arthixa.com `;
                                                                if (navigator.share) navigator.share({ title: 'Record',
                                                                text: msg }).catch(console.error);
                                                                else this.showToast("Share not supported");
                                                                },
                                                                deleteRecord: function (id) {
                                                                const recordId = Number(id);
                                                                const index = this.state.records.findIndex(r => r.id ===
                                                                recordId);

                                                                if (index === -1) {
                                                                this.showToast("Record not found.");
                                                                return;
                                                                }

                                                                if (confirm("Are you sure you want to delete this
                                                                record?")) {
                                                                this.state.records.splice(index, 1);
                                                                localStorage.setItem('ArthikaX_records',
                                                                JSON.stringify(this.state.records));
                                                                this.updateDashboard();

                                                                // Refresh Outstanding if active
                                                                const outTab = document.getElementById('outstanding');
                                                                if (outTab && outTab.classList.contains('active')) {
                                                                this.renderOutstanding('all');
                                                                }

                                                                this.closeAllMenus();
                                                                this.renderHistory();
                                                                this.showToast("Record deleted.");
                                                                }
                                                                },
                                                                showToast: function (msg) {
                                                                const el = document.getElementById('toast');
                                                                el.textContent = msg; el.className = "show";
                                                                setTimeout(() => { el.className =
                                                                el.className.replace("show", ""); }, 5000);
                                                                },
                                                                numberToWords: function (num) {
                                                                if (num === 0) return "Zero";
                                                                const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five
                                                                ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven
                                                                ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ',
                                                                'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
                                                                const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty',
                                                                'Sixty', 'Seventy', 'Eighty', 'Ninety'];

                                                                const numStr = num.toString();
                                                                const n = ('00000000000' +
                                                                numStr).substr(-11).match(/^(\d{2})(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);

                                                                if (!n) return numStr;

                                                                let str = '';

                                                                str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + '
                                                                ' + a[n[1][1]]) + 'Arab ' : '';
                                                                str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + '
                                                                ' + a[n[2][1]]) + 'Crore ' : '';
                                                                str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + '
                                                                ' + a[n[3][1]]) + 'Lakh ' : '';
                                                                str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + '
                                                                ' + a[n[4][1]]) + 'Thousand ' : '';
                                                                str += (n[5] != 0) ? (a[Number(n[5])] || b[n[5][0]] + '
                                                                ' + a[n[5][1]]) + 'Hundred ' : '';
                                                                str += (n[6] != 0) ? ((str != '') ? 'and ' : '') +
                                                                (a[Number(n[6])] || b[n[6][0]] + ' ' + a[n[6][1]]) : '';

                                                                return str.trim();
                                                                }
                                                                };

                                                                document.addEventListener('DOMContentLoaded', () => {
                                                                app.init();
                                                                });
                                                                </script>

                                                                <script>
                                                                    // Service Worker Registration Logic
                                                                    if ('serviceWorker' in navigator) {
                                                                        window.addEventListener('load', () => {
                                                                            navigator.serviceWorker.register('./sw.js')
                                                                                .then(registration => {
                                                                                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                                                                                }, err => {
                                                                                    console.log('ServiceWorker registration failed: ', err);
                                                                                });
                                                                        });
                                                                    }
                                                                </script>

                                                                <!-- ENCRYPTION & PIN LOCK SYSTEM - ArthikaX Security Module -->
                                                                <script>
                                                                    // Crypto utilities for data encryption/decryption
                                                                    const CryptoUtil = {
                                                                        // Generate a key from PIN using PBKDF2
                                                                        async deriveKey(pin) {
                                                                            const encoder = new TextEncoder();
                                                                            const pinData = encoder.encode(pin);

                                                                            // Import the PIN as a key material
                                                                            const keyMaterial = await window.crypto.subtle.importKey(
                                                                                "raw",
                                                                                pinData,
                                                                                { name: "PBKDF2" },
                                                                                false,
                                                                                ["deriveKey"]
                                                                            );

                                                                            // Generate salt (stored with encrypted data)
                                                                            const salt = window.crypto.getRandomValues(new Uint8Array(16));

                                                                            // Derive AES-GCM key from PIN
                                                                            const key = await window.crypto.subtle.deriveKey(
                                                                                {
                                                                                    name: "PBKDF2",
                                                                                    salt: salt,
                                                                                    iterations: 100000,
                                                                                    hash: "SHA-256"
                                                                                },
                                                                                keyMaterial,
                                                                                { name: "AES-GCM", length: 256 },
                                                                                false,
                                                                                ["encrypt", "decrypt"]
                                                                            );

                                                                            return { key, salt };
                                                                        },

                                                                        // Derive key with existing salt (for decryption)
                                                                        async deriveKeyWithSalt(pin, salt) {
                                                                            const encoder = new TextEncoder();
                                                                            const pinData = encoder.encode(pin);

                                                                            const keyMaterial = await window.crypto.subtle.importKey(
                                                                                "raw",
                                                                                pinData,
                                                                                { name: "PBKDF2" },
                                                                                false,
                                                                                ["deriveKey"]
                                                                            );

                                                                            const key = await window.crypto.subtle.deriveKey(
                                                                                {
                                                                                    name: "PBKDF2",
                                                                                    salt: salt,
                                                                                    iterations: 100000,
                                                                                    hash: "SHA-256"
                                                                                },
                                                                                keyMaterial,
                                                                                { name: "AES-GCM", length: 256 },
                                                                                false,
                                                                                ["encrypt", "decrypt"]
                                                                            );

                                                                            return key;
                                                                        },

                                                                        // Encrypt data
                                                                        async encrypt(data, pin) {
                                                                            const encoder = new TextEncoder();
                                                                            const dataBuffer = encoder.encode(JSON.stringify(data));

                                                                            const { key, salt } = await this.deriveKey(pin);

                                                                            // Generate IV
                                                                            const iv = window.crypto.getRandomValues(new Uint8Array(12));

                                                                            // Encrypt
                                                                            const encryptedBuffer = await window.crypto.subtle.encrypt(
                                                                                { name: "AES-GCM", iv: iv },
                                                                                key,
                                                                                dataBuffer
                                                                            );

                                                                            // Combine salt + iv + encryptedData
                                                                            const result = new Uint8Array(salt.length + iv.length + encryptedBuffer.byteLength);
                                                                            result.set(salt, 0);
                                                                            result.set(iv, salt.length);
                                                                            result.set(new Uint8Array(encryptedBuffer), salt.length + iv.length);

                                                                            // Convert to base64 for storage
                                                                            return btoa(String.fromCharCode(...result));
                                                                        },

                                                                        // Decrypt data
                                                                        async decrypt(encryptedBase64, pin) {
                                                                            try {
                                                                                const encryptedData = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));

                                                                                // Extract salt (16 bytes), iv (12 bytes), and ciphertext
                                                                                const salt = encryptedData.slice(0, 16);
                                                                                const iv = encryptedData.slice(16, 28);
                                                                                const ciphertext = encryptedData.slice(28);

                                                                                const key = await this.deriveKeyWithSalt(pin, salt);

                                                                                const decryptedBuffer = await window.crypto.subtle.decrypt(
                                                                                    { name: "AES-GCM", iv: iv },
                                                                                    key,
                                                                                    ciphertext
                                                                                );

                                                                                const decoder = new TextDecoder();
                                                                                return JSON.parse(decoder.decode(decryptedBuffer));
                                                                            } catch (e) {
                                                                                throw new Error("Invalid PIN or corrupted data");
                                                                            }
                                                                        }
                                                                    };

                                                                    // PIN Lock Manager
                                                                    const PinLock = {
                                                                        isLocked: true,
                                                                        hasPin: false,
                                                                        pinHint: "",

                                                                        init() {
                                                                            const savedPin = localStorage.getItem('ArthikaX_pinHash');
                                                                            const savedHint = localStorage.getItem('ArthikaX_pinHint');

                                                                            if (savedPin) {
                                                                                this.hasPin = true;
                                                                                this.pinHint = savedHint || "";
                                                                                this.showLockScreen();
                                                                            } else {
                                                                                this.showSetupPin();
                                                                            }
                                                                        },

                                                                        showSetupPin() {
                                                                            // Only show from Settings, not on first load
                                                                            const setupHtml = `
                    <div id="pinSetupModal" class="modal open" style="z-index: 10000;">
                        <div class="modal-content" style="max-width: 420px;">
                            <button class="modal-close" onclick="document.getElementById('pinSetupModal').remove()">&times;</button>
                            <h2 style="color: var(--primary); margin-bottom: 1rem; text-align: center;"> Set PIN</h2>
                            <p style="margin-bottom: 1.5rem; text-align: center; color: var(--neutral); font-size: 0.9rem;">
                                Protect your data with a PIN code
                            </p>

                            <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin-bottom: 1.5rem; border-radius: 4px;">
                                <p style="margin: 0; font-size: 0.85rem; color: #e65100; font-weight: 600;">
                                     Important: Please remember your PIN carefully.
                                </p>
                                <p style="margin: 5px 0 0 0; font-size: 0.8rem; color: #bf360c;">
                                    If you forget the PIN you set, all your data will be permanently deleted and cannot be recovered. (No reset option)
                                </p>
                                <p style="margin: 8px 0 0 0; font-size: 0.8rem; color: #d84315; font-weight: 600; background: #fff8e1; padding: 8px; border-radius: 4px;">
                                     Please write down your PIN somewhere safe (e.g., in a notebook, password manager, or secure file) before proceeding.
                                </p>
                            </div>

                            <div class="form-group">
                                <label style="font-size: 0.85rem;">Set PIN (4-6 digits)</label>
                                <input type="password" id="newPinInput" class="form-control" maxlength="6" inputmode="numeric" pattern="[0-9]*" placeholder="Enter 4-6 digit PIN" style="text-align: center; font-size: 1.2rem; letter-spacing: 5px;">
                            </div>

                            <div class="form-group">
                                <label style="font-size: 0.85rem;">Confirm PIN</label>
                                <input type="password" id="confirmPinInput" class="form-control" maxlength="6" inputmode="numeric" pattern="[0-9]*" placeholder="Confirm PIN" style="text-align: center; font-size: 1.2rem; letter-spacing: 5px;">
                            </div>

                            <div class="form-group">
                                <label style="font-size: 0.85rem;">PIN Hint (Optional but recommended)</label>
                                <input type="text" id="pinHintInput" class="form-control" placeholder="Ex: My birth year, Father's name...">
                                <p style="font-size: 0.75rem; color: var(--neutral); margin-top: 5px;">This hint will be shown if you forget your PIN</p>
                            </div>

                            <button class="btn btn-primary" onclick="PinLock.savePin()" style="margin-bottom: 10px;">Set PIN & Continue</button>
                            <button class="btn btn-outline" onclick="PinLock.skipSetup()" style="background: transparent;">Skip for Now</button>
                        </div>
                    </div>
                `;
                                                                            document.body.insertAdjacentHTML('beforeend', setupHtml);
                                                                        },

                                                                        showLockScreen() {
                                                                            const lockHtml = `
                    <div id="pinLockScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--light-bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                        <div style="background: var(--card-bg); padding: 2.5rem; border-radius: var(--radius-lg); max-width: 400px; width: 100%; box-shadow: var(--shadow-md); text-align: center;">
                            <div style="width: 80px; height: 80px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;">
                                <span style="font-size: 2.5rem;"></span>
                            </div>
                            <h2 style="color: var(--text-color); margin-bottom: 0.5rem;">App Locked</h2>
                            <p style="color: var(--neutral); margin-bottom: 2rem; font-size: 0.9rem;">Enter your PIN to unlock</p>

                            <div class="form-group">
                                <input type="password" id="unlockPinInput" class="form-control" maxlength="6" inputmode="numeric" pattern="[0-9]*" placeholder="" style="text-align: center; font-size: 1.5rem; letter-spacing: 10px; margin-bottom: 1rem;">
                            </div>

                            <button class="btn btn-primary" onclick="PinLock.unlock()" style="margin-bottom: 1rem;">Unlock</button>

                            ${this.pinHint ? `<button class="btn btn-outline" onclick="PinLock.showHint()" style="font-size: 0.85rem;"> Show Hint</button>` : ''}

                            <div id="pinError" style="color: #dc3545; margin-top: 1rem; font-size: 0.85rem; display: none;">
                                Incorrect PIN. Please try again.
                            </div>

                            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                <p style="font-size: 0.75rem; color: #dc3545; margin: 0;">
                                     If you forget your PIN, all data will be permanently deleted<br>
                                    <span style="font-size: 0.7rem;">No reset option available. Please remember to keep your PIN noted somewhere safe.</span>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                                                                            document.body.insertAdjacentHTML('beforeend', lockHtml);

                                                                            // Auto-focus input
                                                                            setTimeout(() => {
                                                                                const input = document.getElementById('unlockPinInput');
                                                                                if (input) input.focus();
                                                                            }, 100);
                                                                        },

                                                                        async savePin() {
                                                                            const pin = document.getElementById('newPinInput').value;
                                                                            const confirmPin = document.getElementById('confirmPinInput').value;
                                                                            const hint = document.getElementById('pinHintInput').value;

                                                                            if (pin.length < 4) {
                                                                                alert("PIN must be at least 4 digits");
                                                                                return;
                                                                            }

                                                                            if (pin !== confirmPin) {
                                                                                alert("PINs do not match");
                                                                                return;
                                                                            }

                                                                            // Verify PIN is numeric
                                                                            if (!/^\d+$/.test(pin)) {
                                                                                alert("PIN must contain only numbers");
                                                                                return;
                                                                            }

                                                                            // Hash the PIN for storage (simple hash for verification)
                                                                            const hashedPin = await this.hashPin(pin);

                                                                            localStorage.setItem('ArthikaX_pinHash', hashedPin);
                                                                            if (hint) localStorage.setItem('ArthikaX_pinHint', hint);

                                                                            // If there's existing unencrypted data, encrypt it now
                                                                            await this.encryptExistingData(pin);

                                                                            document.getElementById('pinSetupModal').remove();
                                                                            this.hasPin = true;
                                                                            this.isLocked = false;
                                                                            app.showToast('PIN set successfully');
                                                                        },

                                                                        skipSetup() {
                                                                            if (confirm('Are you sure? Without a PIN, your data is not encrypted and anyone with access to your device can see it.')) {
                                                                                localStorage.setItem('ArthikaX_pinSkipped', 'true');
                                                                                document.getElementById('pinSetupModal').remove();
                                                                                this.isLocked = false;
                                                                            }
                                                                        },

                                                                        async hashPin(pin) {
                                                                            const encoder = new TextEncoder();
                                                                            const data = encoder.encode(pin);
                                                                            const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
                                                                            const hashArray = Array.from(new Uint8Array(hashBuffer));
                                                                            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                                                                        },

                                                                        async unlock() {
                                                                            const pin = document.getElementById('unlockPinInput').value;
                                                                            const hashedPin = await this.hashPin(pin);
                                                                            const savedHash = localStorage.getItem('ArthikaX_pinHash');

                                                                            if (hashedPin === savedHash) {
                                                                                // Correct PIN
                                                                                document.getElementById('pinLockScreen').remove();
                                                                                this.isLocked = false;

                                                                                // Store PIN for session
                                                                                window.currentPin = pin;

                                                                                // Decrypt and load data into app state
                                                                                await this.loadDecryptedData(pin);

                                                                                // Force update dashboard with loaded data
                                                                                app.updateDashboard();

                                                                                // If on Outstanding tab, refresh it
                                                                                const outstandingSection = document.getElementById('outstanding');
                                                                                if (outstandingSection && outstandingSection.classList.contains('active')) {
                                                                                    app.renderOutstanding('all');
                                                                                }

                                                                                app.showToast('Unlocked successfully');
                                                                            } else {
                                                                                document.getElementById('pinError').style.display = 'block';
                                                                                document.getElementById('unlockPinInput').value = '';
                                                                                document.getElementById('unlockPinInput').focus();
                                                                            }
                                                                        },

                                                                        showHint() {
                                                                            if (this.pinHint) {
                                                                                alert(' Hint: ' + this.pinHint);
                                                                            }
                                                                        },

                                                                        async encryptExistingData(pin) {
                                                                            // Check if there's unencrypted data
                                                                            const records = localStorage.getItem('ArthikaX_records');
                                                                            const profiles = localStorage.getItem('ArthikaX_profiles');

                                                                            if (records && !records.startsWith('ENC:')) {
                                                                                try {
                                                                                    const encrypted = await CryptoUtil.encrypt(JSON.parse(records), pin);
                                                                                    localStorage.setItem('ArthikaX_records', 'ENC:' + encrypted);
                                                                                } catch (e) {
                                                                                    console.error('Encryption failed:', e);
                                                                                }
                                                                            }

                                                                            if (profiles && !profiles.startsWith('ENC:')) {
                                                                                try {
                                                                                    const encrypted = await CryptoUtil.encrypt(JSON.parse(profiles), pin);
                                                                                    localStorage.setItem('ArthikaX_profiles', 'ENC:' + encrypted);
                                                                                } catch (e) {
                                                                                    console.error('Encryption failed:', e);
                                                                                }
                                                                            }
                                                                        },

                                                                        async loadDecryptedData(pin) {
                                                                            console.log('Loading decrypted data...');

                                                                            // Load and decrypt records
                                                                            const encRecords = localStorage.getItem('ArthikaX_records');
                                                                            console.log('Records found:', encRecords ? (encRecords.startsWith('ENC:') ? 'encrypted' : 'plain') : 'none');

                                                                            if (encRecords && encRecords.startsWith('ENC:')) {
                                                                                try {
                                                                                    const decrypted = await CryptoUtil.decrypt(encRecords.substring(4), pin);
                                                                                    app.state.records = decrypted || [];
                                                                                    console.log('Records decrypted:', app.state.records.length);
                                                                                } catch (e) {
                                                                                    console.error('Failed to decrypt records:', e);
                                                                                    app.state.records = [];
                                                                                    app.showToast('Error: Could not decrypt data');
                                                                                }
                                                                            } else if (encRecords) {
                                                                                try {
                                                                                    app.state.records = JSON.parse(encRecords) || [];
                                                                                    console.log('Records loaded (plain):', app.state.records.length);
                                                                                } catch (e) {
                                                                                    app.state.records = [];
                                                                                }
                                                                            } else {
                                                                                app.state.records = [];
                                                                            }

                                                                            // Load and decrypt profiles
                                                                            const encProfiles = localStorage.getItem('ArthikaX_profiles');
                                                                            if (encProfiles && encProfiles.startsWith('ENC:')) {
                                                                                try {
                                                                                    const decrypted = await CryptoUtil.decrypt(encProfiles.substring(4), pin);
                                                                                    app.state.profiles = decrypted || [{ id: 1, name: "My Business" }];
                                                                                    console.log('Profiles decrypted:', app.state.profiles.length);
                                                                                } catch (e) {
                                                                                    console.error('Failed to decrypt profiles:', e);
                                                                                    app.state.profiles = [{ id: 1, name: "My Business" }];
                                                                                }
                                                                            } else if (encProfiles) {
                                                                                try {
                                                                                    app.state.profiles = JSON.parse(encProfiles) || [{ id: 1, name: "My Business" }];
                                                                                } catch (e) {
                                                                                    app.state.profiles = [{ id: 1, name: "My Business" }];
                                                                                }
                                                                            } else {
                                                                                app.state.profiles = [{ id: 1, name: "My Business" }];
                                                                            }

                                                                            // Load current profile ID
                                                                            const savedProfileId = localStorage.getItem('ArthikaX_currentProfileId');
                                                                            if (savedProfileId) {
                                                                                app.state.currentProfileId = parseInt(savedProfileId);
                                                                            } else {
                                                                                app.state.currentProfileId = 1;
                                                                            }

                                                                            console.log('Current profile ID:', app.state.currentProfileId);
                                                                            console.log('Total records:', app.state.records.length);

                                                                            // Setup UI
                                                                            app.setupDropdown();
                                                                            app.setupSettingsDropdown();
                                                                            app.cleanupOldRecords();
                                                                            app.migrateRecordsToProfile();

                                                                            // Load country
                                                                            const savedCountryName = localStorage.getItem('ArthikaX_lastCountry');
                                                                            if (savedCountryName) {
                                                                                const savedCountry = app.state.config.find(c => c.name === savedCountryName);
                                                                                if (savedCountry) {
                                                                                    app.selectCountry(savedCountry);
                                                                                }
                                                                            }

                                                                            app.updateHeaderProfileDisplay();
                                                                            app.renderProfileList();

                                                                            // Set date inputs
                                                                            const now = new Date();
                                                                            document.getElementById('entryDate').valueAsDate = now;
                                                                            document.getElementById('entryTime').value = now.toTimeString().substring(0, 5);

                                                                            const todayStr = now.toISOString().split('T')[0];
                                                                            document.getElementById('entryDate').max = todayStr;
                                                                            document.getElementById('filterDate').max = todayStr;
                                                                            document.getElementById('rangeStart').max = todayStr;
                                                                            document.getElementById('rangeEnd').max = todayStr;

                                                                            document.getElementById('settingsBtn').addEventListener('click', () => app.toggleModal('settingsModal'));

                                                                            window.addEventListener('click', (e) => {
                                                                                if (!e.target.closest('.menu-container')) app.closeAllMenus();
                                                                                if (e.target.classList.contains('modal')) e.target.classList.remove('open');
                                                                            });

                                                                            app.switchTab('home');
                                                                        },

                                                                        async decryptDataIfNeeded(pin) {
                                                                            // Legacy function - replaced by loadDecryptedData
                                                                            window.currentPin = pin;
                                                                        },

                                                                        // Settings: Change PIN
                                                                        showChangePinModal() {
                                                                            const modalHtml = `
                    <div id="changePinModal" class="modal open">
                        <div class="modal-content">
                            <button class="modal-close" onclick="document.getElementById('changePinModal').remove()">&times;</button>
                            <h2 style="margin-bottom: 1.5rem; color: var(--primary);">Change PIN</h2>

                            <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin-bottom: 1.5rem; border-radius: 4px;">
                                <p style="margin: 0; font-size: 0.85rem; color: #e65100; font-weight: 600;">
                                     Important: Please remember your PIN carefully.
                                </p>
                                <p style="margin: 5px 0 0 0; font-size: 0.8rem; color: #bf360c;">
                                    If you forget the PIN you set, all your data will be permanently deleted and cannot be recovered. (No reset option)
                                </p>
                                <p style="margin: 8px 0 0 0; font-size: 0.8rem; color: #d84315; font-weight: 600;">
                                     Please write down your PIN somewhere safe before proceeding.
                                </p>
                            </div>

                            <div class="form-group">
                                <label>Current PIN</label>
                                <input type="password" id="currentPinInput" class="form-control" maxlength="6" inputmode="numeric" placeholder="Current PIN">
                            </div>

                            <div class="form-group">
                                <label>New PIN (4-6 digits)</label>
                                <input type="password" id="newPinChangeInput" class="form-control" maxlength="6" inputmode="numeric" placeholder="New PIN">
                            </div>

                            <div class="form-group">
                                <label>Confirm New PIN</label>
                                <input type="password" id="confirmNewPinInput" class="form-control" maxlength="6" inputmode="numeric" placeholder="Confirm New PIN">
                            </div>

                            <div class="form-group">
                                <label>New PIN Hint</label>
                                <input type="text" id="newPinHintInput" class="form-control" placeholder="New hint (optional)" value="${this.pinHint}">
                            </div>

                            <button class="btn btn-primary" onclick="PinLock.changePin()">Update PIN</button>
                            <button class="btn btn-danger" onclick="PinLock.removePin()" style="margin-top: 10px;">Remove PIN (Decrypt Data)</button>

                            <div id="changePinError" style="color: #dc3545; margin-top: 1rem; display: none;"></div>
                        </div>
                    </div>
                `;
                                                                            document.body.insertAdjacentHTML('beforeend', modalHtml);
                                                                        },

                                                                        async changePin() {
                                                                            const currentPin = document.getElementById('currentPinInput').value;
                                                                            const newPin = document.getElementById('newPinChangeInput').value;
                                                                            const confirmNewPin = document.getElementById('confirmNewPinInput').value;
                                                                            const newHint = document.getElementById('newPinHintInput').value;
                                                                            const errorDiv = document.getElementById('changePinError');

                                                                            // Verify current PIN
                                                                            const hashedCurrent = await this.hashPin(currentPin);
                                                                            if (hashedCurrent !== localStorage.getItem('ArthikaX_pinHash')) {
                                                                                errorDiv.textContent = 'Current PIN is incorrect';
                                                                                errorDiv.style.display = 'block';
                                                                                return;
                                                                            }

                                                                            if (newPin.length < 4) {
                                                                                errorDiv.textContent = 'New PIN must be at least 4 digits';
                                                                                errorDiv.style.display = 'block';
                                                                                return;
                                                                            }

                                                                            if (newPin !== confirmNewPin) {
                                                                                errorDiv.textContent = 'New PINs do not match';
                                                                                errorDiv.style.display = 'block';
                                                                                return;
                                                                            }

                                                                            try {
                                                                                // Decrypt data with old PIN
                                                                                await this.decryptAllData(currentPin);

                                                                                // Re-encrypt with new PIN
                                                                                await this.encryptAllData(newPin);

                                                                                // Update stored PIN hash
                                                                                const newHash = await this.hashPin(newPin);
                                                                                localStorage.setItem('ArthikaX_pinHash', newHash);
                                                                                if (newHint) localStorage.setItem('ArthikaX_pinHint', newHint);

                                                                                window.currentPin = newPin;
                                                                                document.getElementById('changePinModal').remove();
                                                                                app.showToast('PIN changed successfully');
                                                                            } catch (e) {
                                                                                errorDiv.textContent = 'Error changing PIN: ' + e.message;
                                                                                errorDiv.style.display = 'block';
                                                                            }
                                                                        },

                                                                        async removePin() {
                                                                            if (!confirm(' WARNING: This will decrypt all your data and store it without protection. Anyone with access to your device will be able to see it. Continue?')) {
                                                                                return;
                                                                            }

                                                                            const currentPin = document.getElementById('currentPinInput').value;
                                                                            const hashedCurrent = await this.hashPin(currentPin);

                                                                            if (hashedCurrent !== localStorage.getItem('ArthikaX_pinHash')) {
                                                                                alert('Current PIN is incorrect');
                                                                                return;
                                                                            }

                                                                            try {
                                                                                // Decrypt everything
                                                                                await this.decryptAllData(currentPin);

                                                                                // Remove PIN protection
                                                                                localStorage.removeItem('ArthikaX_pinHash');
                                                                                localStorage.removeItem('ArthikaX_pinHint');
                                                                                delete window.currentPin;

                                                                                this.hasPin = false;
                                                                                document.getElementById('changePinModal').remove();
                                                                                app.showToast('PIN protection removed. Data is now decrypted.');
                                                                            } catch (e) {
                                                                                alert('Error removing PIN: ' + e.message);
                                                                            }
                                                                        },

                                                                        async decryptAllData(pin) {
                                                                            // Decrypt records
                                                                            const encRecords = localStorage.getItem('ArthikaX_records');
                                                                            if (encRecords && encRecords.startsWith('ENC:')) {
                                                                                const decrypted = await CryptoUtil.decrypt(encRecords.substring(4), pin);
                                                                                localStorage.setItem('ArthikaX_records', JSON.stringify(decrypted));
                                                                            }

                                                                            // Decrypt profiles
                                                                            const encProfiles = localStorage.getItem('ArthikaX_profiles');
                                                                            if (encProfiles && encProfiles.startsWith('ENC:')) {
                                                                                const decrypted = await CryptoUtil.decrypt(encProfiles.substring(4), pin);
                                                                                localStorage.setItem('ArthikaX_profiles', JSON.stringify(decrypted));
                                                                            }
                                                                        },

                                                                        async encryptAllData(pin) {
                                                                            // Encrypt records
                                                                            const records = localStorage.getItem('ArthikaX_records');
                                                                            if (records && !records.startsWith('ENC:')) {
                                                                                const encrypted = await CryptoUtil.encrypt(JSON.parse(records), pin);
                                                                                localStorage.setItem('ArthikaX_records', 'ENC:' + encrypted);
                                                                            }

                                                                            // Encrypt profiles
                                                                            const profiles = localStorage.getItem('ArthikaX_profiles');
                                                                            if (profiles && !profiles.startsWith('ENC:')) {
                                                                                const encrypted = await CryptoUtil.encrypt(JSON.parse(profiles), pin);
                                                                                localStorage.setItem('ArthikaX_profiles', 'ENC:' + encrypted);
                                                                            }
                                                                        }
                                                                    };

                                                                    // Override app methods to handle encryption
                                                                    const originalLoadRecords = app.loadRecords;
                                                                    app.loadRecords = async function () {
                                                                        const stored = localStorage.getItem('ArthikaX_records');
                                                                        if (stored && stored.startsWith('ENC:')) {
                                                                            // Data is encrypted, will be decrypted on unlock
                                                                            this.state.records = []; // Empty until unlocked
                                                                        } else if (stored) {
                                                                            this.state.records = JSON.parse(stored);
                                                                        }
                                                                    };

                                                                    const originalSaveProfiles = app.saveProfiles;
                                                                    app.saveProfiles = async function () {
                                                                        localStorage.setItem('ArthikaX_profiles', JSON.stringify(this.state.profiles));
                                                                        localStorage.setItem('ArthikaX_currentProfileId', this.state.currentProfileId);

                                                                        // If PIN is set and we have currentPin in session, encrypt
                                                                        if (PinLock.hasPin && window.currentPin) {
                                                                            await PinLock.encryptAllData(window.currentPin);
                                                                        }

                                                                        this.renderProfileList();
                                                                        this.updateHeaderProfileDisplay();
                                                                    };

                                                                    // Modify init to include PIN lock
                                                                    const originalInit = app.init;
                                                                    app.init = async function () {
                                                                        // Check if PIN is set
                                                                        const hasPin = localStorage.getItem('ArthikaX_pinHash');

                                                                        if (hasPin) {
                                                                            // PIN is set - show lock screen
                                                                            PinLock.init();
                                                                            this.loadSettings();
                                                                        } else {
                                                                            // No PIN - start app directly (no lock, no setup)
                                                                            this.fullInit();
                                                                        }
                                                                    };

                                                                    app.fullInit = function () {
                                                                        this.loadSettings();
                                                                        this.loadProfiles();
                                                                        this.setupDropdown();
                                                                        this.setupSettingsDropdown();
                                                                        this.loadRecords();
                                                                        this.cleanupOldRecords();
                                                                        this.migrateRecordsToProfile();

                                                                        const savedCountryName = localStorage.getItem('ArthikaX_lastCountry');
                                                                        if (savedCountryName) {
                                                                            const savedCountry = this.state.config.find(c => c.name === savedCountryName);
                                                                            if (savedCountry) {
                                                                                this.selectCountry(savedCountry);
                                                                            }
                                                                        }

                                                                        this.updateDashboard();
                                                                        this.updateHeaderProfileDisplay();
                                                                        this.renderProfileList();

                                                                        const now = new Date();
                                                                        document.getElementById('entryDate').valueAsDate = now;
                                                                        document.getElementById('entryTime').value = now.toTimeString().substring(0, 5);

                                                                        const todayStr = now.toISOString().split('T')[0];
                                                                        document.getElementById('entryDate').max = todayStr;
                                                                        document.getElementById('filterDate').max = todayStr;
                                                                        document.getElementById('rangeStart').max = todayStr;
                                                                        document.getElementById('rangeEnd').max = todayStr;

                                                                        document.getElementById('settingsBtn').addEventListener('click', () => this.toggleModal('settingsModal'));

                                                                        window.addEventListener('click', (e) => {
                                                                            if (!e.target.closest('.menu-container')) this.closeAllMenus();
                                                                            if (e.target.classList.contains('modal')) e.target.classList.remove('open');
                                                                        });

                                                                        this.switchTab('home');
                                                                    };

                                                                    // Add security section to settings
                                                                    const originalToggleModal = app.toggleModal;
                                                                    app.toggleModal = function (id) {
                                                                        if (id === 'settingsModal') {
                                                                            // Add security section if not exists
                                                                            setTimeout(() => {
                                                                                if (!document.getElementById('securitySettingsSection')) {
                                                                                    const settingsContent = document.querySelector('#settingsModal .modal-content');
                                                                                    const securitySection = document.createElement('div');
                                                                                    securitySection.id = 'securitySettingsSection';
                                                                                    securitySection.className = 'card';
                                                                                    securitySection.style.cssText = 'margin-top: 1rem; border: 2px solid var(--primary); background: rgba(243, 108, 33, 0.05);';

                                                                                    const hasPin = !!localStorage.getItem('ArthikaX_pinHash');

                                                                                    securitySection.innerHTML = `
                            <label style="font-weight: 700; color: var(--primary); margin-bottom: 10px; display: block;"> Security Settings</label>
                            <div style="margin-bottom: 10px;">
                                <p style="font-size: 0.85rem; margin: 0 0 10px 0;">
                                    Status: <strong>${hasPin ? ' PIN Protected' : ' No PIN'}</strong>
                                </p>
                                ${hasPin ?
                                                                                            `<button class="btn btn-primary btn-sm" onclick="PinLock.showChangePinModal()">Change / Remove PIN</button>` :
                                                                                            `<button class="btn btn-primary btn-sm" onclick="PinLock.showSetupPin()">Set PIN</button>`
                                                                                        }
                            </div>
                            <div style="background: #fff3e0; padding: 10px; border-radius: 4px; font-size: 0.75rem; color: #e65100;">
                                <strong>Warning:</strong><br>
                                If you forget your PIN, all data will be permanently lost. No reset option.<br>
                                <strong> Please write down your PIN somewhere safe.</strong><br>
                                Use PIN hint to help remember your PIN.
                            </div>
                        `;

                                                                                    // Insert before credits
                                                                                    const credits = settingsContent.querySelector('.credits-container');
                                                                                    if (credits) {
                                                                                        credits.parentNode.insertBefore(securitySection, credits);
                                                                                    } else {
                                                                                        settingsContent.appendChild(securitySection);
                                                                                    }
                                                                                }
                                                                            }, 100);
                                                                        }
                                                                        originalToggleModal.call(this, id);
                                                                    };
                                                                </script>

                                                                <!-- Hidden SEO Content for Search Engines -->
                                                                <div style="display: none; visibility: hidden; position: absolute; left: -9999px;"
                                                                    aria-hidden="true">
                                                                    <h1>Best Khata Book App 2025 - Digital Udhar Bahi
                                                                        Khata</h1>
                                                                    <h2>Free Offline Business Ledger & Credit Debit Book
                                                                    </h2>
                                                                    <p>ArthikaX is the top rated <strong>digital khata
                                                                            book</strong> app for small business owners
                                                                        and shopkeepers.
                                                                        Maintain your <strong>udhar bahi</strong>
                                                                        electronically without internet. Best
                                                                        <strong>credit debit
                                                                            book</strong>
                                                                        application with party ledger management, daily
                                                                        cash book, money manager, and business
                                                                        calculator.
                                                                        Download free <strong>bahi khata</strong> app
                                                                        for android and ios. Manage len den hisab, dukan
                                                                        ka hisab,
                                                                        and vyapar accounting easily. Supports multiple
                                                                        profiles, 50+ currencies, PDF export and PIN
                                                                        security.
                                                                        Alternative to traditional accounting software
                                                                        for small businesses in India, Bangladesh, and
                                                                        worldwide.</p>
                                                                    <ul>
                                                                        <li>Best Khata Book App for Shopkeepers</li>
                                                                        <li>Udhar Bahi Khata Online</li>
                                                                        <li>Digital Ledger Book App</li>
                                                                        <li>Credit Debit Khata Management</li>
                                                                        <li>Daily Cash Collection App</li>
                                                                        <li>Business Money Manager</li>
                                                                        <li>Bill Book & Invoice Generator</li>
                                                                        <li>Party Account Ledger</li>
                                                                        <li>Offline Hisab Kitab</li>
                                                                        <li>Rokad Bahi Book</li>
                                                                    </ul>
                                                                </div>

                                                                <!-- User Guide Function -->
                                                                <script>
                                                                    function showUserGuide() {
                                                                        const guideHtml = `
            <div id="userGuideModal" class="modal open" style="z-index: 11000;">
                <div class="modal-content" style="max-width: 600px; max-height: 85vh; padding: 0; overflow: hidden;">
                    <div style="background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
                        <h2 style="margin: 0; font-size: 1.2rem;"> User Guide</h2>
                        <button onclick="document.getElementById('userGuideModal').remove()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <div style="padding: 1.2rem; overflow-y: auto; max-height: calc(85vh - 60px); line-height: 1.6; font-size: 0.95rem;">

                        <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #2196f3;">
                            <p style="margin: 0; color: #1565c0; font-size: 0.9rem;">
                                Welcome to ArthikaX - Your Digital Khata Book. This guide works on all devices (Mobile, Tablet, Desktop).
                            </p>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Getting Started</h3>
                            <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.5rem;"><strong>First Time:</strong> Set a PIN for security (optional) or click "Skip for Now"</li>
                                <li style="margin-bottom: 0.5rem;"><strong>Select Country:</strong> Choose your currency from the dropdown</li>
                                <li><strong>Create Profile:</strong> Go to Settings to add your business name</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Adding a Transaction</h3>
                            <ol style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.5rem;">Go to <strong>Entry</strong> tab</li>
                                <li style="margin-bottom: 0.5rem;">Select date, time, and customer name</li>
                                <li style="margin-bottom: 0.5rem;">Add mobile number (optional)</li>
                                <li style="margin-bottom: 0.5rem;">Count cash using <strong>Denomination Counter</strong></li>
                                <li style="margin-bottom: 0.5rem;">Select <strong>Paid</strong> (cleared) or <strong>Due</strong> (outstanding)</li>
                                <li>Click <strong>Save Record</strong></li>
                            </ol>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Understanding Dashboard</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                                <div style="background: var(--bg-income); padding: 0.5rem; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.8rem; color: var(--text-income); font-weight: 600;">Income</div>
                                    <div style="font-size: 0.75rem; color: var(--neutral);">Money Received</div>
                                </div>
                                <div style="background: var(--bg-expense); padding: 0.5rem; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.8rem; color: var(--text-expense); font-weight: 600;">Expense</div>
                                    <div style="font-size: 0.75rem; color: var(--neutral);">Money Paid</div>
                                </div>
                                <div style="background: var(--bg-balance); padding: 0.5rem; border-radius: 6px; text-align: center; grid-column: 1 / -1;">
                                    <div style="font-size: 0.8rem; color: var(--text-balance); font-weight: 600;">Balance</div>
                                    <div style="font-size: 0.75rem; color: var(--neutral);">Income - Expense</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Outstanding/Dues</h3>
                            <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Track unpaid amounts:</p>
                            <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.3rem;"><strong>To Receive:</strong> Customers owe you (Receivable)</li>
                                <li style="margin-bottom: 0.3rem;"><strong>To Pay:</strong> You owe suppliers (Payable)</li>
                                <li>Click <strong>Mark Paid</strong> when dues are cleared</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Party Ledger</h3>
                            <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">View complete history of any customer:</p>
                            <ol style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.3rem;">Go to <strong>Ledger</strong> tab</li>
                                <li style="margin-bottom: 0.3rem;">Type customer name</li>
                                <li style="margin-bottom: 0.3rem;">See Total Received, Total Paid, and Net Balance</li>
                                <li>View all past transactions</li>
                            </ol>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Reports & Export</h3>
                            <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.3rem;"><strong>Download Invoice:</strong> Click  on any transaction in History</li>
                                <li style="margin-bottom: 0.3rem;"><strong>Export 30 Days:</strong> Go to History tab  Click "Export (30 Days)"</li>
                                <li><strong>Custom Range:</strong> Click "Date Range" and select dates</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Today's Hub - Quick Cash Entry</h3>
                            <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Fast cash counting for daily closing:</p>
                            <ol style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.3rem;">Go to <strong>Today's Hub</strong> tab</li>
                                <li style="margin-bottom: 0.3rem;">See today's Income, Receivable, and Payable summary</li>
                                <li style="margin-bottom: 0.3rem;">Click <strong>"+ Add Cash"</strong> to count denomination</li>
                                <li style="margin-bottom: 0.3rem;">Enter note counts (500, 200, 100, etc.)</li>
                                <li style="margin-bottom: 0.3rem;">Auto-calculates total amount</li>
                                <li>Collections are <strong>sorted by amount</strong> (highest first)</li>
                            </ol>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Filter History by Source</h3>
                            <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Separate Regular Entries from Daily Collections:</p>
                            <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.3rem;">Go to <strong>History</strong> tab</li>
                                <li style="margin-bottom: 0.3rem;"><strong>Filter By Source</strong> dropdown has 3 options:</li>
                                <ul style="padding-left: 1rem; margin-top: 0.2rem;">
                                    <li style="margin-bottom: 0.2rem;"> <strong>All Records</strong> - Show everything</li>
                                    <li style="margin-bottom: 0.2rem;"> <strong>Regular Entries Only</strong> - Customer transactions</li>
                                    <li style="margin-bottom: 0.2rem;"> <strong>Daily Collections Only</strong> - Today's Hub entries</li>
                                </ul>
                                <li style="margin-top: 0.3rem;">Export (PDF) will respect this filter</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Download Invoices & Cash Slips</h3>
                            <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Two download formats based on entry type:</p>
                            <div style="background: #e3f2fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p style="margin: 0 0 0.3rem 0; font-size: 0.85rem; color: #1565c0;"><strong> Regular Entry  Invoice</strong></p>
                                <p style="margin: 0; font-size: 0.8rem; color: #1976d2;">Shows customer name, mobile, items, and bill details</p>
                            </div>
                            <div style="background: #fff3e0; padding: 0.8rem; border-radius: 6px;">
                                <p style="margin: 0 0 0.3rem 0; font-size: 0.85rem; color: #e65100;"><strong> Daily Collection  Cash Slip</strong></p>
                                <p style="margin: 0; font-size: 0.8rem; color: #f57c00;">Shows denomination breakdown (5002, 2005, etc.)</p>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Security (PIN)</h3>
                            <div style="background: #fff3e0; padding: 0.8rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p style="margin: 0; font-size: 0.85rem; color: #e65100;">
                                    <strong>Important:</strong> Write down your PIN somewhere safe. If forgotten, data cannot be recovered.
                                </p>
                            </div>
                            <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.3rem;"><strong>Set PIN:</strong> Settings  Security  Set PIN</li>
                                <li style="margin-bottom: 0.3rem;"><strong>Remove PIN:</strong> Settings  Security  Remove PIN</li>
                                <li><strong>Hint:</strong> Add a hint when setting PIN to help remember</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Settings</h3>
                            <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.3rem;"><strong>Theme:</strong> Light/Dark mode</li>
                                <li style="margin-bottom: 0.3rem;"><strong>Color:</strong> Change app theme color</li>
                                <li style="margin-bottom: 0.3rem;"><strong>Multi-Profile:</strong> Manage multiple shops</li>
                                <li style="margin-bottom: 0.3rem;"><strong>Auto-Delete:</strong> Remove records older than 90 days</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Pro Tips</h3>
                            <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.3rem;">Use <strong>Tags</strong> (like "Rent", "Salary") to categorize entries</li>
                                <li style="margin-bottom: 0.3rem;">Add <strong>Remarks</strong> for better context</li>
                                <li style="margin-bottom: 0.3rem;">Check <strong>Outstanding</strong> weekly to track dues</li>
                                <li>Export reports monthly for backup</li>
                            </ul>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;"> Data Storage & Backup</h3>

                            <div style="background: #e3f2fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 0.8rem;">
                                <p style="margin: 0; font-size: 0.85rem; color: #1565c0;">
                                    <strong>Where is my data stored?</strong><br>
                                    All data is stored <strong>locally on your device</strong> using browser storage. 
                                    No data is sent to any server - 100% private and offline.
                                </p>
                            </div>

                            <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem; font-weight: 600;">What happens when I clear browser data?</p>

                            <div style="display: grid; gap: 0.3rem; margin-bottom: 0.8rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: var(--bg-income); border-radius: 4px; font-size: 0.85rem;">
                                    <span>Refresh page (F5)</span>
                                    <span style="color: var(--text-income); font-weight: 600;"> Data Safe</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: var(--bg-income); border-radius: 4px; font-size: 0.85rem;">
                                    <span>Update app file</span>
                                    <span style="color: var(--text-income); font-weight: 600;"> Data Safe</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: var(--bg-balance); border-radius: 4px; font-size: 0.85rem;">
                                    <span>Clear cache only</span>
                                    <span style="color: var(--text-balance); font-weight: 600;"> Data Safe</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: var(--bg-expense); border-radius: 4px; font-size: 0.85rem;">
                                    <span>Clear cookies/site data</span>
                                    <span style="color: var(--text-expense); font-weight: 600;"> Data Lost</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: var(--bg-expense); border-radius: 4px; font-size: 0.85rem;">
                                    <span>Incognito/Private mode</span>
                                    <span style="color: var(--text-expense); font-weight: 600;"> Data Lost</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: var(--bg-expense); border-radius: 4px; font-size: 0.85rem;">
                                    <span>New device/browser</span>
                                    <span style="color: var(--text-expense); font-weight: 600;"> Data Lost</span>
                                </div>
                            </div>

                            <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem; font-weight: 600;">How to backup your data:</p>
                            <ol style="margin: 0 0 0.8rem 0; padding-left: 1.2rem; color: var(--text-color); font-size: 0.85rem;">
                                <li style="margin-bottom: 0.3rem;">Go to <strong>History</strong> tab</li>
                                <li style="margin-bottom: 0.3rem;">Click <strong>"Export (30 Days)"</strong> or <strong>"Date Range"</strong></li>
                                <li style="margin-bottom: 0.3rem;">Download PDF report to your device</li>
                                <li style="margin-bottom: 0.3rem;">Save to Google Drive, Email, or USB</li>
                                <li><strong>Do this monthly</strong> to prevent data loss</li>
                            </ol>

                            <div style="background: #fff3e0; padding: 0.8rem; border-radius: 6px; border-left: 4px solid #ff9800;">
                                <p style="margin: 0; font-size: 0.85rem; color: #e65100;">
                                    <strong> Warning:</strong> If you forget your PIN, data is permanently lost. 
                                    Clearing browser "Cookies and Site Data" will delete all records. 
                                    Use normal browser mode (not Incognito) for permanent storage.
                                </p>
                            </div>
                        </div>

                        <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; border-left: 4px solid #4caf50;">
                            <h4 style="color: #2e7d32; margin: 0 0 0.5rem 0; font-size: 1rem;"> Need Help?</h4>
                            <p style="margin: 0 0 0.5rem 0; font-size: 0.85rem; color: #1b5e20;">
                                 <strong>Email:</strong> easyassistance@zohomail.in<br>
                                 <strong>Website:</strong> arthixa.com
                            </p>
                            <p style="margin: 0; font-size: 0.8rem; color: #2e7d32;">
                                This app works offline. Your data is stored locally on your device.<br>
                                For technical support, feature requests, or feedback - please email us.<br>
                                We typically respond within 24-48 hours.
                            </p>
                        </div>

                    </div>
                    <div style="padding: 1rem; border-top: 1px solid var(--border); text-align: center; position: sticky; bottom: 0; background: var(--card-bg);">
                        <button onclick="document.getElementById('userGuideModal').remove()" class="btn btn-primary" style="max-width: 200px;">Got It</button>
                    </div>
                </div>
            </div>
        `;
                                                                        document.body.insertAdjacentHTML('beforeend', guideHtml);
                                                                    }
                                                                </script>

                                                                <!-- Footer Navigation -->
                                                                <footer
                                                                    style="background: var(--card-bg); border-top: 1px solid var(--border); padding: 1rem; text-align: center; font-size: 0.85rem; color: var(--neutral); margin-top: 2rem;">
                                                                    <div style="max-width: 600px; margin: 0 auto;">
                                                                        <p
                                                                            style="margin: 0 0 0.5rem 0; color: var(--text-color); font-weight: 500;">
                                                                            ArthikaX - Free Offline Digital
                                                                            Khata Book</p>
                                                                        <p
                                                                            style="margin: 0 0 0.8rem 0; font-size: 0.8rem;">
                                                                            &copy; <span
                                                                                id="footerCopyrightYear"></span>
                                                                            Arthixa. All rights reserved. | Version
                                                                            2.4.0
                                                                        </p>
                                                                        <div
                                                                            style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.8rem;">
                                                                            <a href="privacy-policy.html"
                                                                                target="_blank"
                                                                                style="color: var(--primary); text-decoration: none; font-weight: 500;">Privacy
                                                                                Policy</a>
                                                                            <span style="color: var(--border);"></span>
                                                                            <a href="terms-of-service.html"
                                                                                target="_blank"
                                                                                style="color: var(--primary); text-decoration: none; font-weight: 500;">Terms
                                                                                of Service</a>
                                                                            <span style="color: var(--border);"></span>
                                                                            <a href="about.html" target="_blank"
                                                                                style="color: var(--primary); text-decoration: none; font-weight: 500;">About
                                                                                Us</a>
                                                                            <span style="color: var(--border);"></span>
                                                                            <a href="contact.html" target="_blank"
                                                                                style="color: var(--primary); text-decoration: none; font-weight: 500;">Contact</a>
                                                                        </div>
                                                                    </div>
                                                                </footer>

                                                                <script>
                                                                    // Auto-update copyright year
                                                                    document.getElementById('footerCopyrightYear').textContent = new Date().getFullYear();

                                                                    // Handle Back Button for Legal Modal
                                                                    window.addEventListener('popstate', (event) => {
                                                                        const modal = document.getElementById('legalModal');
                                                                        if (modal && modal.style.display === 'block') {
                                                                            app.closeLegal();
                                                                        }
                                                                    });

                                                                    // =========================================
                                                                    // SERVICE WORKER REGISTRATION - PWA Support
                                                                    // =========================================
                                                                    if ('serviceWorker' in navigator) {
                                                                        window.addEventListener('load', () => {
                                                                            navigator.serviceWorker.register('./sw.js')
                                                                                .then((registration) => {
                                                                                    console.log(' Service Worker registered successfully:', registration.scope);

                                                                                    // Check for updates every hour
                                                                                    setInterval(() => {
                                                                                        registration.update();
                                                                                    }, 3600000); // 1 hour

                                                                                    // Listen for service worker updates
                                                                                    registration.addEventListener('updatefound', () => {
                                                                                        const newWorker = registration.installing;
                                                                                        newWorker.addEventListener('statechange', () => {
                                                                                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                                                                                // New service worker available
                                                                                                if (confirm('New version available! Reload to update?')) {
                                                                                                    window.location.reload();
                                                                                                }
                                                                                            }
                                                                                        });
                                                                                    });
                                                                                })
                                                                                .catch((error) => {
                                                                                    console.warn(' Service Worker registration failed:', error);
                                                                                });
                                                                        });
                                                                    }

                                                                    // =========================================
                                                                    // PWA INSTALL PROMPT - Cross-Platform Support
                                                                    // =========================================
                                                                    let deferredPrompt;
                                                                    const pwaInstallBanner = document.getElementById('pwa-install-banner');

                                                                    // Listen for beforeinstallprompt event (Android, Desktop Chrome)
                                                                    window.addEventListener('beforeinstallprompt', (e) => {
                                                                        // Prevent the default mini-infobar
                                                                        e.preventDefault();
                                                                        // Store the event for later use
                                                                        deferredPrompt = e;

                                                                        // Show custom install banner
                                                                        if (pwaInstallBanner) {
                                                                            pwaInstallBanner.style.display = 'flex';
                                                                        }
                                                                    });

                                                                    // Handle install button click
                                                                    window.installPWA = async function () {
                                                                        if (!deferredPrompt) {
                                                                            // For iOS or browsers that don't support beforeinstallprompt
                                                                            alert('To install this app:\n\n iOS: Tap Share  Add to Home Screen\n Desktop: Look for install icon in address bar\n Android: Tap "Add to Home Screen" in menu');
                                                                            return;
                                                                        }

                                                                        // Show the install prompt
                                                                        deferredPrompt.prompt();

                                                                        // Wait for user choice
                                                                        const { outcome } = await deferredPrompt.userChoice;

                                                                        if (outcome === 'accepted') {
                                                                            console.log(' PWA installed successfully');
                                                                            app.toast('App installed successfully! ');
                                                                        } else {
                                                                            console.log(' PWA installation dismissed');
                                                                        }

                                                                        // Clear the deferredPrompt
                                                                        deferredPrompt = null;

                                                                        // Hide banner
                                                                        if (pwaInstallBanner) {
                                                                            pwaInstallBanner.style.display = 'none';
                                                                        }
                                                                    };

                                                                    // Close PWA banner
                                                                    window.closePWABanner = function () {
                                                                        if (pwaInstallBanner) {
                                                                            pwaInstallBanner.style.display = 'none';
                                                                            // Remember user preference (don't show again for 7 days)
                                                                            localStorage.setItem('pwa_banner_dismissed', Date.now());
                                                                        }
                                                                    };

                                                                    // Check if banner should be shown (not dismissed recently)
                                                                    window.addEventListener('load', () => {
                                                                        const dismissed = localStorage.getItem('pwa_banner_dismissed');
                                                                        const sevenDays = 7 * 24 * 60 * 60 * 1000;

                                                                        if (dismissed && (Date.now() - parseInt(dismissed)) < sevenDays) {
                                                                            // Banner was dismissed recently, don't show it
                                                                            if (pwaInstallBanner) {
                                                                                pwaInstallBanner.style.display = 'none';
                                                                            }
                                                                        }
                                                                    });

                                                                    // Detect if app is already installed (standalone mode)
                                                                    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                                                                        // App is installed and running as PWA
                                                                        console.log(' Running as installed PWA');
                                                                        if (pwaInstallBanner) {
                                                                            pwaInstallBanner.style.display = 'none';
                                                                        }
                                                                    }

                                                                    // iOS specific detection
                                                                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                                                                    const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);

                                                                    if (isIOS && !isInStandaloneMode && pwaInstallBanner) {
                                                                        // Show custom iOS install instructions
                                                                        const pwaDesc = pwaInstallBanner.querySelector('.pwa-desc');
                                                                        if (pwaDesc) {
                                                                            pwaDesc.textContent = 'Tap Share  Add to Home Screen to install';
                                                                        }
                                                                    }

                                                                    // =========================================
                                                                    // OFFLINE DETECTION
                                                                    // =========================================
                                                                    window.addEventListener('online', () => {
                                                                        app.toast(' You are back online!');
                                                                    });

                                                                    window.addEventListener('offline', () => {
                                                                        app.toast(' You are offline. App will work from cache.');
                                                                    });

                                                                    // =========================================
                                                                    // PERFORMANCE MONITORING
                                                                    // =========================================
                                                                    window.addEventListener('load', () => {
                                                                        // Log performance metrics
                                                                        if (window.performance && window.performance.timing) {
                                                                            const perfData = window.performance.timing;
                                                                            const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
                                                                            console.log(` Page loaded in ${pageLoadTime}ms`);
                                                                        }
                                                                    });
                                                                </script>
                                                                <!-- Toast Notification Container -->
                                                                <div id="toast"></div>
                                                                <style>
                                                                    #toast {
                                                                        visibility: hidden;
                                                                        min-width: 250px;
                                                                        background-color: var(--secondary);
                                                                        color: #fff;
                                                                        text-align: center;
                                                                        border-radius: 8px;
                                                                        padding: 16px;
                                                                        position: fixed;
                                                                        z-index: 9999;
                                                                        left: 50%;
                                                                        transform: translateX(-50%);
                                                                        bottom: 30px;
                                                                        font-size: 1rem;
                                                                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                                                                        border: 1px solid var(--border);
                                                                    }

                                                                    #toast.show {
                                                                        visibility: visible;
                                                                        animation: fadein 0.5s, fadeout 0.5s 2.5s;
                                                                    }

                                                                    @keyframes fadein {
                                                                        from {
                                                                            bottom: 0;
                                                                            opacity: 0;
                                                                        }

                                                                        to {
                                                                            bottom: 30px;
                                                                            opacity: 1;
                                                                        }
                                                                    }

                                                                    @keyframes fadeout {
                                                                        from {
                                                                            bottom: 30px;
                                                                            opacity: 1;
                                                                        }

                                                                        to {
                                                                            bottom: 0;
                                                                            opacity: 0;
                                                                        }
                                                                    }
                                                                </style>
</body>

</html>
